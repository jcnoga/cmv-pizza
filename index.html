<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pizzaria Cost Control Pro - Gest√£o Completa</title>

    <style>
        :root {
            --primary-color: #D32F2F; --primary-dark: #B71C1C; --secondary-color: #FFC107;
            --light-gray: #f4f4f4; --medium-gray: #ccc; --dark-gray: #555;
            --text-color: #333; --white: #fff; --success-color: #4CAF50;
            --error-color: #f44336; --info-color: #2196F3; --shadow: 0 2px 8px rgba(0,0,0,0.1);
            --border-radius: 8px;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: var(--light-gray); color: var(--text-color); line-height: 1.6; display: flex; flex-direction: column; min-height: 100vh; }
        header { background-color: var(--primary-color); color: var(--white); padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; box-shadow: var(--shadow); flex-wrap: wrap; }
        header h1 { font-size: 1.5rem; margin-right: 2rem; }
        #auth-container, #app-container { width: 100%; max-width: 1200px; margin: 2rem auto; padding: 0 1rem; }
        .auth-form { background: var(--white); padding: 2.5rem; border-radius: var(--border-radius); box-shadow: var(--shadow); max-width: 450px; margin: 2rem auto; }
        .auth-form h2 { text-align: center; margin-bottom: 1.5rem; color: var(--primary-dark); }
        .form-group { margin-bottom: 1.25rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 600; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 0.75rem; border: 1px solid var(--medium-gray); border-radius: var(--border-radius); font-size: 1rem; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 2px rgba(211, 47, 47, 0.2); }
        .form-group input:disabled { background-color: #eee; color: #888; cursor: not-allowed; }
        .btn { display: inline-block; padding: 0.8rem 1.5rem; font-size: 1rem; font-weight: 600; text-align: center; border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.3s, transform 0.1s; width: 100%; }
        .btn:disabled { background-color: var(--medium-gray); cursor: not-allowed; }
        .btn:active:not(:disabled) { transform: scale(0.98); }
        .btn-primary { background-color: var(--primary-color); color: var(--white); } .btn-primary:hover:not(:disabled) { background-color: var(--primary-dark); }
        .btn-secondary { background-color: var(--dark-gray); color: var(--white); } .btn-secondary:hover { background-color: #333; }
        .btn-success { background-color: var(--success-color); color: var(--white); }
        .btn-danger { background-color: var(--error-color); color: var(--white); }
        .btn-info { background-color: var(--info-color); color: var(--white); }
        .btn-warning { background-color: #ff9800; color: var(--white); }
        .btn-small { padding: 0.4rem 0.8rem; font-size: 0.85rem; width: auto; }
        .auth-link { text-align: center; margin-top: 1rem; } .auth-link a { color: var(--primary-color); text-decoration: none; font-weight: 600; }
        nav { display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap; margin-top: 10px; }
        nav a, nav button { color: var(--white); text-decoration: none; background: none; border: none; cursor: pointer; font-size: 0.95rem; padding: 0.5rem 1rem; border-radius: var(--border-radius); transition: background-color 0.2s; }
        nav a:hover, nav button:hover, nav a.active { background-color: rgba(255,255,255,0.2); }
        #logout-button { background-color: var(--secondary-color); color: var(--text-color); font-weight: bold; }
        main { flex: 1; }
        .view { display: none; } .view.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .card { background: var(--white); padding: 1.5rem; border-radius: var(--border-radius); box-shadow: var(--shadow); margin-bottom: 1.5rem; }
        .grid-container { display: grid; gap: 1.5rem; }
        @media (min-width: 768px) { .grid-2 { grid-template-columns: repeat(2, 1fr); } .grid-3 { grid-template-columns: repeat(3, 1fr); } .grid-4 { grid-template-columns: repeat(4, 1fr); } }
        .kpi-card { text-align: center; }
        .kpi-card h3 { color: var(--dark-gray); font-size: 1rem; margin-bottom: 0.5rem; }
        .kpi-card .value { font-size: 2rem; font-weight: 700; color: var(--primary-dark); }
        h2 { margin-bottom: 1rem; color: var(--primary-dark); border-bottom: 2px solid var(--light-gray); padding-bottom: 0.5rem; }
        table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        th, td { padding: 0.75rem; text-align: left; border-bottom: 1px solid var(--medium-gray); }
        th { background-color: var(--light-gray); font-weight: 600; }
        tr:hover { background-color: #f9f9f9; }
        .actions-cell { text-align: right; white-space: nowrap; }
        .actions-cell .btn { margin-left: 0.5rem; }
        .form-row { display: flex; gap: 1rem; flex-wrap: wrap; }
        .form-row .form-group { flex: 1; min-width: 150px; }
        #ingredients-list .ingredient-row, #sales-list .sale-row { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; padding-bottom: 0.5rem; border-bottom: 1px dashed var(--medium-gray); }
        #ingredients-list .ingredient-row > *, #sales-list .sale-row > * { flex: 1; }
        .total-cost { text-align: right; font-size: 1.5rem; font-weight: bold; margin-top: 1rem; color: var(--primary-dark); }
        .simulator-result { margin-top: 1rem; padding: 1rem; background-color: #e8f5e9; border-left: 5px solid var(--success-color); border-radius: var(--border-radius); }
        .simulator-result p { font-size: 1.2rem; margin-bottom: 0.5rem; } .simulator-result strong { color: var(--primary-dark); }
        .alert-item { padding: 0.75rem; border-radius: var(--border-radius); margin-bottom: 0.5rem; background-color: #fff3e0; border: 1px solid #ffe0b2; color: #e65100; }
        .cmv-ok { color: var(--success-color); } .cmv-warn { color: #f57c00; } .cmv-danger { color: var(--error-color); }
        .cmv-visualizer { width: 100%; background-color: var(--medium-gray); border-radius: var(--border-radius); height: 25px; overflow: hidden; margin-top: 0.5rem; }
        .cmv-visualizer-bar { height: 100%; transition: width 0.5s; }
        .cmv-visualizer-bar.ok { background-color: var(--success-color); } .cmv-visualizer-bar.warn { background-color: var(--secondary-color); } .cmv-visualizer-bar.danger { background-color: var(--error-color); }
        .filter-container { margin-bottom: 1rem; display: flex; gap: 1rem; align-items: center; flex-wrap: wrap; }
        .filter-container input { padding: 0.5rem; border-radius: var(--border-radius); border: 1px solid var(--medium-gray); width: 100%; max-width: 400px; }
        .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); padding: 1rem 2rem; border-radius: var(--border-radius); color: var(--white); z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.5s, visibility 0.5s; }
        .toast.show { opacity: 1; visibility: visible; }
        .toast.success { background-color: var(--success-color); } .toast.error { background-color: var(--error-color); }
        footer { text-align: center; padding: 1.5rem; margin-top: 2rem; background-color: #e0e0e0; color: var(--dark-gray); font-size: 0.9rem; }
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: #fefefe; margin: 10% auto; padding: 20px; border: 1px solid #888; width: 90%; max-width: 600px; border-radius: var(--border-radius); }
        .modal-buttons { margin-top: 20px; text-align: center; } .modal-buttons .btn { width: 120px; margin: 0 10px; }
        .hidden { display: none; }
        .help-icon { display: inline-block; width: 20px; height: 20px; border-radius: 50%; background-color: var(--info-color); color: white; text-align: center; font-weight: bold; line-height: 20px; cursor: pointer; margin-left: 8px; font-style: normal; user-select: none; }
        .checkbox-wrapper { display: flex; align-items: center; margin-bottom: 1rem; padding: 0.5rem; background: #e3f2fd; border-radius: 4px; }
        .checkbox-wrapper input { width: auto; margin-right: 10px; cursor: pointer; }
        .stock-warning { color: var(--error-color); font-weight: bold; }
        .stock-ok { color: var(--success-color); }
        /* Backup Area */
        .backup-area { border: 2px dashed var(--primary-color); padding: 20px; border-radius: 10px; margin-top: 20px; background-color: #fff3e0; }
        .backup-area h3 { margin-top: 0; }
    </style>
</head>
<body>

    <header>
        <h1>üçï Pizzaria Cost Control Pro</h1>
        <nav id="app-nav" class="hidden">
            <a href="#" class="nav-link" data-view="dashboard">Dashboard</a>
            <a href="#" class="nav-link" data-view="vendas-diarias">Vendas Di√°rias</a>
            <a href="#" class="nav-link" data-view="custos-mensais">Mensal</a>
            <a href="#" class="nav-link" data-view="lista-compras">Lista Compras</a>
            <a href="#" class="nav-link" data-view="produtos">Produtos</a>
            <a href="#" class="nav-link" data-view="insumos">Insumos</a>
            <a href="#" class="nav-link" data-view="receitas">Receitas</a>
            <a href="#" class="nav-link" data-view="fornecedores">Fornecedores</a>
            <a href="#" class="nav-link" data-view="configuracoes">‚öôÔ∏è Config</a>
            <button id="logout-button">Sair</button>
        </nav>
    </header>

    <main>
        <!-- TELAS DE AUTENTICA√á√ÉO -->
        <div id="auth-container">
            <div id="login-view" class="auth-form"><h2>Login</h2><form id="login-form"><div class="form-group"><label for="login-email">Email</label><input type="email" id="login-email" required></div><div class="form-group"><label for="login-password">Senha</label><input type="password" id="login-password" required></div><button type="submit" class="btn btn-primary">Entrar</button></form><div class="auth-link"><p>N√£o tem conta? <a href="#" id="show-register">Cadastre-se</a></p></div></div>
            <div id="register-view" class="auth-form hidden"><h2>Cadastro</h2><form id="register-form"><div class="form-group"><label for="register-email">Email</label><input type="email" id="register-email" required></div><div class="form-group"><label for="register-password">Senha</label><input type="password" id="register-password" required minlength="6"></div><button type="submit" class="btn btn-primary">Cadastrar</button></form><div class="auth-link"><p>J√° tem conta? <a href="#" id="show-login">Fa√ßa login</a></p></div></div>
        </div>

        <!-- √ÅREA DO APLICATIVO -->
        <div id="app-container" class="hidden">
            
            <!-- 1. DASHBOARD -->
            <section id="dashboard-view" class="view">
                <h2>Dashboard</h2>
                <div class="grid-container grid-4">
                    <div class="card kpi-card"><h3>Vendas Hoje</h3><div class="value" id="dash-vendas-hoje">R$ 0,00</div></div>
                    <div class="card kpi-card"><h3>Pizzas Hoje</h3><div class="value" id="dash-pizzas-hoje">0</div></div>
                    <div class="card kpi-card"><h3>Itens de Estoque</h3><div class="value" id="dash-stock-count">0</div></div>
                    <div class="card kpi-card"><h3>Receitas</h3><div class="value" id="dashboard-num-receitas">0</div></div>
                </div>
                <div class="card"><h3>Alertas de Estoque</h3><div id="stock-alerts"><p>Tudo certo com o estoque.</p></div></div>
            </section>

            <!-- 2. VENDAS DI√ÅRIAS -->
            <section id="vendas-diarias-view" class="view">
                <div class="card">
                    <h2>Registrar Vendas do Dia</h2>
                    <div class="form-group"><label>Data do Movimento</label><input type="date" id="venda-data" required></div>
                    <div class="grid-container grid-2">
                        
                        <!-- √ÅREA DA PIZZA -->
                        <div style="background: #fff3e0; padding: 15px; border-radius: 8px;">
                            <h3>üçï Venda de Pizzas</h3>
                            <div class="form-group">
                                <label>Sabor (Receita)</label>
                                <select id="venda-pizza-select"><option value="">Selecione...</option></select>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Qtd</label>
                                    <input type="number" id="venda-pizza-qtd" value="1" min="1">
                                </div>
                                <div class="form-group">
                                    <label>Valor Total (R$)</label>
                                    <input type="number" id="venda-pizza-valor" step="0.01">
                                </div>
                            </div>
                            <button class="btn btn-primary" id="btn-add-pizza-sale">Adicionar Pizza</button>
                        </div>

                        <!-- √ÅREA DO PRODUTO -->
                        <div style="background: #e3f2fd; padding: 15px; border-radius: 8px;">
                            <h3>ü•§ Venda de Produtos (Revenda)</h3>
                            <div class="form-group">
                                <label>Produto</label>
                                <select id="venda-produto-select"><option value="">Selecione...</option></select>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Qtd</label>
                                    <input type="number" id="venda-produto-qtd" value="1" min="1">
                                </div>
                                <div class="form-group">
                                    <label>Valor Total (R$)</label>
                                    <input type="number" id="venda-produto-valor" step="0.01">
                                </div>
                            </div>
                            <button class="btn btn-info" id="btn-add-prod-sale">Adicionar Produto</button>
                        </div>

                    </div>
                    <h3 style="margin-top: 20px;">Itens lan√ßados hoje:</h3>
                    <table id="sales-table"><thead><tr><th>Tipo</th><th>Item</th><th>Qtd</th><th>Valor</th><th>A√ß√£o</th></tr></thead><tbody></tbody></table>
                    <div class="total-cost" id="daily-total-display">Total do Dia: R$ 0,00</div>
                    <button class="btn btn-success" id="btn-save-day" style="margin-top: 15px;">üíæ Salvar Movimento do Dia</button>
                </div>
            </section>

            <!-- 3. MENSAL -->
            <section id="custos-mensais-view" class="view">
                <div class="card">
                    <h2>Fechamento Mensal</h2>
                    <form id="custo-mensal-form"><input type="hidden" id="custo-mensal-id"><div class="form-row"><div class="form-group"><label for="custo-mensal-mes">M√™s/Ano</label><input type="month" id="custo-mensal-mes" required></div><div class="form-group" style="display:flex; align-items:end;"><button type="button" id="btn-pull-daily" class="btn btn-info">üîÑ Puxar do Di√°rio</button></div></div>
                    
                    <!-- CHECKBOX DE EDI√á√ÉO MANUAL -->
                    <div class="checkbox-wrapper"><input type="checkbox" id="enable-manual-edit"><label for="enable-manual-edit"><strong>Habilitar Edi√ß√£o Manual</strong></label></div>
                    
                    <div class="form-row"><div class="form-group"><label>Faturamento (R$)</label><input type="number" id="custo-mensal-faturamento" step="0.01" required disabled></div><div class="form-group"><label>Custos Vari√°veis (R$)</label><input type="number" id="custo-mensal-custosVariaveis" step="0.01" disabled></div></div><div class="form-row"><div class="form-group"><label>Custos Fixos (R$)</label><input type="number" id="custo-mensal-custosFixos" step="0.01" disabled></div><div class="form-group"><label>Desp. Operacionais (R$)</label><input type="number" id="custo-mensal-despesasOperacionais" step="0.01" disabled></div></div><div class="form-row"><div class="form-group"><label>Impostos (R$)</label><input type="number" id="custo-mensal-impostos" step="0.01" disabled></div><div class="form-group"><label>Outras Rec/Desp (R$)</label><input type="number" id="custo-mensal-outrasReceitasDespesas" step="0.01" disabled></div></div><button type="submit" class="btn btn-primary">Salvar M√™s</button></form>
                </div>
                <div class="card"><h2>Hist√≥rico Mensal</h2><table id="custos-mensais-table"><thead><tr><th>M√™s</th><th>Faturamento</th><th>Lucro L√≠quido</th><th>A√ß√µes</th></tr></thead><tbody></tbody></table></div>
            </section>

            <!-- 4. LISTA DE COMPRAS -->
            <section id="lista-compras-view" class="view">
                <div class="card"><h2>üõí Sugest√£o de Compras</h2><div class="filter-container"><button id="btn-generate-shopping" class="btn btn-primary">Gerar Lista Atualizada</button><button id="btn-print-shopping" class="btn btn-secondary">Imprimir PDF</button></div><table id="shopping-list-table"><thead><tr><th>Item</th><th>Tipo</th><th>Estoque Atual</th><th>M√≠nimo</th><th>Ideal</th><th>Comprar</th></tr></thead><tbody></tbody></table></div>
            </section>

            <!-- 5. PRODUTOS (Com Op√ß√£o de Altera√ß√£o) -->
            <section id="produtos-view" class="view">
                <div class="card"><h2>Cadastrar Produto (Revenda)</h2>
                    <form id="produto-form">
                        <input type="hidden" id="produto-id">
                        <div class="form-row">
                            <div class="form-group"><label>Nome</label><input type="text" id="prod-nome" required></div>
                            <div class="form-group"><label>Categoria</label><select id="prod-categoria"><option value="Bebida">Bebida</option><option value="Sobremesa">Sobremesa</option><option value="Outro">Outro</option></select></div>
                        </div>
                        <div class="form-row">
                            <div class="form-group"><label>Fornecedor</label><select id="prod-fornecedor-select"><option value="">Selecione</option></select></div>
                        </div>
                        <div class="form-row">
                            <div class="form-group"><label>Pre√ßo Compra (R$)</label><input type="number" id="prod-custo" step="0.01" required></div>
                            <div class="form-group"><label>Pre√ßo Venda (R$)</label><input type="number" id="prod-venda" step="0.01" required></div>
                            <div class="form-group"><label>Unidade</label><select id="prod-unidade"><option value="un">Unidade</option><option value="lt">Lata</option><option value="gf">Garrafa</option></select></div>
                        </div>
                        <h3>Controle de Estoque</h3>
                        <div class="form-row">
                            <div class="form-group"><label>Atual</label><input type="number" id="prod-est-atual" value="0"></div>
                            <div class="form-group"><label>M√≠nimo</label><input type="number" id="prod-est-min" value="10"></div>
                            <div class="form-group"><label>Ideal</label><input type="number" id="prod-est-ideal" value="50"></div>
                        </div>
                        <button type="submit" class="btn btn-primary">Salvar Produto</button>
                        <button type="button" id="cancel-edit-produto" class="btn btn-secondary hidden" style="margin-top: 0.5rem;">Cancelar Edi√ß√£o</button>
                    </form>
                </div>
                <div class="card"><h2>Lista de Produtos</h2><table id="produtos-table"><thead><tr><th>Nome</th><th>Fornecedor</th><th>Venda</th><th>Estoque</th><th>A√ß√µes</th></tr></thead><tbody></tbody></table></div>
            </section>

            <!-- 6. INSUMOS (Com Op√ß√£o de Altera√ß√£o) -->
            <section id="insumos-view" class="view">
                <div class="card"><h2>Cadastrar Insumo</h2>
                    <form id="insumo-form">
                        <input type="hidden" id="insumo-id">
                        <div class="form-row">
                            <div class="form-group"><label>Nome</label><input type="text" id="insumo-nome" required></div>
                            <div class="form-group"><label>Fornecedor</label><select id="insumo-fornecedor-select" required><option value="">-- Selecione --</option></select></div>
                        </div>
                        <div class="form-row">
                            <div class="form-group"><label>Custo Emb. (R$)</label><input type="number" id="insumo-custo-embalagem" step="0.01" required></div>
                            <div class="form-group"><label>Qtd. Emb.</label><input type="number" id="insumo-qtd-embalagem" step="0.01" required></div>
                            <div class="form-group"><label>Unidade</label><select id="insumo-unidade-embalagem" required><option value="kg">kg</option><option value="g">g</option><option value="L">L</option><option value="ml">ml</option><option value="un">un</option></select></div>
                        </div>
                        <h3 style="margin-top:10px; border-top:1px solid #eee; padding-top:10px;">Controle de Estoque</h3>
                        <div class="form-row">
                            <div class="form-group"><label>Atual</label><input type="number" id="insumo-est-atual" value="0"></div>
                            <div class="form-group"><label>M√≠nimo</label><input type="number" id="insumo-est-min" value="0"></div>
                            <div class="form-group"><label>Ideal</label><input type="number" id="insumo-est-ideal" value="0"></div>
                        </div>
                        <div class="form-row">
                            <div class="form-group"><label>Validade</label><input type="date" id="insumo-validade"></div>
                        </div>
                        <button type="submit" class="btn btn-primary">Salvar Insumo</button>
                        <button type="button" id="cancel-edit-insumo" class="btn btn-secondary hidden" style="margin-top: 0.5rem;">Cancelar Edi√ß√£o</button>
                    </form>
                </div>
                <div class="card"><h2>Insumos</h2><div class="filter-container"><input type="text" id="insumos-filter" placeholder="Filtrar..."></div><table id="insumos-table"><thead><tr><th>Nome</th><th>Custo Base</th><th>Estoque</th><th>A√ß√µes</th></tr></thead><tbody></tbody></table></div>
            </section>

            <!-- 7. RECEITAS (Com C√°lculo Autom√°tico e Pre√ßo de Venda) -->
            <section id="receitas-view" class="view">
                <div class="card"><h2>Criar Receita</h2>
                    <form id="receita-form">
                        <input type="hidden" id="receita-id">
                        <div class="form-row">
                            <div class="form-group"><label>Nome</label><input type="text" id="receita-nome" required></div>
                            <!-- NOVO CAMPO: PRE√áO DE VENDA -->
                            <div class="form-group"><label>Pre√ßo Venda (R$)</label><input type="number" id="receita-venda" step="0.01"></div>
                        </div>
                        <h3>Ingredientes</h3>
                        <div id="ingredients-list"></div>
                        <button type="button" id="add-ingredient-btn" class="btn btn-secondary btn-small">Adicionar Ingrediente</button>
                        <div class="total-cost" id="custo-total-ingredientes">Custo: R$ 0,00</div>
                        <button type="submit" class="btn btn-primary" style="margin-top:10px;">Salvar Receita</button>
                        <button type="button" id="cancel-edit-receita" class="btn btn-secondary hidden">Cancelar Edi√ß√£o</button>
                    </form>
                </div>
                <div class="card"><h2>Receitas</h2><table id="receitas-table"><thead><tr><th>Nome</th><th>Custo (COGS)</th><th>Venda</th><th>A√ß√µes</th></tr></thead><tbody></tbody></table></div>
            </section>

            <!-- 8. FORNECEDORES -->
            <section id="fornecedores-view" class="view">
                <div class="card">
                    <h2 id="fornecedor-form-title">Cadastrar Fornecedor</h2>
                    <form id="fornecedor-form">
                        <input type="hidden" id="fornecedor-id">
                        <div class="form-row">
                            <div class="form-group"><label>Nome da Empresa</label><input type="text" id="fornecedor-nome" required placeholder="Ex: Distribuidora Queijos"></div>
                            <div class="form-group"><label>Pessoa de Contato</label><input type="text" id="fornecedor-contato" placeholder="Ex: Sr. Jo√£o"></div>
                        </div>
                        <div class="form-row">
                            <div class="form-group"><label>Telefone / WhatsApp</label><input type="tel" id="fornecedor-telefone" placeholder="(99) 99999-9999"></div>
                            <div class="form-group"><label>Email</label><input type="email" id="fornecedor-email" placeholder="contato@fornecedor.com"></div>
                        </div>
                        <div class="form-group"><label>Endere√ßo Completo</label><input type="text" id="fornecedor-endereco" placeholder="Rua, N√∫mero, Bairro, Cidade"></div>
                        <button type="submit" class="btn btn-primary">Salvar Fornecedor</button>
                        <button type="button" id="cancel-edit-fornecedor" class="btn btn-secondary hidden" style="margin-top: 0.5rem;">Cancelar Edi√ß√£o</button>
                    </form>
                </div>
                <div class="card"><h2>Lista de Fornecedores</h2><div class="table-container"><table id="fornecedores-table"><thead><tr><th>Empresa</th><th>Contato</th><th>Telefone</th><th>Endere√ßo</th><th class="actions-cell">A√ß√µes</th></tr></thead><tbody></tbody></table></div></div>
                <div class="card" style="margin-top:20px;border:1px solid red;"><h3 style="color:red;">Zona de Perigo</h3><p>Apagar TODOS os fornecedores?</p><button id="btn-zerar-fornecedores" class="btn btn-danger">ZERAR TODOS OS FORNECEDORES</button></div>
            </section>

            <!-- CONFIGURA√á√ïES & BACKUP -->
            <section id="configuracoes-view" class="view">
                <div class="card">
                    <h2>Configura√ß√µes Gerais</h2>
                    <form id="configuracoes-form">
                        <div class="form-group"><label>Custo M√£o de Obra (R$/hora)</label><input type="number" id="config-custo-hora-mao-de-obra" step="0.01"></div>
                        <div class="form-group"><label>Rateio Fixo (R$/pizza)</label><input type="number" id="config-rateio-despesas-fixas" step="0.01"></div>
                        <div class="form-group"><label>Meta CMV Padr√£o (%)</label><input type="number" id="config-meta-cmv-padrao" step="0.1"></div>
                        <div class="form-group"><label>Alerta Varia√ß√£o Pre√ßo (%)</label><input type="number" id="config-alerta-variacao" step="1" value="10"></div>
                        <button type="submit" class="btn btn-primary">Salvar Configura√ß√µes</button>
                    </form>
                </div>
                <div class="card backup-area">
                    <h3>üíæ Backup e Restaura√ß√£o (Seguran√ßa)</h3>
                    <p>Salve seus dados no computador ou restaure um backup. <strong>Cuidado: Restaurar apaga os dados atuais do banco.</strong></p>
                    <div style="display:flex; gap:10px; flex-wrap:wrap;">
                        <button id="btn-backup-download" class="btn btn-info">‚¨áÔ∏è Fazer Backup Completo</button>
                        <button id="btn-backup-restore-click" class="btn btn-warning">‚¨ÜÔ∏è Restaurar Backup</button>
                        <input type="file" id="backup-file-input" accept=".json" class="hidden">
                    </div>
                </div>
            </section>
        </div>
    </main>

    <footer><p>Pizzaria Cost Control Pro v4.2 (Delete/Unique Month Fix)</p></footer>
    <div id="toast" class="toast"></div>
    <div id="confirm-modal" class="modal"><div class="modal-content" style="text-align: center;"><p id="confirm-modal-text">Confirmar?</p><div class="modal-buttons"><button id="confirm-modal-yes" class="btn btn-danger">Sim</button><button id="confirm-modal-no" class="btn btn-secondary">N√£o</button></div></div></div>

    <!-- SCRIPTS -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const firebaseConfig = {
            apiKey: "AIzaSyBDB5DaXGXRWQQKVgG1bh_1WcsbfZti6uo",
            authDomain: "cmv-pizza.firebaseapp.com",
            projectId: "cmv-pizza",
            storageBucket: "cmv-pizza.firebasestorage.app",
            messagingSenderId: "1022435006716",
            appId: "1:1022435006716:web:ec39f22702097beca25f79"
        };

        let firebaseApp, auth, db, currentUser;
        let isLocalMode = false;
        let localData = { fornecedores:[], insumos:[], receitas:[], produtos:[], vendasDiarias:[], custosMensais:[] };
        let cache = { fornecedores:[], insumos:[], receitas:[], produtos:[], vendasDiarias:[], custosMensais:[] };
        let configCache = {};
        let itemParaExcluir = null;
        let dailySalesBuffer = [];
        const COLLECTIONS_LIST = ['fornecedores', 'insumos', 'produtos', 'receitas', 'vendasDiarias', 'custosMensais'];

        if (firebaseConfig.apiKey) {
            try { 
                firebaseApp = firebase.initializeApp(firebaseConfig); 
                auth = firebase.auth(); 
                db = firebase.firestore(); 
                auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
                setupAuthListeners();
            } catch (e) { console.error(e); isLocalMode = true; initApp(); }
        } else { isLocalMode = true; initApp(); }

        // --- LOGIC: PULL FROM DAILY ---
        document.getElementById('btn-pull-daily')?.addEventListener('click', () => {
            const mesAno = document.getElementById('custo-mensal-mes').value; // Formato: YYYY-MM
            if (!mesAno) { showToast("Selecione o M√™s/Ano primeiro.", "error"); return; }
            
            // Filtra as vendas que come√ßam com o YYYY-MM selecionado
            const vendasDoMes = cache.vendasDiarias.filter(v => v.data && v.data.startsWith(mesAno));
            
            // Soma os valores
            const totalFaturamento = vendasDoMes.reduce((acc, curr) => acc + (parseFloat(curr.valor) || 0), 0);
            
            if(vendasDoMes.length === 0) {
                showToast("Nenhuma venda encontrada para este m√™s.", "error");
            } else {
                document.getElementById('custo-mensal-faturamento').value = totalFaturamento.toFixed(2);
                showToast(`Importado: ${formatMoney(totalFaturamento)}`);
            }
        });

        // --- LOGIC: MONTHLY COSTS SAVE (WITH UNIQUE CONSTRAINT) ---
        document.getElementById('custo-mensal-form').addEventListener('submit', async e => {
            e.preventDefault();
            const id = document.getElementById('custo-mensal-id').value;
            const mes = document.getElementById('custo-mensal-mes').value;

            // CORRE√á√ÉO: Verifica√ß√£o de Duplicidade
            // Se existe algum registro com esse m√™s E o ID for diferente do atual (ou seja, n√£o √© edi√ß√£o do mesmo)
            const duplicado = cache.custosMensais.find(c => c.mes === mes && c.id !== id);
            if (duplicado) {
                showToast(`O m√™s ${mes} j√° possui um fechamento lan√ßado! Edite o existente.`, 'error');
                return; // Bloqueia o salvamento
            }

            const data = {
                id: id || null,
                mes: mes,
                faturamento: parseFloat(document.getElementById('custo-mensal-faturamento').value) || 0,
                custosVariaveis: parseFloat(document.getElementById('custo-mensal-custosVariaveis').value) || 0,
                custosFixos: parseFloat(document.getElementById('custo-mensal-custosFixos').value) || 0,
                despesasOperacionais: parseFloat(document.getElementById('custo-mensal-despesasOperacionais').value) || 0,
                impostos: parseFloat(document.getElementById('custo-mensal-impostos').value) || 0,
                outrasReceitasDespesas: parseFloat(document.getElementById('custo-mensal-outrasReceitasDespesas').value) || 0
            };

            if(await saveData('custosMensais', data)) {
                await fetchData('custosMensais'); 
                renderCustosMensais();
                document.getElementById('custo-mensal-form').reset();
                document.getElementById('custo-mensal-id').value='';
                showToast('Fechamento salvo!');
            }
        });

        // --- LOGIC: RENDER MONTHLY HISTORY (WITH DELETE BUTTON) ---
        function renderCustosMensais() {
            const tbody = document.getElementById('custos-mensais-table').querySelector('tbody');
            tbody.innerHTML = '';
            
            if (!cache.custosMensais.length) { tbody.innerHTML = '<tr><td colspan="4">Nenhum registro.</td></tr>'; return; }

            // Ordena por m√™s (decrescente)
            const sorted = [...cache.custosMensais].sort((a,b) => b.mes.localeCompare(a.mes));

            sorted.forEach(c => {
                const lucro = c.faturamento - (c.custosVariaveis + c.custosFixos + c.despesasOperacionais + c.impostos) + c.outrasReceitasDespesas;
                const colorClass = lucro >= 0 ? 'stock-ok' : 'stock-warning'; 

                const [ano, mes] = c.mes.split('-');
                const mesFormatado = `${mes}/${ano}`;

                tbody.innerHTML += `
                    <tr>
                        <td>${mesFormatado}</td>
                        <td>${formatMoney(c.faturamento)}</td>
                        <td class="${colorClass}" style="font-weight:bold;">${formatMoney(lucro)}</td>
                        <td>
                            <button class="btn btn-secondary btn-small btn-edit-mensal" data-id="${c.id}">‚úé</button>
                            <button class="btn btn-danger btn-small btn-delete-mensal" data-id="${c.id}" style="margin-left: 5px;">üóë</button>
                        </td>
                    </tr>
                `;
            });
        }

        // Edit Monthly Logic
        function editMensal(id) {
            const c = cache.custosMensais.find(x => x.id === id);
            if(!c) return;
            
            document.getElementById('custo-mensal-id').value = c.id;
            document.getElementById('custo-mensal-mes').value = c.mes;
            document.getElementById('custo-mensal-faturamento').value = c.faturamento;
            document.getElementById('custo-mensal-custosVariaveis').value = c.custosVariaveis;
            document.getElementById('custo-mensal-custosFixos').value = c.custosFixos;
            document.getElementById('custo-mensal-despesasOperacionais').value = c.despesasOperacionais;
            document.getElementById('custo-mensal-impostos').value = c.impostos;
            document.getElementById('custo-mensal-outrasReceitasDespesas').value = c.outrasReceitasDespesas;

            const chk = document.getElementById('enable-manual-edit');
            if(chk) { chk.checked = true; chk.dispatchEvent(new Event('change')); }
            
            document.getElementById('custo-mensal-form').scrollIntoView({behavior:'smooth'});
        }

        const chkManual = document.getElementById('enable-manual-edit');
        if(chkManual) {
            chkManual.addEventListener('change', (e) => {
                const fields = ['custo-mensal-faturamento', 'custo-mensal-custosVariaveis','custo-mensal-custosFixos', 'custo-mensal-despesasOperacionais', 'custo-mensal-impostos', 'custo-mensal-outrasReceitasDespesas'];
                fields.forEach(id => { const el = document.getElementById(id); if(el) el.disabled = !e.target.checked; });
            });
        }

        // MODAL & DATA handling
        const confirmModal = document.getElementById('confirm-modal');
        const btnYes = document.getElementById('confirm-modal-yes');
        const btnNo = document.getElementById('confirm-modal-no');
        btnYes.addEventListener('click', async () => {
            if (itemParaExcluir && itemParaExcluir.id) {
                btnYes.textContent = "Excluindo..."; btnYes.disabled = true;
                try {
                    await deleteData(itemParaExcluir.collection, itemParaExcluir.id);
                    const coll = itemParaExcluir.collection;
                    if (!isLocalMode) cache[coll] = cache[coll].filter(i => i.id !== itemParaExcluir.id);
                    await fetchData(coll);
                    if(coll === 'fornecedores') { renderFornecedoresTable(); populateSelects(); }
                    else if(coll === 'produtos') { renderProdutos(); populateSelects(); }
                    else if(coll === 'insumos') { renderInsumos(); populateSelects(); }
                    else if(coll === 'receitas') { renderReceitas(); populateSelects(); }
                    else if(coll === 'custosMensais') { renderCustosMensais(); } // ATUALIZA TABELA MENSAL
                    showToast('Exclu√≠do com sucesso!', 'success');
                } catch (e) { console.error(e); showToast('Erro: ' + e.message, 'error'); } 
                finally { confirmModal.style.display = 'none'; btnYes.textContent = "Sim"; btnYes.disabled = false; itemParaExcluir = null; }
            }
        });
        btnNo.addEventListener('click', () => { confirmModal.style.display = 'none'; itemParaExcluir = null; });
        function confirmDelete(coll, id) {
            if (!id) return;
            itemParaExcluir = { collection: coll, id: id };
            document.getElementById('confirm-modal-text').textContent = "Tem certeza?";
            confirmModal.style.display = 'block';
        }

        // AUTH
        function setupAuthListeners() {
            auth.onAuthStateChanged(user => {
                if(user) { currentUser = user; document.getElementById('auth-container').classList.add('hidden'); document.getElementById('app-container').classList.remove('hidden'); document.getElementById('app-nav').classList.remove('hidden'); initApp(); }
                else { currentUser = null; document.getElementById('auth-container').classList.remove('hidden'); document.getElementById('app-container').classList.add('hidden'); }
            });
            document.getElementById('login-form').addEventListener('submit', e => { e.preventDefault(); auth.signInWithEmailAndPassword(document.getElementById('login-email').value, document.getElementById('login-password').value).catch(e=>showToast(e.message,'error')); });
            document.getElementById('logout-button').addEventListener('click', () => auth.signOut());
        }

        // DATA
        async function initApp() {
            if(isLocalMode) currentUser = {uid:'local'};
            await Promise.all([fetchConfiguracoes(), ...COLLECTIONS_LIST.map(c => fetchData(c))]);
            renderAll();
        }
        async function fetchData(coll) {
            if(isLocalMode) { cache[coll] = localData[coll] || []; return; }
            cache[coll] = [];
            const snap = await db.collection(coll).where('userId','==',currentUser.uid).get();
            cache[coll] = snap.docs.map(d => ({id:d.id, ...d.data()}));
        }
        async function fetchFullDataForBackup(coll) {
            if(isLocalMode) return localData[coll] || [];
            const snap = await db.collection(coll).where('userId','==',currentUser.uid).get();
            return snap.docs.map(d => ({id:d.id, ...d.data()}));
        }
        async function saveData(coll, data) {
            data.userId = currentUser.uid;
            try {
                if(isLocalMode) {
                    if(!localData[coll]) localData[coll] = [];
                    if(data.id) { const idx = localData[coll].findIndex(i=>i.id===data.id); if(idx>-1) localData[coll][idx] = data; else localData[coll].push(data); }
                    else { data.id = Date.now().toString(); localData[coll].push(data); }
                } else {
                    if(data.id) await db.collection(coll).doc(data.id).set(data, { merge: true });
                    else { delete data.id; await db.collection(coll).add(data); }
                }
                return true;
            } catch(e) { console.error(e); showToast("Erro ao salvar", "error"); return false; }
        }
        async function deleteData(coll, id) {
            if(!id) return false;
            if(isLocalMode) localData[coll] = localData[coll].filter(i=>i.id!==id);
            else await db.collection(coll).doc(id).delete();
            return true;
        }

        // RENDERS
        function renderAll() { renderFornecedoresTable(); renderInsumos(); renderProdutos(); renderReceitas(); renderCustosMensais(); populateSelects(); updateDashboard(); }

        // VENDAS DI√ÅRIAS
        const pizzaSelect = document.getElementById('venda-pizza-select');
        const pizzaQtd = document.getElementById('venda-pizza-qtd');
        const pizzaVal = document.getElementById('venda-pizza-valor');
        function calcPizzaTotal() {
            const id = pizzaSelect.value;
            const qtd = parseFloat(pizzaQtd.value) || 0;
            if(!id) { pizzaVal.value = ''; return; }
            const receita = cache.receitas.find(r => r.id === id);
            if(receita && receita.preco_venda) { pizzaVal.value = (parseFloat(receita.preco_venda) * qtd).toFixed(2); }
        }
        pizzaSelect.addEventListener('change', calcPizzaTotal);
        pizzaQtd.addEventListener('input', calcPizzaTotal);

        const prodSelect = document.getElementById('venda-produto-select');
        const prodQtd = document.getElementById('venda-produto-qtd');
        const prodVal = document.getElementById('venda-produto-valor');
        function calcProdTotal() {
            const id = prodSelect.value;
            const qtd = parseFloat(prodQtd.value) || 0;
            if(!id) { prodVal.value = ''; return; }
            const produto = cache.produtos.find(p => p.id === id);
            if(produto && produto.preco_venda) { prodVal.value = (parseFloat(produto.preco_venda) * qtd).toFixed(2); }
        }
        prodSelect.addEventListener('change', calcProdTotal);
        prodQtd.addEventListener('input', calcProdTotal);

        function renderDailySalesTable() {
            const tbody = document.getElementById('sales-table').querySelector('tbody');
            tbody.innerHTML = '';
            let total = 0;
            dailySalesBuffer.forEach((item, index) => {
                total += item.valor;
                tbody.innerHTML += `<tr><td>${item.tipo}</td><td>${item.nome}</td><td>${item.qtd}</td><td>${formatMoney(item.valor)}</td><td><button class="btn btn-danger btn-small" onclick="removeSaleItem(${index})">X</button></td></tr>`;
            });
            document.getElementById('daily-total-display').textContent = 'Total do Dia: ' + formatMoney(total);
        }
        window.removeSaleItem = function(index) { dailySalesBuffer.splice(index, 1); renderDailySalesTable(); };
        document.getElementById('btn-add-pizza-sale').addEventListener('click', () => {
            const id = pizzaSelect.value; const qtd = parseFloat(pizzaQtd.value); const val = parseFloat(pizzaVal.value);
            if(!id || !qtd || !val) { showToast("Preencha todos os campos", "error"); return; }
            const receita = cache.receitas.find(r => r.id === id);
            dailySalesBuffer.push({ tipo: 'Pizza', itemId: id, nome: receita ? receita.nome : '?', qtd: qtd, valor: val });
            pizzaSelect.value = ''; pizzaQtd.value = 1; pizzaVal.value = ''; renderDailySalesTable();
        });
        document.getElementById('btn-add-prod-sale').addEventListener('click', () => {
            const id = prodSelect.value; const qtd = parseFloat(prodQtd.value); const val = parseFloat(prodVal.value);
            if(!id || !qtd || !val) { showToast("Preencha todos os campos", "error"); return; }
            const produto = cache.produtos.find(p => p.id === id);
            dailySalesBuffer.push({ tipo: 'Produto', itemId: id, nome: produto ? produto.nome : '?', qtd: qtd, valor: val });
            prodSelect.value = ''; prodQtd.value = 1; prodVal.value = ''; renderDailySalesTable();
        });
        document.getElementById('btn-save-day').addEventListener('click', async () => {
            if(dailySalesBuffer.length === 0) { showToast("Nenhum item para salvar", "error"); return; }
            const dataMov = document.getElementById('venda-data').value;
            if(!dataMov) { showToast("Selecione a data", "error"); return; }
            for(const item of dailySalesBuffer) { await saveData('vendasDiarias', { ...item, data: dataMov }); }
            dailySalesBuffer = []; renderDailySalesTable(); showToast("Movimento do dia salvo com sucesso!");
            await fetchData('vendasDiarias'); // Atualiza cache para o bot√£o "Puxar do Di√°rio" funcionar imediatamente
        });

        // CRUD FUNCTIONS (Fornecedor, Produto, Insumo, Receita)
        function renderFornecedoresTable() {
            const tbody = document.getElementById('fornecedores-table').querySelector('tbody'); tbody.innerHTML = '';
            if (!cache.fornecedores.length) { tbody.innerHTML = '<tr><td colspan="5">Vazio.</td></tr>'; return; }
            [...cache.fornecedores].sort((a,b)=>(a.nome||"").localeCompare(b.nome||"")).forEach(f => {
                if(!f.id) return;
                tbody.innerHTML += `<tr><td>${f.nome}</td><td>${f.contato||''}</td><td>${f.telefone||''}</td><td>${f.endereco||''}</td><td class="actions-cell"><button class="btn btn-secondary btn-small btn-edit-fornecedor" data-id="${f.id}">‚úé</button> <button class="btn btn-danger btn-small btn-delete-fornecedor" data-id="${f.id}">üóë</button></td></tr>`;
            });
        }
        function editFornecedor(id) { const f = cache.fornecedores.find(i => i.id === id); if (!f) return; showView('fornecedores'); document.getElementById('fornecedor-id').value = f.id; document.getElementById('fornecedor-nome').value = f.nome; document.getElementById('fornecedor-contato').value = f.contato||''; document.getElementById('fornecedor-telefone').value = f.telefone||''; document.getElementById('fornecedor-email').value = f.email||''; document.getElementById('fornecedor-endereco').value = f.endereco||''; document.getElementById('fornecedor-form-title').textContent = 'Editar Fornecedor'; document.getElementById('cancel-edit-fornecedor').classList.remove('hidden'); document.getElementById('fornecedor-form').scrollIntoView({behavior:'smooth'}); }
        document.getElementById('fornecedor-form').addEventListener('submit', async e => { e.preventDefault(); const data = { id: document.getElementById('fornecedor-id').value || null, nome: document.getElementById('fornecedor-nome').value, contato: document.getElementById('fornecedor-contato').value, telefone: document.getElementById('fornecedor-telefone').value, email: document.getElementById('fornecedor-email').value, endereco: document.getElementById('fornecedor-endereco').value }; if(await saveData('fornecedores', data)) { await fetchData('fornecedores'); renderFornecedoresTable(); populateSelects(); document.getElementById('fornecedor-form').reset(); document.getElementById('fornecedor-id').value=''; document.getElementById('cancel-edit-fornecedor').classList.add('hidden'); showToast('Salvo!'); } });
        document.getElementById('cancel-edit-fornecedor').addEventListener('click', () => { document.getElementById('fornecedor-form').reset(); document.getElementById('fornecedor-id').value=''; document.getElementById('cancel-edit-fornecedor').classList.add('hidden'); });

        function renderProdutos() { const tb = document.getElementById('produtos-table').querySelector('tbody'); tb.innerHTML = ''; cache.produtos.forEach(p => { const f=cache.fornecedores.find(x=>x.id===p.fornecedorId)?.nome||'-'; tb.innerHTML += `<tr><td>${p.nome}</td><td>${f}</td><td>${formatMoney(p.preco_venda)}</td><td>${p.estoque_atual||0}</td><td class="actions-cell"><button class="btn btn-secondary btn-small btn-edit-produto" data-id="${p.id}">‚úé</button> <button class="btn btn-danger btn-small btn-delete-produto" data-id="${p.id}">üóë</button></td></tr>`; }); }
        function editProduto(id) { const p = cache.produtos.find(i => i.id === id); if (!p) return; showView('produtos'); document.getElementById('produto-id').value = p.id; document.getElementById('prod-nome').value = p.nome; document.getElementById('prod-categoria').value = p.categoria; document.getElementById('prod-fornecedor-select').value = p.fornecedorId; document.getElementById('prod-custo').value = p.preco_compra; document.getElementById('prod-venda').value = p.preco_venda; document.getElementById('prod-unidade').value = p.unidade; document.getElementById('prod-est-atual').value = p.estoque_atual; document.getElementById('prod-est-min').value = p.estoque_min; document.getElementById('prod-est-ideal').value = p.estoque_ideal; document.getElementById('cancel-edit-produto').classList.remove('hidden'); document.getElementById('produto-form').scrollIntoView({behavior:'smooth'}); }
        document.getElementById('produto-form').addEventListener('submit', async e => { e.preventDefault(); await saveData('produtos', { id:document.getElementById('produto-id').value||null, nome:document.getElementById('prod-nome').value, categoria:document.getElementById('prod-categoria').value, fornecedorId:document.getElementById('prod-fornecedor-select').value, preco_compra:parseFloat(document.getElementById('prod-custo').value), preco_venda:parseFloat(document.getElementById('prod-venda').value), unidade:document.getElementById('prod-unidade').value, estoque_atual:parseFloat(document.getElementById('prod-est-atual').value), estoque_min:parseFloat(document.getElementById('prod-est-min').value), estoque_ideal:parseFloat(document.getElementById('prod-est-ideal').value) }); document.getElementById('produto-form').reset(); document.getElementById('produto-id').value=''; document.getElementById('cancel-edit-produto').classList.add('hidden'); await fetchData('produtos'); renderProdutos(); populateSelects(); showToast('Salvo!'); });
        document.getElementById('cancel-edit-produto').addEventListener('click', () => { document.getElementById('produto-form').reset(); document.getElementById('produto-id').value=''; document.getElementById('cancel-edit-produto').classList.add('hidden'); });

        function renderInsumos() { const tb = document.getElementById('insumos-table').querySelector('tbody'); tb.innerHTML = ''; cache.insumos.forEach(i => { const cb = i.qtd_embalagem_g>0?(i.custo_embalagem/i.qtd_embalagem_g):0; tb.innerHTML += `<tr><td>${i.nome}</td><td>${formatMoney(cb)}/${i.unidade_base}</td><td>${i.estoque_atual||0}</td><td class="actions-cell"><button class="btn btn-secondary btn-small btn-edit-insumo" data-id="${i.id}">‚úé</button> <button class="btn btn-danger btn-small btn-delete-insumo" data-id="${i.id}">üóë</button></td></tr>`; }); }
        function editInsumo(id) { const i = cache.insumos.find(x => x.id === id); if (!i) return; showView('insumos'); document.getElementById('insumo-id').value = i.id; document.getElementById('insumo-nome').value = i.nome; document.getElementById('insumo-fornecedor-select').value = i.fornecedorId; document.getElementById('insumo-custo-embalagem').value = i.custo_embalagem; document.getElementById('insumo-qtd-embalagem').value = i.quantidade_embalagem; document.getElementById('insumo-unidade-embalagem').value = i.unidade_embalagem; document.getElementById('insumo-est-atual').value = i.estoque_atual; document.getElementById('insumo-est-min').value = i.estoque_min; document.getElementById('insumo-est-ideal').value = i.estoque_ideal; if(i.validade) document.getElementById('insumo-validade').value = i.validade; document.getElementById('cancel-edit-insumo').classList.remove('hidden'); document.getElementById('insumo-form').scrollIntoView({behavior:'smooth'}); }
        document.getElementById('insumo-form').addEventListener('submit', async e => { e.preventDefault(); const q=parseFloat(document.getElementById('insumo-qtd-embalagem').value), u=document.getElementById('insumo-unidade-embalagem').value; let qg=q, b='un'; if(u==='kg'||u==='L'){qg=q*1000;b=u==='kg'?'g':'ml'} else if(u==='g'||u==='ml'){b=u} await saveData('insumos', { id:document.getElementById('insumo-id').value||null, nome:document.getElementById('insumo-nome').value, fornecedorId:document.getElementById('insumo-fornecedor-select').value, custo_embalagem:parseFloat(document.getElementById('insumo-custo-embalagem').value), quantidade_embalagem:q, unidade_embalagem:u, qtd_embalagem_g:qg, unidade_base:b, estoque_atual:parseFloat(document.getElementById('insumo-est-atual').value), estoque_min:parseFloat(document.getElementById('insumo-est-min').value), estoque_ideal:parseFloat(document.getElementById('insumo-est-ideal').value) }); document.getElementById('insumo-form').reset(); document.getElementById('insumo-id').value=''; document.getElementById('cancel-edit-insumo').classList.add('hidden'); await fetchData('insumos'); renderInsumos(); populateSelects(); showToast('Salvo!'); });
        document.getElementById('cancel-edit-insumo').addEventListener('click', () => { document.getElementById('insumo-form').reset(); document.getElementById('insumo-id').value=''; document.getElementById('cancel-edit-insumo').classList.add('hidden'); });

        function updateReceitaTotal() { let total = 0; document.querySelectorAll('.ingredient-row').forEach(row => { const id = row.querySelector('.ing-select').value; const qty = parseFloat(row.querySelector('.ing-qtd').value) || 0; const insumo = cache.insumos.find(i => i.id === id); if (insumo && insumo.qtd_embalagem_g > 0) { const pricePerUnit = insumo.custo_embalagem / insumo.qtd_embalagem_g; total += pricePerUnit * qty; } }); document.getElementById('custo-total-ingredientes').textContent = 'Custo: ' + formatMoney(total); }
        function addReceitaRow(ingId = '', qtyVal = 1) { const div = document.createElement('div'); div.className='ingredient-row'; div.innerHTML = `<select class="ing-select"><option value="">Insumo...</option>${cache.insumos.map(i=>`<option value="${i.id}">${i.nome}</option>`).join('')}</select><input type="number" class="ing-qtd" placeholder="Qtd (g/ml/un)" value="${qtyVal}"><button type="button" class="btn btn-danger btn-small remove-ing-btn">X</button>`; if(ingId) div.querySelector('.ing-select').value = ingId; const select = div.querySelector('.ing-select'); const input = div.querySelector('.ing-qtd'); const btn = div.querySelector('.remove-ing-btn'); select.addEventListener('change', updateReceitaTotal); input.addEventListener('input', updateReceitaTotal); btn.addEventListener('click', () => { div.remove(); updateReceitaTotal(); }); document.getElementById('ingredients-list').appendChild(div); updateReceitaTotal(); }
        document.getElementById('add-ingredient-btn').addEventListener('click', () => addReceitaRow());
        function renderReceitas() { const tb = document.getElementById('receitas-table').querySelector('tbody'); tb.innerHTML = ''; cache.receitas.forEach(r => { let custoReceita = 0; if(r.ingredientes) { r.ingredientes.forEach(ing => { const ins = cache.insumos.find(i => i.id === ing.id); if(ins && ins.qtd_embalagem_g > 0) { const unitCost = ins.custo_embalagem / ins.qtd_embalagem_g; custoReceita += unitCost * ing.qtd; } }); } tb.innerHTML += `<tr><td>${r.nome}</td><td>${formatMoney(custoReceita)}</td><td>${formatMoney(r.preco_venda)}</td><td class="actions-cell"><button class="btn btn-secondary btn-small btn-edit-receita" data-id="${r.id}">‚úé</button> <button class="btn btn-danger btn-small btn-delete-receita" data-id="${r.id}">üóë</button></td></tr>`; }); }
        function editReceita(id) { const r = cache.receitas.find(x => x.id === id); if (!r) return; showView('receitas'); document.getElementById('receita-id').value = r.id; document.getElementById('receita-nome').value = r.nome; document.getElementById('receita-venda').value = r.preco_venda || ''; const list = document.getElementById('ingredients-list'); list.innerHTML = ''; if (r.ingredientes && Array.isArray(r.ingredientes)) { r.ingredientes.forEach(ing => { addReceitaRow(ing.id, ing.qtd); }); } updateReceitaTotal(); document.getElementById('cancel-edit-receita').classList.remove('hidden'); document.getElementById('receita-form').scrollIntoView({behavior:'smooth'}); }
        document.getElementById('receita-form').addEventListener('submit', async e => { e.preventDefault(); const rows = document.querySelectorAll('.ingredient-row'); const ings = []; rows.forEach(r => { const id = r.querySelector('.ing-select').value; const qtd = parseFloat(r.querySelector('.ing-qtd').value); if(id && qtd>0) ings.push({id, qtd}); }); await saveData('receitas', { id: document.getElementById('receita-id').value || null, nome: document.getElementById('receita-nome').value, preco_venda: parseFloat(document.getElementById('receita-venda').value) || 0, ingredientes: ings }); document.getElementById('receita-form').reset(); document.getElementById('receita-id').value = ''; document.getElementById('ingredients-list').innerHTML = ''; document.getElementById('cancel-edit-receita').classList.add('hidden'); document.getElementById('custo-total-ingredientes').textContent = 'Custo: R$ 0,00'; await fetchData('receitas'); renderReceitas(); populateSelects(); showToast('Salvo!'); });
        document.getElementById('cancel-edit-receita').addEventListener('click', () => { document.getElementById('receita-form').reset(); document.getElementById('receita-id').value = ''; document.getElementById('ingredients-list').innerHTML = ''; document.getElementById('cancel-edit-receita').classList.add('hidden'); document.getElementById('custo-total-ingredientes').textContent = 'Custo: R$ 0,00'; });

        async function fetchConfiguracoes(){if(isLocalMode)configCache=localData.configuracoes||{};else{try{const doc=await db.collection('configuracoes').doc(currentUser.uid).get();configCache=doc.exists?doc.data():{};}catch(e){}}displayConfiguracoes();}
        function displayConfiguracoes(){Object.keys(configCache).forEach(k=>{const el=document.getElementById(`config-${k.replace(/_/g,'-')}`);if(el)el.value=configCache[k];});}
        document.getElementById('configuracoes-form').addEventListener('submit', async e => { e.preventDefault(); const data = { custo_hora_mao_de_obra: parseFloat(document.getElementById('config-custo-hora-mao-de-obra').value), rateio_por_pizza: parseFloat(document.getElementById('config-rateio-despesas-fixas').value), meta_cmv_padrao: parseFloat(document.getElementById('config-meta-cmv-padrao').value), alerta_variacao: parseFloat(document.getElementById('config-alerta-variacao').value) }; if(isLocalMode) localData.configuracoes=data; else await db.collection('configuracoes').doc(currentUser.uid).set(data); configCache=data; showToast("Salvo!"); });

        // BACKUP
        document.getElementById('btn-backup-download').addEventListener('click', async () => { if(!currentUser && !isLocalMode) return; const backupPayload = { timestamp: new Date(), configuracoes: configCache || {} }; for(const coll of COLLECTIONS_LIST) { backupPayload[coll] = await fetchFullDataForBackup(coll); } const url = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(backupPayload)); const a = document.createElement('a'); a.href = url; a.download = `backup_pizzaria_${new Date().toISOString().split('T')[0]}.json`; document.body.appendChild(a); a.click(); a.remove(); });
        document.getElementById('btn-backup-restore-click').addEventListener('click', () => { if(confirm("ATEN√á√ÉO: Restaurar o backup apagar√° os dados atuais e substituir√° pelo arquivo. Deseja continuar?")) { document.getElementById('backup-file-input').click(); } });
        document.getElementById('backup-file-input').addEventListener('change', async (e) => { const file = e.target.files[0]; if(!file) return; const reader = new FileReader(); reader.onload = async (ev) => { try { const d = JSON.parse(ev.target.result); if(!d.fornecedores && !d.produtos && !d.insumos) throw new Error("Arquivo inv√°lido ou vazio."); showToast("Iniciando restaura√ß√£o...", "info"); if(!isLocalMode) { if(d.configuracoes) await db.collection('configuracoes').doc(currentUser.uid).set(d.configuracoes); for(const collName of COLLECTIONS_LIST) { const snapshot = await db.collection(collName).where('userId','==',currentUser.uid).get(); if (!snapshot.empty) { const batch = db.batch(); snapshot.docs.forEach(doc => batch.delete(doc.ref)); await batch.commit(); } if(d[collName] && Array.isArray(d[collName]) && d[collName].length > 0) { for(const item of d[collName]) { item.userId = currentUser.uid; if(item.id) await db.collection(collName).doc(item.id).set(item, {merge: true}); else await db.collection(collName).add(item); } } } } else { localData.configuracoes = d.configuracoes || {}; for(const collName of COLLECTIONS_LIST) { localData[collName] = d[collName] || []; } } await initApp(); showToast("Restaura√ß√£o conclu√≠da com sucesso!", "success"); } catch(err){ console.error(err); showToast("Erro na restaura√ß√£o: " + err.message, "error"); } finally { e.target.value = ''; } }; reader.readAsText(file); });

        // GLOBAL CLICKS
        document.body.addEventListener('click', e => { const btn = e.target.closest('button'); if (!btn) return; const id = btn.dataset.id; 
            if(btn.classList.contains('btn-edit-fornecedor')) { e.preventDefault(); editFornecedor(id); } 
            else if(btn.classList.contains('btn-edit-produto')) { e.preventDefault(); editProduto(id); } 
            else if(btn.classList.contains('btn-edit-insumo')) { e.preventDefault(); editInsumo(id); } 
            else if(btn.classList.contains('btn-edit-receita')) { e.preventDefault(); editReceita(id); } 
            else if(btn.classList.contains('btn-edit-mensal')) { e.preventDefault(); editMensal(id); } 
            
            // EXCLUS√ïES
            else if(btn.classList.contains('btn-delete-fornecedor')) { e.preventDefault(); confirmDelete('fornecedores', id); } 
            else if(btn.classList.contains('btn-delete-insumo')) { e.preventDefault(); confirmDelete('insumos', id); } 
            else if(btn.classList.contains('btn-delete-produto')) { e.preventDefault(); confirmDelete('produtos', id); } 
            else if(btn.classList.contains('btn-delete-receita')) { e.preventDefault(); confirmDelete('receitas', id); } 
            else if(btn.classList.contains('btn-delete-mensal')) { e.preventDefault(); confirmDelete('custosMensais', id); } 
        });
        function formatMoney(v) { return parseFloat(v||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'}); }
        function showToast(msg, type='success') { const t = document.getElementById('toast'); t.textContent=msg; t.className=`toast ${type} show`; setTimeout(()=>t.classList.remove('show'),3000); }
        function populateSelects() { const fOpts = '<option value="">Selecione</option>' + [...cache.fornecedores].sort((a,b)=>(a.nome||"").localeCompare(b.nome||"")).map(f=>`<option value="${f.id}">${f.nome}</option>`).join(''); document.getElementById('insumo-fornecedor-select').innerHTML = fOpts; document.getElementById('prod-fornecedor-select').innerHTML = fOpts; const pizzas = cache.receitas; if(pizzas.length > 0) { document.getElementById('venda-pizza-select').innerHTML = '<option value="">Selecione</option>'+pizzas.map(r=>`<option value="${r.id}">${r.nome}</option>`).join(''); } else { document.getElementById('venda-pizza-select').innerHTML = '<option value="">(Nenhuma receita cadastrada)</option>'; } const produtos = cache.produtos; if(produtos.length > 0) { document.getElementById('venda-produto-select').innerHTML = '<option value="">Selecione</option>'+produtos.map(p=>`<option value="${p.id}">${p.nome}</option>`).join(''); } else { document.getElementById('venda-produto-select').innerHTML = '<option value="">(Nenhum produto cadastrado)</option>'; } }
        function updateDashboard() { document.getElementById('dash-stock-count').textContent=cache.insumos.length+cache.produtos.length; }
        const navLinks = document.querySelectorAll('.nav-link');
        function showView(id) { document.querySelectorAll('.view').forEach(v=>v.classList.remove('active')); document.getElementById(id+'-view')?.classList.add('active'); if(id === 'vendas-diarias') { populateSelects(); } }
        navLinks.forEach(l=>l.addEventListener('click', e=>{e.preventDefault(); showView(e.target.dataset.view);}));
        document.getElementById('btn-zerar-fornecedores')?.addEventListener('click', async () => { if(!confirm("Apagar TODOS?")) return; const s = await db.collection('fornecedores').where('userId','==',currentUser.uid).get(); const b = db.batch(); s.docs.forEach(d=>b.delete(d.ref)); await b.commit(); await fetchData('fornecedores'); renderAll(); showToast('Apagado'); });
    });
    </script>
</body>
</html>