<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pizzaria Cost Control Pro - Gest√£o Completa</title>

    <style>
        :root {
            --primary-color: #00695c; 
            --primary-dark: #004d40;
            --header-blue: #005b96;
            --secondary-color: #FFC107;
            --light-gray: #f5f7fa;
            --medium-gray: #e0e0e0;
            --dark-gray: #455a64;
            --text-color: #263238;
            --white: #fff;
            --success-color: #2e7d32;
            --error-color: #c62828;
            --info-color: #0277bd;
            --shadow: 0 2px 5px rgba(0,0,0,0.05);
            --border-radius: 6px;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: var(--light-gray); color: var(--text-color); line-height: 1.5; display: flex; flex-direction: column; min-height: 100vh; }
        
        header { background-color: var(--primary-color); color: var(--white); padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); flex-wrap: wrap; }
        header h1 { font-size: 1.4rem; margin-right: 2rem; font-weight: 600; }
        
        #auth-container, #app-container { width: 100%; max-width: 1250px; margin: 2rem auto; padding: 0 1rem; }
        
        .auth-form { background: var(--white); padding: 2.5rem; border-radius: var(--border-radius); box-shadow: var(--shadow); max-width: 450px; margin: 2rem auto; border-top: 4px solid var(--primary-color); }
        .auth-form h2 { text-align: center; margin-bottom: 1.5rem; color: var(--primary-dark); }
        
        .form-group { margin-bottom: 1.25rem; }
        .form-group label { display: block; margin-bottom: 0.4rem; font-weight: 600; font-size: 0.9rem; color: var(--dark-gray); }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 0.65rem; border: 1px solid #cfd8dc; border-radius: 4px; font-size: 1rem; transition: border 0.2s; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: var(--primary-color); }
        .form-group input:disabled { background-color: #eee; color: #888; cursor: not-allowed; }
        .form-row { display: flex; gap: 1rem; flex-wrap: wrap; }
        .form-row .form-group { flex: 1; min-width: 150px; }

        .btn { display: inline-block; padding: 0.6rem 1.2rem; font-size: 0.95rem; font-weight: 600; text-align: center; border: none; border-radius: 4px; cursor: pointer; transition: all 0.2s; width: 100%; }
        .btn:active:not(:disabled) { transform: translateY(1px); }
        .btn-primary { background-color: var(--primary-color); color: var(--white); } .btn-primary:hover { background-color: var(--primary-dark); }
        .btn-secondary { background-color: var(--dark-gray); color: var(--white); } .btn-secondary:hover { background-color: #37474f; }
        .btn-success { background-color: var(--success-color); color: var(--white); }
        .btn-danger { background-color: var(--error-color); color: var(--white); }
        .btn-info { background-color: var(--info-color); color: var(--white); }
        .btn-warning { background-color: #ff9800; color: var(--white); }
        .btn-small { padding: 0.3rem 0.7rem; font-size: 0.85rem; width: auto; }
        
        .btn-export { background-color: #fff; border: 1px solid #ccc; color: #333; font-weight: 500; display: inline-flex; align-items: center; gap: 5px; padding: 0.4rem 0.8rem; }
        .btn-export:hover { background-color: #f5f5f5; border-color: #bbb; }

        .auth-link { text-align: center; margin-top: 1rem; } .auth-link a { color: var(--primary-color); text-decoration: none; font-weight: 600; }
        
        nav { display: flex; gap: 0.2rem; align-items: center; flex-wrap: wrap; margin-top: 10px; }
        nav a, nav button { color: rgba(255,255,255,0.9); text-decoration: none; background: none; border: none; cursor: pointer; font-size: 0.9rem; padding: 0.5rem 0.8rem; border-radius: 4px; transition: background-color 0.2s; font-weight: 500; }
        nav a:hover, nav button:hover, nav a.active { background-color: rgba(255,255,255,0.15); color: #fff; }
        #logout-button { background-color: rgba(0,0,0,0.2); margin-left: auto; }

        main { flex: 1; }
        .view { display: none; } .view.active { display: block; animation: fadeIn 0.4s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .card { background: var(--white); padding: 1.5rem; border-radius: var(--border-radius); box-shadow: var(--shadow); margin-bottom: 1.5rem; border: 1px solid #eceff1; }
        
        .dashboard-section-title { font-size: 1.1rem; color: var(--primary-color); font-weight: 700; margin: 1.5rem 0 1rem 0; padding-bottom: 0.5rem; border-bottom: 2px solid #e0f2f1; }

        .kpi-card-modern {
            background: #fff; border: 1px solid #e0e0e0; border-left: 4px solid var(--primary-color); border-radius: 4px; padding: 1.2rem; display: flex; flex-direction: column; justify-content: space-between; height: 100%; transition: transform 0.2s, box-shadow 0.2s;
        }
        .kpi-card-modern:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .kpi-card-modern h3 { font-size: 0.85rem; color: #546e7a; margin-bottom: 0.5rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
        .kpi-card-modern .value { font-size: 1.8rem; font-weight: 700; color: var(--primary-dark); margin-bottom: 0.5rem; }
        .kpi-card-modern .desc { font-size: 0.8rem; color: #78909c; line-height: 1.3; }
        
        .kpi-green { border-left-color: var(--success-color); } .kpi-green .value { color: var(--success-color); }
        .kpi-red { border-left-color: var(--error-color); } .kpi-red .value { color: var(--error-color); }
        .kpi-blue { border-left-color: var(--info-color); } .kpi-blue .value { color: var(--info-color); }

        .action-box { background-color: #fff; border: 1px solid #e0e0e0; border-radius: 4px; padding: 1.5rem; margin-bottom: 1rem; }
        .action-title { font-weight: 700; color: var(--dark-gray); margin-bottom: 0.5rem; font-size: 1rem; display: flex; align-items: center; gap: 8px; }
        .action-sug { font-size: 0.9rem; color: #546e7a; padding-left: 1rem; border-left: 3px solid #eceff1; margin-top: 0.5rem; }

        .grid-container { display: grid; gap: 1.5rem; }
        @media (min-width: 768px) { .grid-2 { grid-template-columns: repeat(2, 1fr); } .grid-3 { grid-template-columns: repeat(3, 1fr); } .grid-4 { grid-template-columns: repeat(4, 1fr); } }

        table { width: 100%; border-collapse: collapse; margin-top: 1rem; font-size: 0.95rem; }
        th, td { padding: 0.8rem; text-align: left; border-bottom: 1px solid #eceff1; }
        th { background-color: #fafafa; font-weight: 600; color: var(--dark-gray); }
        tr:hover { background-color: #f5f5f5; }
        .actions-cell { text-align: right; white-space: nowrap; }
        .actions-cell .btn { margin-left: 0.3rem; }

        #ind-mensais-table thead tr th {
            background-color: var(--header-blue);
            color: #fff;
            border: 1px solid #004c7f;
            text-transform: uppercase;
            font-size: 0.85rem;
        }
        #ind-mensais-table tbody tr td { border: 1px solid #e0e0e0; }
        #ind-mensais-table tbody tr:nth-child(odd) { background-color: #fff; }
        #ind-mensais-table tbody tr:nth-child(even) { background-color: #f9f9f9; }
        .ind-val-blue { color: #0d47a1; font-weight: 700; }
        .ind-val-white { background-color: var(--primary-color); color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.9em;}

        .total-cost { text-align: right; font-size: 1.3rem; font-weight: 700; margin-top: 1rem; color: var(--primary-dark); }
        .stock-warning { color: var(--error-color); font-weight: bold; }
        .stock-ok { color: var(--success-color); }
        .checkbox-wrapper { display: flex; align-items: center; margin-bottom: 1rem; padding: 0.5rem; background: #e1f5fe; border-radius: 4px; color: #0277bd; }
        .checkbox-wrapper input { width: auto; margin-right: 10px; cursor: pointer; }
        .hidden { display: none; }
        
        .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); padding: 1rem 2rem; border-radius: 30px; color: var(--white); z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; box-shadow: 0 4px 12px rgba(0,0,0,0.15); font-weight: 500; }
        .toast.show { opacity: 1; visibility: visible; }
        .toast.success { background-color: var(--success-color); } .toast.error { background-color: var(--error-color); }

        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); backdrop-filter: blur(2px); }
        .modal-content { background-color: #fefefe; margin: 15% auto; padding: 25px; border: none; width: 90%; max-width: 400px; border-radius: 8px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); text-align: center; }
        .modal-buttons { margin-top: 20px; display: flex; justify-content: center; gap: 10px; } 
        .modal-buttons .btn { width: auto; min-width: 100px; }
        
        .backup-area { border: 2px dashed #b0bec5; padding: 20px; border-radius: 8px; margin-top: 20px; background-color: #fafafa; }
        .flex-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px; }
        .title-blue-bg { background-color: #0d47a1; color: white; padding: 5px 15px; display: inline-block; font-weight: bold; font-size: 1.2rem; }
    </style>
</head>
<body>

    <header>
        <h1>üçï Pizzaria Cost Control Pro</h1>
        <nav id="app-nav" class="hidden">
            <a href="#" class="nav-link" data-view="vendas-diarias">Pedidos/Venda Di√°rios</a>
            <a href="#" class="nav-link" data-view="custos-mensais">Mensal</a>
            <a href="#" class="nav-link" data-view="indicadores-mensais">Indicadores Mensais</a>
            <a href="#" class="nav-link" data-view="dashboard">Indicadores Anuais</a>
            <a href="#" class="nav-link" data-view="lista-compras">Lista Compras</a>
            <a href="#" class="nav-link" data-view="produtos">Produtos</a>
            <a href="#" class="nav-link" data-view="insumos">Insumos</a>
            <a href="#" class="nav-link" data-view="receitas">Receitas</a>
            <a href="#" class="nav-link" data-view="fornecedores">Fornecedores</a>
            <a href="#" class="nav-link" data-view="configuracoes">‚öôÔ∏è Config</a>
            <button id="logout-button">Sair</button>
        </nav>
    </header>

    <main>
        <!-- TELAS DE AUTENTICA√á√ÉO -->
        <div id="auth-container">
            <div id="login-view" class="auth-form"><h2>Login</h2><form id="login-form"><div class="form-group"><label for="login-email">Email</label><input type="email" id="login-email" required></div><div class="form-group"><label for="login-password">Senha</label><input type="password" id="login-password" required></div><button type="submit" class="btn btn-primary">Entrar</button></form><div class="auth-link"><p>N√£o tem conta? <a href="#" id="show-register">Cadastre-se</a></p></div></div>
            <div id="register-view" class="auth-form hidden"><h2>Cadastro</h2><form id="register-form"><div class="form-group"><label for="register-email">Email</label><input type="email" id="register-email" required></div><div class="form-group"><label for="register-password">Senha</label><input type="password" id="register-password" required minlength="6"></div><button type="submit" class="btn btn-primary">Cadastrar</button></form><div class="auth-link"><p>J√° tem conta? <a href="#" id="show-login">Fa√ßa login</a></p></div></div>
        </div>

        <!-- √ÅREA DO APLICATIVO -->
        <div id="app-container" class="hidden">
            
            <!-- 1. INDICADORES ANUAIS -->
            <section id="dashboard-view" class="view">
                <h2 style="border:none; text-transform:uppercase; letter-spacing:1px; font-size:1.2rem;">Indicadores Financeiros Anuais (Dashboard)</h2>
                <div class="dashboard-section-title">Desempenho de Vendas</div>
                <div class="grid-container grid-2">
                    <div class="kpi-card-modern kpi-blue"><h3>Faturamento Bruto Total</h3><div class="value" id="dash-fat-total">R$ 0,00</div><div class="desc">Soma de todo o faturamento lan√ßado no hist√≥rico mensal.</div></div>
                    <div class="kpi-card-modern kpi-blue"><h3>Ticket M√©dio Estimado</h3><div class="value" id="dash-ticket-medio">R$ 0,00</div><div class="desc">Valor m√©dio gasto por venda (baseado em vendas di√°rias).</div></div>
                </div>
                <div class="dashboard-section-title">Rentabilidade e Lucro</div>
                <div class="grid-container grid-4">
                    <div class="kpi-card-modern kpi-green"><h3>Lucro L√≠quido Total</h3><div class="value" id="dash-lucro-total">R$ 0,00</div><div class="desc">Resultado final acumulado do ano.</div></div>
                    <div class="kpi-card-modern kpi-green"><h3>Margem L√≠quida (%)</h3><div class="value" id="dash-margem">0,00%</div><div class="desc">Efici√™ncia real do neg√≥cio.</div></div>
                    <div class="kpi-card-modern"><h3>CMV Total (Custo Vari√°vel)</h3><div class="value" id="dash-cmv-total">R$ 0,00</div><div class="desc">Total gasto com insumos e produ√ß√£o.</div></div>
                    <div class="kpi-card-modern"><h3>Custo Fixo Total</h3><div class="value" id="dash-custo-fixo">R$ 0,00</div><div class="desc">Despesas fixas acumuladas.</div></div>
                </div>
                <div class="dashboard-section-title">üí° Plano de A√ß√£o Personalizado</div><div id="action-plan-container"></div>
                <div class="dashboard-section-title">Operacional & Alertas</div>
                <div class="grid-container grid-2">
                    <div class="card"><h3>Resumo de Cadastros</h3><ul style="list-style: none; padding:0; margin-top:10px;"><li>üçï Sabores de Pizza: <strong id="dashboard-num-receitas">0</strong></li><li>üì¶ Itens em Estoque: <strong id="dash-stock-count">0</strong></li></ul></div>
                    <div class="card"><h3>‚ö†Ô∏è Alertas de Estoque</h3><div id="stock-alerts" style="margin-top:10px;"></div></div>
                </div>
            </section>

            <!-- 2. INDICADORES MENSAIS -->
            <section id="indicadores-mensais-view" class="view">
                <div class="flex-header"><div class="title-blue-bg">Indicadores Financeiros Mensais</div><div><button id="btn-export-pdf" class="btn btn-export">üìÑ Baixar PDF</button><button id="btn-export-excel" class="btn btn-export">üìä Baixar Excel</button></div></div>
                <div style="overflow-x: auto;"><table id="ind-mensais-table"><thead><tr><th>M√™s</th><th>Lucro L√≠quido</th><th>Margem L√≠quida (%)</th><th>Markup Realizado (%)</th></tr></thead><tbody></tbody></table></div>
            </section>

            <!-- 3. VENDAS DI√ÅRIAS -->
            <section id="vendas-diarias-view" class="view">
                <div class="card"><h2>Registrar Pedidos/Venda Di√°rios</h2><div class="form-group"><label>Data do Movimento</label><input type="date" id="venda-data" required></div>
                    <div class="grid-container grid-2">
                        <div style="background: #fff3e0; padding: 15px; border-radius: 8px;"><h3>üçï Venda de Pizzas</h3><div class="form-group"><label>Sabor (Receita)</label><select id="venda-pizza-select"><option value="">Selecione...</option></select></div><div class="form-row"><div class="form-group"><label>Qtd</label><input type="number" id="venda-pizza-qtd" value="1" min="1"></div><div class="form-group"><label>Valor Total (R$)</label><input type="number" id="venda-pizza-valor" step="0.01"></div></div><button class="btn btn-primary" id="btn-add-pizza-sale">Adicionar Pizza</button></div>
                        <div style="background: #e3f2fd; padding: 15px; border-radius: 8px;"><h3>ü•§ Venda de Produtos (Revenda)</h3><div class="form-group"><label>Produto</label><select id="venda-produto-select"><option value="">Selecione...</option></select></div><div class="form-row"><div class="form-group"><label>Qtd</label><input type="number" id="venda-produto-qtd" value="1" min="1"></div><div class="form-group"><label>Valor Total (R$)</label><input type="number" id="venda-produto-valor" step="0.01"></div></div><button class="btn btn-info" id="btn-add-prod-sale">Adicionar Produto</button></div>
                    </div>
                    <h3 style="margin-top: 20px;">Itens lan√ßados no dia <span id="display-data-selecionada"></span>:</h3><table id="sales-table"><thead><tr><th>Tipo</th><th>Item</th><th>Qtd</th><th>Valor</th><th>A√ß√£o</th></tr></thead><tbody></tbody></table><div class="total-cost" id="daily-total-display">Total do Dia: R$ 0,00</div>
                    <!-- BUTTON REMOVED HERE -->
                </div>
            </section>

            <!-- 4. MENSAL (INPUT) -->
            <section id="custos-mensais-view" class="view">
                <div class="card">
                    <h2>Fechamento Mensal (Dados Brutos)</h2>
                    <!-- Adicionado ID ao form -->
                    <form id="custo-mensal-form">
                        <input type="hidden" id="custo-mensal-id">
                        <div class="form-row">
                            <div class="form-group"><label for="custo-mensal-mes">M√™s/Ano</label><input type="month" id="custo-mensal-mes" required></div>
                            <div class="form-group" style="display:flex; align-items:end;"><button type="button" id="btn-pull-daily" class="btn btn-info">üîÑ Puxar do Di√°rio</button></div>
                        </div>
                        <div class="checkbox-wrapper"><input type="checkbox" id="enable-manual-edit"><label for="enable-manual-edit"><strong>Habilitar Edi√ß√£o Manual</strong></label></div>
                        <div class="form-row"><div class="form-group"><label>Faturamento (R$)</label><input type="number" id="custo-mensal-faturamento" step="0.01" required disabled></div><div class="form-group"><label>Custos Vari√°veis (R$)</label><input type="number" id="custo-mensal-custosVariaveis" step="0.01" disabled></div></div><div class="form-row"><div class="form-group"><label>Custos Fixos (R$)</label><input type="number" id="custo-mensal-custosFixos" step="0.01" disabled></div><div class="form-group"><label>Desp. Operacionais (R$)</label><input type="number" id="custo-mensal-despesasOperacionais" step="0.01" disabled></div></div><div class="form-row"><div class="form-group"><label>Impostos (R$)</label><input type="number" id="custo-mensal-impostos" step="0.01" disabled></div><div class="form-group"><label>Outras Rec/Desp (R$)</label><input type="number" id="custo-mensal-outrasReceitasDespesas" step="0.01" disabled></div></div><button type="submit" class="btn btn-primary">Salvar M√™s</button>
                    </form>
                </div>
                <div class="card"><h2>Hist√≥rico Mensal</h2><table id="custos-mensais-table"><thead><tr><th>M√™s</th><th>Faturamento</th><th>Lucro L√≠quido</th><th>A√ß√µes</th></tr></thead><tbody></tbody></table></div>
            </section>

            <!-- 5. LISTA DE COMPRAS -->
            <section id="lista-compras-view" class="view"><div class="card"><h2>üõí Sugest√£o de Compras</h2><div class="filter-container"><button id="btn-generate-shopping" class="btn btn-primary">Gerar Lista Atualizada</button><button id="btn-print-shopping" class="btn btn-secondary">Imprimir PDF</button></div><table id="shopping-list-table"><thead><tr><th>Item</th><th>Tipo</th><th>Estoque Atual</th><th>M√≠nimo</th><th>Ideal</th><th>Comprar</th></tr></thead><tbody></tbody></table></div></section>
            <!-- 6. PRODUTOS -->
            <section id="produtos-view" class="view"><div class="card"><h2>Cadastrar Produto (Revenda)</h2><form id="produto-form"><input type="hidden" id="produto-id"><div class="form-row"><div class="form-group"><label>Nome</label><input type="text" id="prod-nome" required></div><div class="form-group"><label>Categoria</label><select id="prod-categoria"><option value="Bebida">Bebida</option><option value="Sobremesa">Sobremesa</option><option value="Outro">Outro</option></select></div></div><div class="form-row"><div class="form-group"><label>Fornecedor</label><select id="prod-fornecedor-select"><option value="">Selecione</option></select></div></div><div class="form-row"><div class="form-group"><label>Pre√ßo Compra (R$)</label><input type="number" id="prod-custo" step="0.01" required></div><div class="form-group"><label>Pre√ßo Venda (R$)</label><input type="number" id="prod-venda" step="0.01" required></div><div class="form-group"><label>Unidade</label><select id="prod-unidade"><option value="un">Unidade</option><option value="lt">Lata</option><option value="gf">Garrafa</option></select></div></div><h3>Controle de Estoque</h3><div class="form-row"><div class="form-group"><label>Atual</label><input type="number" id="prod-est-atual" value="0"></div><div class="form-group"><label>M√≠nimo</label><input type="number" id="prod-est-min" value="10"></div><div class="form-group"><label>Ideal</label><input type="number" id="prod-est-ideal" value="50"></div></div><button type="submit" class="btn btn-primary">Salvar Produto</button><button type="button" id="cancel-edit-produto" class="btn btn-secondary hidden" style="margin-top: 0.5rem;">Cancelar Edi√ß√£o</button></form></div><div class="card"><h2>Lista de Produtos</h2><table id="produtos-table"><thead><tr><th>Nome</th><th>Fornecedor</th><th>Venda</th><th>Estoque</th><th>A√ß√µes</th></tr></thead><tbody></tbody></table></div></section>
            <!-- 7. INSUMOS -->
            <section id="insumos-view" class="view"><div class="card"><h2>Cadastrar Insumo</h2><form id="insumo-form"><input type="hidden" id="insumo-id"><div class="form-row"><div class="form-group"><label>Nome</label><input type="text" id="insumo-nome" required></div><div class="form-group"><label>Fornecedor</label><select id="insumo-fornecedor-select" required><option value="">-- Selecione --</option></select></div></div><div class="form-row"><div class="form-group"><label>Custo Emb. (R$)</label><input type="number" id="insumo-custo-embalagem" step="0.01" required></div><div class="form-group"><label>Qtd. Emb.</label><input type="number" id="insumo-qtd-embalagem" step="0.01" required></div><div class="form-group"><label>Unidade</label><select id="insumo-unidade-embalagem" required><option value="kg">kg</option><option value="g">g</option><option value="L">L</option><option value="ml">ml</option><option value="un">un</option></select></div></div><h3 style="margin-top:10px; border-top:1px solid #eee; padding-top:10px;">Controle de Estoque</h3><div class="form-row"><div class="form-group"><label>Atual</label><input type="number" id="insumo-est-atual" value="0"></div><div class="form-group"><label>M√≠nimo</label><input type="number" id="insumo-est-min" value="0"></div><div class="form-group"><label>Ideal</label><input type="number" id="insumo-est-ideal" value="0"></div></div><div class="form-row"><div class="form-group"><label>Validade</label><input type="date" id="insumo-validade"></div></div><button type="submit" class="btn btn-primary">Salvar Insumo</button><button type="button" id="cancel-edit-insumo" class="btn btn-secondary hidden" style="margin-top: 0.5rem;">Cancelar Edi√ß√£o</button></form></div><div class="card"><h2>Insumos</h2><div class="filter-container"><input type="text" id="insumos-filter" placeholder="Filtrar..."></div><table id="insumos-table"><thead><tr><th>Nome</th><th>Custo Base</th><th>Estoque</th><th>A√ß√µes</th></tr></thead><tbody></tbody></table></div></section>
            <!-- 8. RECEITAS -->
            <section id="receitas-view" class="view"><div class="card"><h2>Criar Receita</h2><form id="receita-form"><input type="hidden" id="receita-id"><div class="form-row"><div class="form-group"><label>Nome</label><input type="text" id="receita-nome" required></div><div class="form-group"><label>Pre√ßo Venda (R$)</label><input type="number" id="receita-venda" step="0.01"></div></div><h3>Ingredientes</h3><div id="ingredients-list"></div><button type="button" id="add-ingredient-btn" class="btn btn-secondary btn-small">Adicionar Ingrediente</button><div class="total-cost" id="custo-total-ingredientes">Custo: R$ 0,00</div><button type="submit" class="btn btn-primary" style="margin-top:10px;">Salvar Receita</button><button type="button" id="cancel-edit-receita" class="btn btn-secondary hidden">Cancelar Edi√ß√£o</button></form></div><div class="card"><h2>Receitas</h2><table id="receitas-table"><thead><tr><th>Nome</th><th>Custo (COGS)</th><th>Venda</th><th>A√ß√µes</th></tr></thead><tbody></tbody></table></div></section>
            <!-- 9. FORNECEDORES -->
            <section id="fornecedores-view" class="view"><div class="card"><h2 id="fornecedor-form-title">Cadastrar Fornecedor</h2><form id="fornecedor-form"><input type="hidden" id="fornecedor-id"><div class="form-row"><div class="form-group"><label>Nome da Empresa</label><input type="text" id="fornecedor-nome" required placeholder="Ex: Distribuidora Queijos"></div><div class="form-group"><label>Pessoa de Contato</label><input type="text" id="fornecedor-contato" placeholder="Ex: Sr. Jo√£o"></div></div><div class="form-row"><div class="form-group"><label>Telefone / WhatsApp</label><input type="tel" id="fornecedor-telefone" placeholder="(99) 99999-9999"></div><div class="form-group"><label>Email</label><input type="email" id="fornecedor-email" placeholder="contato@fornecedor.com"></div></div><div class="form-group"><label>Endere√ßo Completo</label><input type="text" id="fornecedor-endereco" placeholder="Rua, N√∫mero, Bairro, Cidade"></div><button type="submit" class="btn btn-primary">Salvar Fornecedor</button><button type="button" id="cancel-edit-fornecedor" class="btn btn-secondary hidden" style="margin-top: 0.5rem;">Cancelar Edi√ß√£o</button></form></div><div class="card"><h2>Lista de Fornecedores</h2><div class="table-container"><table id="fornecedores-table"><thead><tr><th>Empresa</th><th>Contato</th><th>Telefone</th><th>Endere√ßo</th><th class="actions-cell">A√ß√µes</th></tr></thead><tbody></tbody></table></div></div><div class="card" style="margin-top:20px;border:1px solid red;"><h3 style="color:red;">Zona de Perigo</h3><p>Apagar TODOS os fornecedores?</p><button id="btn-zerar-fornecedores" class="btn btn-danger">ZERAR TODOS OS FORNECEDORES</button></div></section>
            <!-- 10. CONFIGURA√á√ïES -->
            <section id="configuracoes-view" class="view">
                <div class="card">
                    <h2>Configura√ß√µes Gerais</h2>
                    <form id="configuracoes-form">
                        <div class="form-group"><label>Custo M√£o de Obra (R$/hora)</label><input type="number" id="config-custo-hora-mao-de-obra" step="0.01"></div>
                        <div class="form-group"><label>Rateio Fixo (R$/pizza)</label><input type="number" id="config-rateio-despesas-fixas" step="0.01"></div>
                        <div class="form-group"><label>Meta CMV Padr√£o (%)</label><input type="number" id="config-meta-cmv-padrao" step="0.1"></div>
                        <div class="form-group"><label>Alerta Varia√ß√£o Pre√ßo (%)</label><input type="number" id="config-alerta-variacao" step="1" value="10"></div>
                        
                        <!-- NOVA CONFIGURA√á√ÉO DE BLOQUEIO DE ESTOQUE -->
                        <div class="checkbox-wrapper" style="background-color: #fff3e0; border: 1px solid #ffcc80; color: #d84315;">
                            <input type="checkbox" id="config-controlar-estoque">
                            <label for="config-controlar-estoque"><strong>üö´ Bloquear Venda se Estoque Insuficiente</strong></label>
                        </div>

                        <button type="submit" class="btn btn-primary">Salvar Configura√ß√µes</button>
                    </form>
                </div>
                <div class="card backup-area"><h3>üíæ Backup e Restaura√ß√£o</h3><p>Salve seus dados no computador ou restaure um backup.</p><div style="display:flex; gap:10px; flex-wrap:wrap;"><button id="btn-backup-download" class="btn btn-info">‚¨áÔ∏è Fazer Backup Completo</button><button id="btn-backup-restore-click" class="btn btn-warning">‚¨ÜÔ∏è Restaurar Backup</button><input type="file" id="backup-file-input" accept=".json" class="hidden"></div></div>
            </section>
        </div>
    </main>

    <footer><p>Pizzaria Cost Control Pro v6.10 (Auth Restored + Immediate Logic)</p></footer>
    <div id="toast" class="toast"></div>
    <div id="confirm-modal" class="modal"><div class="modal-content" style="text-align: center;"><p id="confirm-modal-text">Confirmar?</p><div class="modal-buttons"><button id="confirm-modal-yes" class="btn btn-danger">Sim</button><button id="confirm-modal-no" class="btn btn-secondary">N√£o</button></div></div></div>

    <!-- SCRIPTS -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const firebaseConfig = { apiKey: "AIzaSyBDB5DaXGXRWQQKVgG1bh_1WcsbfZti6uo", authDomain: "cmv-pizza.firebaseapp.com", projectId: "cmv-pizza", storageBucket: "cmv-pizza.firebasestorage.app", messagingSenderId: "1022435006716", appId: "1:1022435006716:web:ec39f22702097beca25f79" };
        let firebaseApp, auth, db, currentUser;
        let isLocalMode = false;
        let localData = { fornecedores:[], insumos:[], receitas:[], produtos:[], vendasDiarias:[], custosMensais:[] };
        let cache = { fornecedores:[], insumos:[], receitas:[], produtos:[], vendasDiarias:[], custosMensais:[] };
        let configCache = {};
        let itemParaExcluir = null;
        let dailySalesBuffer = [];
        const COLLECTIONS_LIST = ['fornecedores', 'insumos', 'produtos', 'receitas', 'vendasDiarias', 'custosMensais'];

        if (firebaseConfig.apiKey) {
            try { firebaseApp = firebase.initializeApp(firebaseConfig); auth = firebase.auth(); db = firebase.firestore(); auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL); setupAuthListeners(); } catch (e) { console.error(e); isLocalMode = true; initApp(); }
        } else { isLocalMode = true; initApp(); }

        function initDateAndLoad() {
            const today = new Date().toISOString().split('T')[0];
            const dateInput = document.getElementById('venda-data');
            if(dateInput) { dateInput.value = today; loadDailySales(today); }
        }
        document.getElementById('venda-data')?.addEventListener('change', (e) => loadDailySales(e.target.value));
        function loadDailySales(date) {
            document.getElementById('display-data-selecionada').textContent = date.split('-').reverse().join('/');
            dailySalesBuffer = cache.vendasDiarias.filter(v => v.data === date).map(v => ({...v})); 
            renderDailySalesTable();
        }
        const chkManual = document.getElementById('enable-manual-edit');
        if(chkManual) { chkManual.addEventListener('change', (e) => { const fields = ['custo-mensal-faturamento', 'custo-mensal-custosVariaveis','custo-mensal-custosFixos', 'custo-mensal-despesasOperacionais', 'custo-mensal-impostos', 'custo-mensal-outrasReceitasDespesas']; fields.forEach(id => { const el = document.getElementById(id); if(el) el.disabled = !e.target.checked; }); }); }

        // --- NEW: EXPANDED VIEW SWITCHER (v6.8) ---
        async function showView(id) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(id + '-view')?.classList.add('active');
            switch (id) {
                case 'dashboard': updateDashboard(); break;
                case 'vendas-diarias': populateSelects(); const currentVal = document.getElementById('venda-data').value; if(currentVal) loadDailySales(currentVal); else initDateAndLoad(); break;
                case 'custos-mensais': renderCustosMensais(); break;
                case 'indicadores-mensais': renderIndicadoresMensais(); break;
                case 'produtos': renderProdutos(); populateSelects(); break;
                case 'insumos': renderInsumos(); populateSelects(); break;
                case 'receitas': renderReceitas(); populateSelects(); break;
                case 'fornecedores': renderFornecedoresTable(); break;
                case 'configuracoes': await fetchConfiguracoes(); break;
                case 'lista-compras': break;
            }
        }
        const navLinks = document.querySelectorAll('.nav-link');
        navLinks.forEach(l => l.addEventListener('click', e => { e.preventDefault(); showView(e.target.dataset.view); }));

        // --- AUTO FILL MONTHLY FORM ---
        document.getElementById('custo-mensal-mes')?.addEventListener('change', (e) => {
            const selectedMes = e.target.value;
            if (!selectedMes) return;
            const record = cache.custosMensais.find(c => c.mes === selectedMes);
            const chk = document.getElementById('enable-manual-edit');
            if (record) {
                document.getElementById('custo-mensal-id').value = record.id;
                document.getElementById('custo-mensal-faturamento').value = record.faturamento;
                document.getElementById('custo-mensal-custosVariaveis').value = record.custosVariaveis;
                document.getElementById('custo-mensal-custosFixos').value = record.custosFixos;
                document.getElementById('custo-mensal-despesasOperacionais').value = record.despesasOperacionais;
                document.getElementById('custo-mensal-impostos').value = record.impostos;
                document.getElementById('custo-mensal-outrasReceitasDespesas').value = record.outrasReceitasDespesas;
                showToast(`Dados de ${selectedMes} carregados.`);
            } else {
                document.getElementById('custo-mensal-id').value = '';
                document.getElementById('custo-mensal-faturamento').value = '';
                document.getElementById('custo-mensal-custosVariaveis').value = '';
                document.getElementById('custo-mensal-custosFixos').value = '';
                document.getElementById('custo-mensal-despesasOperacionais').value = '';
                document.getElementById('custo-mensal-impostos').value = '';
                document.getElementById('custo-mensal-outrasReceitasDespesas').value = '';
                const hasSales = cache.vendasDiarias.some(v => v.data && v.data.startsWith(selectedMes));
                if(hasSales) showToast("Novo m√™s. Clique em 'Puxar do Di√°rio' para importar o faturamento.");
            }
            if(chk) { chk.checked = false; chk.dispatchEvent(new Event('change')); }
        });

        // --- INDICADORES MENSAIS TABLE ---
        function renderIndicadoresMensais() {
            const tbody = document.getElementById('ind-mensais-table').querySelector('tbody');
            tbody.innerHTML = '';
            if (!cache.custosMensais.length) { tbody.innerHTML = '<tr><td colspan="4">Nenhum registro mensal.</td></tr>'; return; }
            const sorted = [...cache.custosMensais].sort((a,b) => a.mes.localeCompare(b.mes));
            sorted.forEach(c => {
                const [ano, mes] = c.mes.split('-');
                const mesFormatado = `${mes}/${ano}`;
                const custoTotal = (c.custosVariaveis||0) + (c.custosFixos||0) + (c.despesasOperacionais||0) + (c.impostos||0);
                const lucro = (c.faturamento||0) - custoTotal + (c.outrasReceitasDespesas||0);
                const margem = c.faturamento > 0 ? (lucro / c.faturamento) * 100 : 0;
                const markup = custoTotal > 0 ? (((c.faturamento - custoTotal) / custoTotal) * 100) : 0;
                tbody.innerHTML += `<tr><td class="ind-val-white">${mesFormatado}</td><td class="ind-val-blue">${formatMoney(lucro)}</td><td class="ind-val-blue">${margem.toFixed(2)}%</td><td class="ind-val-blue">${markup.toFixed(2)}%</td></tr>`;
            });
        }

        document.getElementById('btn-export-pdf')?.addEventListener('click', () => { const { jsPDF } = window.jspdf; const doc = new jsPDF(); doc.text("Indicadores Mensais - Pizzaria Cost Control", 14, 15); doc.autoTable({ html: '#ind-mensais-table', startY: 20, theme: 'striped', headStyles: { fillColor: [0, 91, 150] } }); doc.save('indicadores_mensais.pdf'); });
        document.getElementById('btn-export-excel')?.addEventListener('click', () => { let csvContent = "data:text/csv;charset=utf-8,Mes;Lucro Liquido;Margem Liquida;Markup Realizado\r\n"; const sorted = [...cache.custosMensais].sort((a,b) => a.mes.localeCompare(b.mes)); sorted.forEach(c => { const custoTotal = (c.custosVariaveis||0) + (c.custosFixos||0) + (c.despesasOperacionais||0) + (c.impostos||0); const lucro = (c.faturamento||0) - custoTotal + (c.outrasReceitasDespesas||0); const margem = c.faturamento > 0 ? (lucro / c.faturamento) * 100 : 0; const markup = custoTotal > 0 ? (((c.faturamento - custoTotal) / custoTotal) * 100) : 0; const row = `${c.mes};${lucro.toFixed(2)};${margem.toFixed(2)}%;${markup.toFixed(2)}%`; csvContent += row + "\r\n"; }); const encodedUri = encodeURI(csvContent); const link = document.createElement("a"); link.setAttribute("href", encodedUri); link.setAttribute("download", "indicadores_mensais.csv"); document.body.appendChild(link); link.click(); link.remove(); });

        // --- CORE FUNCTIONS ---
        const confirmModal = document.getElementById('confirm-modal');
        const btnYes = document.getElementById('confirm-modal-yes');
        const btnNo = document.getElementById('confirm-modal-no');
        btnYes.addEventListener('click', async () => {
            if (itemParaExcluir && itemParaExcluir.id) {
                btnYes.textContent = "Excluindo..."; btnYes.disabled = true;
                try {
                    await deleteData(itemParaExcluir.collection, itemParaExcluir.id);
                    const coll = itemParaExcluir.collection;
                    if (!isLocalMode) cache[coll] = cache[coll].filter(i => i.id !== itemParaExcluir.id);
                    await fetchData(coll);
                    if(coll === 'fornecedores') { renderFornecedoresTable(); populateSelects(); }
                    else if(coll === 'produtos') { renderProdutos(); populateSelects(); updateDashboard(); }
                    else if(coll === 'insumos') { renderInsumos(); populateSelects(); updateDashboard(); }
                    else if(coll === 'receitas') { renderReceitas(); populateSelects(); updateDashboard(); }
                    else if(coll === 'custosMensais') { renderCustosMensais(); renderIndicadoresMensais(); updateDashboard(); } 
                    else if(coll === 'vendasDiarias') { updateDashboard(); }
                    showToast('Exclu√≠do com sucesso!', 'success');
                } catch (e) { console.error(e); showToast('Erro: ' + e.message, 'error'); } 
                finally { confirmModal.style.display = 'none'; btnYes.textContent = "Sim"; btnYes.disabled = false; itemParaExcluir = null; }
            }
        });
        btnNo.addEventListener('click', () => { confirmModal.style.display = 'none'; itemParaExcluir = null; });
        function confirmDelete(coll, id) {
            if (!id) return;
            itemParaExcluir = { collection: coll, id: id };
            document.getElementById('confirm-modal-text').textContent = "Tem certeza?";
            confirmModal.style.display = 'block';
        }

        function setupAuthListeners() { auth.onAuthStateChanged(user => { if(user) { currentUser = user; document.getElementById('auth-container').classList.add('hidden'); document.getElementById('app-container').classList.remove('hidden'); document.getElementById('app-nav').classList.remove('hidden'); initApp(); } else { currentUser = null; document.getElementById('auth-container').classList.remove('hidden'); document.getElementById('app-container').classList.add('hidden'); } }); document.getElementById('login-form').addEventListener('submit', e => { e.preventDefault(); auth.signInWithEmailAndPassword(document.getElementById('login-email').value, document.getElementById('login-password').value).catch(e=>showToast(e.message,'error')); }); document.getElementById('logout-button').addEventListener('click', () => auth.signOut()); }
        async function initApp() { if(isLocalMode) currentUser = {uid:'local'}; await Promise.all([fetchConfiguracoes(), ...COLLECTIONS_LIST.map(c => fetchData(c))]); renderAll(); initDateAndLoad(); }
        async function fetchData(coll) { if(isLocalMode) { cache[coll] = localData[coll] || []; return; } cache[coll] = []; const snap = await db.collection(coll).where('userId','==',currentUser.uid).get(); cache[coll] = snap.docs.map(d => ({id:d.id, ...d.data()})); }
        async function fetchFullDataForBackup(coll) { if(isLocalMode) return localData[coll] || []; const snap = await db.collection(coll).where('userId','==',currentUser.uid).get(); return snap.docs.map(d => ({id:d.id, ...d.data()})); }
        async function saveData(coll, data) { data.userId = currentUser.uid; try { if(isLocalMode) { if(!localData[coll]) localData[coll] = []; if(data.id) { const idx = localData[coll].findIndex(i=>i.id===data.id); if(idx>-1) localData[coll][idx] = data; else localData[coll].push(data); } else { data.id = Date.now().toString(); localData[coll].push(data); } } else { if(data.id) await db.collection(coll).doc(data.id).set(data, { merge: true }); else { delete data.id; await db.collection(coll).add(data); } } return true; } catch(e) { console.error(e); showToast("Erro ao salvar", "error"); return false; } }
        async function deleteData(coll, id) { if(!id) return false; if(isLocalMode) localData[coll] = localData[coll].filter(i=>i.id!==id); else await db.collection(coll).doc(id).delete(); return true; }

        function renderAll() { renderFornecedoresTable(); renderInsumos(); renderProdutos(); renderReceitas(); renderCustosMensais(); renderIndicadoresMensais(); populateSelects(); updateDashboard(); }

        // --- SMART STOCK LOGIC (NEW v6.6 - Unit Conversion Fixed) ---
        function getVirtualStock(type, id) {
            let item, actualStock;
            if (type === 'product') {
                item = cache.produtos.find(p => p.id === id);
                actualStock = parseFloat(item ? item.estoque_atual : 0) || 0;
            } else {
                item = cache.insumos.find(i => i.id === id);
                actualStock = parseFloat(item ? item.estoque_atual : 0) || 0;
            }
            return actualStock;
        }

        async function deductStock(item) {
            if(item.tipo === 'Produto') {
                const prod = cache.produtos.find(p => p.id === item.itemId);
                if(prod) {
                    prod.estoque_atual = (parseFloat(prod.estoque_atual)||0) - parseFloat(item.qtd);
                    await saveData('produtos', prod);
                }
            } else if(item.tipo === 'Pizza') {
                const receita = cache.receitas.find(r => r.id === item.itemId);
                if(receita && receita.ingredientes) {
                    for(const ing of receita.ingredientes) {
                        const insumo = cache.insumos.find(i => i.id === ing.id);
                        if(insumo) {
                            let amountUsed = parseFloat(ing.qtd);
                            // Conversion Logic
                            if (insumo.unidade_embalagem === 'kg' || insumo.unidade_embalagem === 'L') {
                                amountUsed = amountUsed / 1000;
                            }
                            amountUsed = amountUsed * parseFloat(item.qtd);
                            
                            insumo.estoque_atual = (parseFloat(insumo.estoque_atual)||0) - amountUsed;
                            await saveData('insumos', insumo);
                        }
                    }
                }
            }
        }

        async function restockItem(item) {
            if(item.tipo === 'Produto') {
                const prod = cache.produtos.find(p => p.id === item.itemId);
                if(prod) {
                    prod.estoque_atual = (parseFloat(prod.estoque_atual)||0) + parseFloat(item.qtd);
                    await saveData('produtos', prod);
                }
            } else if(item.tipo === 'Pizza') {
                const receita = cache.receitas.find(r => r.id === item.itemId);
                if(receita && receita.ingredientes) {
                    for(const ing of receita.ingredientes) {
                        const insumo = cache.insumos.find(i => i.id === ing.id);
                        if(insumo) {
                            let amountUsed = parseFloat(ing.qtd);
                            // Conversion Logic
                            if (insumo.unidade_embalagem === 'kg' || insumo.unidade_embalagem === 'L') {
                                amountUsed = amountUsed / 1000;
                            }
                            amountUsed = amountUsed * parseFloat(item.qtd);

                            insumo.estoque_atual = (parseFloat(insumo.estoque_atual)||0) + amountUsed;
                            await saveData('insumos', insumo);
                        }
                    }
                }
            }
        }
        // -------------------------------------

        function updateDashboard() {
            document.getElementById('dashboard-num-receitas').textContent = cache.receitas.length;
            document.getElementById('dash-stock-count').textContent = cache.insumos.length + cache.produtos.length;
            
            const alertsDiv = document.getElementById('stock-alerts');
            let alertsHtml = '';
            cache.insumos.forEach(i => { if((parseFloat(i.estoque_atual)||0) <= (parseFloat(i.estoque_min)||0)) alertsHtml += `<div class="alert-item cmv-danger">‚ö†Ô∏è Insumo <strong>${i.nome}</strong> baixo (Atual: ${i.estoque_atual})</div>`; });
            cache.produtos.forEach(p => { if((parseFloat(p.estoque_atual)||0) <= (parseFloat(p.estoque_min)||0)) alertsHtml += `<div class="alert-item cmv-danger">‚ö†Ô∏è Produto <strong>${p.nome}</strong> baixo (Atual: ${p.estoque_atual})</div>`; });
            if(alertsHtml === '') alertsHtml = '<p class="stock-ok">‚úÖ Tudo certo com o estoque.</p>';
            alertsDiv.innerHTML = alertsHtml;

            const costs = cache.custosMensais;
            const totalFat = costs.reduce((acc, c) => acc + (c.faturamento||0), 0);
            const totalVar = costs.reduce((acc, c) => acc + (c.custosVariaveis||0), 0);
            const totalFix = costs.reduce((acc, c) => acc + (c.custosFixos||0) + (c.despesasOperacionais||0) + (c.impostos||0), 0);
            const totalOutras = costs.reduce((acc, c) => acc + (c.outrasReceitasDespesas||0), 0);
            const totalLucro = totalFat - (totalVar + totalFix) + totalOutras;
            const margem = totalFat > 0 ? ((totalLucro / totalFat) * 100) : 0;

            const totalVendasValor = cache.vendasDiarias.reduce((acc, v) => acc + (parseFloat(v.valor)||0), 0);
            const totalItensQtd = cache.vendasDiarias.reduce((acc, v) => acc + (parseFloat(v.qtd)||0), 0);
            const ticketMedio = totalItensQtd > 0 ? (totalVendasValor / totalItensQtd) : 0;

            document.getElementById('dash-fat-total').textContent = formatMoney(totalFat);
            document.getElementById('dash-lucro-total').textContent = formatMoney(totalLucro);
            document.getElementById('dash-margem').textContent = margem.toFixed(2) + '%';
            document.getElementById('dash-cmv-total').textContent = formatMoney(totalVar);
            document.getElementById('dash-custo-fixo').textContent = formatMoney(totalFix);
            document.getElementById('dash-ticket-medio').textContent = formatMoney(ticketMedio);

            const lucroEl = document.getElementById('dash-lucro-total');
            const margemEl = document.getElementById('dash-margem');
            if(totalLucro >= 0) { lucroEl.style.color = 'var(--success-color)'; margemEl.style.color = 'var(--success-color)'; }
            else { lucroEl.style.color = 'var(--error-color)'; margemEl.style.color = 'var(--error-color)'; }

            const actionContainer = document.getElementById('action-plan-container');
            let actions = '';
            if(margem < 15 && totalFat > 0) actions += `<div class="action-box"><div class="action-title">üìâ Margem L√≠quida Abaixo da Meta</div><p>Sua margem atual √© de <strong>${margem.toFixed(2)}%</strong> (Meta sugerida: >15%).</p><div class="action-sug"><strong>A√ß√£o Sugerida:</strong> Revise o CMV. Verifique se os pre√ßos de insumos subiram e reajuste o pre√ßo de venda.</div></div>`;
            const cmvPerc = totalFat > 0 ? (totalVar / totalFat) * 100 : 0;
            if(cmvPerc > 40) actions += `<div class="action-box"><div class="action-title">‚ö†Ô∏è Custos Vari√°veis Elevados (CMV)</div><p>Seus custos vari√°veis representam <strong>${cmvPerc.toFixed(2)}%</strong> do faturamento.</p><div class="action-sug"><strong>A√ß√£o Sugerida:</strong> Controle o desperd√≠cio na cozinha. Verifique o porcionamento das receitas.</div></div>`;
            if(totalLucro > 0 && margem > 20) actions += `<div class="action-box" style="border-left: 4px solid var(--success-color);"><div class="action-title">üöÄ Excelente Desempenho</div><p>Parab√©ns! Sua opera√ß√£o est√° saud√°vel.</p><div class="action-sug"><strong>A√ß√£o Sugerida:</strong> Reinvista em marketing para aumentar o Ticket M√©dio.</div></div>`;
            if(actions === '') actions = '<p style="color:#777; font-style:italic;">Nenhum alerta cr√≠tico no momento.</p>';
            actionContainer.innerHTML = actions;
        }

        document.getElementById('btn-pull-daily')?.addEventListener('click', () => {
            const mesAno = document.getElementById('custo-mensal-mes').value;
            if (!mesAno) { showToast("Selecione o M√™s/Ano primeiro.", "error"); return; }
            const vendasDoMes = cache.vendasDiarias.filter(v => v.data && v.data.startsWith(mesAno));
            const totalFaturamento = vendasDoMes.reduce((acc, curr) => acc + (parseFloat(curr.valor) || 0), 0);
            const chkManual = document.getElementById('enable-manual-edit'); if(chkManual) { chkManual.checked = true; chkManual.dispatchEvent(new Event('change')); }
            if(vendasDoMes.length === 0) { showToast("Nenhuma venda encontrada.", "error"); } else { document.getElementById('custo-mensal-faturamento').value = totalFaturamento.toFixed(2); showToast(`Importado: ${formatMoney(totalFaturamento)}`); }
        });

        document.getElementById('custo-mensal-form').addEventListener('submit', async e => {
            e.preventDefault();
            const id = document.getElementById('custo-mensal-id').value;
            const mes = document.getElementById('custo-mensal-mes').value;
            const duplicado = cache.custosMensais.find(c => c.mes === mes && c.id !== id);
            if (duplicado) { showToast(`O m√™s ${mes} j√° possui um fechamento lan√ßado! Edite o existente.`, 'error'); return; }
            const data = { id: id || null, mes: mes, faturamento: parseFloat(document.getElementById('custo-mensal-faturamento').value) || 0, custosVariaveis: parseFloat(document.getElementById('custo-mensal-custosVariaveis').value) || 0, custosFixos: parseFloat(document.getElementById('custo-mensal-custosFixos').value) || 0, despesasOperacionais: parseFloat(document.getElementById('custo-mensal-despesasOperacionais').value) || 0, impostos: parseFloat(document.getElementById('custo-mensal-impostos').value) || 0, outrasReceitasDespesas: parseFloat(document.getElementById('custo-mensal-outrasReceitasDespesas').value) || 0 };
            if(await saveData('custosMensais', data)) { await fetchData('custosMensais'); renderCustosMensais(); renderIndicadoresMensais(); updateDashboard(); document.getElementById('custo-mensal-form').reset(); document.getElementById('custo-mensal-id').value=''; showToast('Fechamento salvo!'); }
        });

        function renderCustosMensais() {
            const tbody = document.getElementById('custos-mensais-table').querySelector('tbody'); tbody.innerHTML = '';
            if (!cache.custosMensais.length) { tbody.innerHTML = '<tr><td colspan="4">Nenhum registro.</td></tr>'; return; }
            const sorted = [...cache.custosMensais].sort((a,b) => a.mes.localeCompare(b.mes));
            sorted.forEach(c => {
                const lucro = c.faturamento - (c.custosVariaveis + c.custosFixos + c.despesasOperacionais + c.impostos) + c.outrasReceitasDespesas;
                const colorClass = lucro >= 0 ? 'stock-ok' : 'stock-warning'; 
                const [ano, mes] = c.mes.split('-');
                tbody.innerHTML += `<tr><td>${mes}/${ano}</td><td>${formatMoney(c.faturamento)}</td><td class="${colorClass}" style="font-weight:bold;">${formatMoney(lucro)}</td><td><button class="btn btn-secondary btn-small btn-edit-mensal" data-id="${c.id}">‚úé</button><button class="btn btn-danger btn-small btn-delete-mensal" data-id="${c.id}" style="margin-left: 5px;">üóë</button></td></tr>`;
            });
        }
        function editMensal(id) {
            const c = cache.custosMensais.find(x => x.id === id); if(!c) return;
            document.getElementById('custo-mensal-id').value = c.id; document.getElementById('custo-mensal-mes').value = c.mes; document.getElementById('custo-mensal-faturamento').value = c.faturamento; document.getElementById('custo-mensal-custosVariaveis').value = c.custosVariaveis; document.getElementById('custo-mensal-custosFixos').value = c.custosFixos; document.getElementById('custo-mensal-despesasOperacionais').value = c.despesasOperacionais; document.getElementById('custo-mensal-impostos').value = c.impostos; document.getElementById('custo-mensal-outrasReceitasDespesas').value = c.outrasReceitasDespesas;
            const chk = document.getElementById('enable-manual-edit'); if(chk) { chk.checked = true; chk.dispatchEvent(new Event('change')); }
            document.getElementById('custo-mensal-form').scrollIntoView({behavior:'smooth'});
        }

        document.getElementById('btn-generate-shopping').addEventListener('click', () => { const tbody = document.getElementById('shopping-list-table').querySelector('tbody'); tbody.innerHTML = ''; let count = 0; cache.insumos.forEach(item => { const atual = parseFloat(item.estoque_atual) || 0; const ideal = parseFloat(item.estoque_ideal) || 0; const min = parseFloat(item.estoque_min) || 0; if (ideal > 0 && atual < ideal) { const qtdToBuy = ideal - atual; tbody.innerHTML += `<tr><td>${item.nome}</td><td>Insumo</td><td>${atual}</td><td>${min}</td><td>${ideal}</td><td style="font-weight:bold; color: var(--primary-color)">${qtdToBuy.toFixed(2)}</td></tr>`; count++; } }); cache.produtos.forEach(item => { const atual = parseFloat(item.estoque_atual) || 0; const ideal = parseFloat(item.estoque_ideal) || 0; const min = parseFloat(item.estoque_min) || 0; if (ideal > 0 && atual < ideal) { const qtdToBuy = ideal - atual; tbody.innerHTML += `<tr><td>${item.nome}</td><td>Produto</td><td>${atual}</td><td>${min}</td><td>${ideal}</td><td style="font-weight:bold; color: var(--primary-color)">${qtdToBuy.toFixed(2)}</td></tr>`; count++; } }); if (count === 0) { tbody.innerHTML = '<tr><td colspan="6" style="text-align:center">Estoque em dia! Nada para comprar.</td></tr>'; } showToast(`${count} itens na lista de compras.`); });
        document.getElementById('btn-print-shopping').addEventListener('click', () => { const { jsPDF } = window.jspdf; const doc = new jsPDF(); doc.text("Lista de Compras - Pizzaria Cost Control", 14, 15); doc.autoTable({ html: '#shopping-list-table', startY: 20, theme: 'grid' }); doc.save('lista_compras.pdf'); });

        const pizzaSelect = document.getElementById('venda-pizza-select'); const pizzaQtd = document.getElementById('venda-pizza-qtd'); const pizzaVal = document.getElementById('venda-pizza-valor'); function calcPizzaTotal() { const id = pizzaSelect.value; const qtd = parseFloat(pizzaQtd.value) || 0; if(!id) { pizzaVal.value = ''; return; } const receita = cache.receitas.find(r => r.id === id); if(receita && receita.preco_venda) { pizzaVal.value = (parseFloat(receita.preco_venda) * qtd).toFixed(2); } }
        pizzaSelect.addEventListener('change', calcPizzaTotal); pizzaQtd.addEventListener('input', calcPizzaTotal);
        const prodSelect = document.getElementById('venda-produto-select'); const prodQtd = document.getElementById('venda-produto-qtd'); const prodVal = document.getElementById('venda-produto-valor'); function calcProdTotal() { const id = prodSelect.value; const qtd = parseFloat(prodQtd.value) || 0; if(!id) { prodVal.value = ''; return; } const produto = cache.produtos.find(p => p.id === id); if(produto && produto.preco_venda) { prodVal.value = (parseFloat(produto.preco_venda) * qtd).toFixed(2); } }
        prodSelect.addEventListener('change', calcProdTotal); prodQtd.addEventListener('input', calcProdTotal);
        function renderDailySalesTable() { const tbody = document.getElementById('sales-table').querySelector('tbody'); tbody.innerHTML = ''; let total = 0; dailySalesBuffer.forEach((item, index) => { total += item.valor; tbody.innerHTML += `<tr><td>${item.tipo}</td><td>${item.nome}</td><td>${item.qtd}</td><td>${formatMoney(item.valor)}</td><td><button class="btn btn-danger btn-small" onclick="removeSaleItem('${item.id}')">X</button></td></tr>`; }); document.getElementById('daily-total-display').textContent = 'Total do Dia: ' + formatMoney(total); }
        
        // --- IMMEDIATE REMOVE & RESTOCK ---
        window.removeSaleItem = async function(id) { 
            if(!confirm("Estornar venda e devolver ao estoque?")) return;
            const item = cache.vendasDiarias.find(v => v.id === id);
            if(item) {
                await restockItem(item); 
                await deleteData('vendasDiarias', id); 
                await fetchData('vendasDiarias'); 
                loadDailySales(document.getElementById('venda-data').value);
                updateDashboard(); 
                showToast("Venda estornada."); 
            }
        };

        // --- ADD BUTTON LOGIC (UPDATED v6.7 - IMMEDIATE ACTION) ---
        document.getElementById('btn-add-pizza-sale').addEventListener('click', async () => {
            const id = pizzaSelect.value; 
            const qtd = parseFloat(pizzaQtd.value); 
            const val = parseFloat(pizzaVal.value); 
            if(!id || !qtd || !val) { showToast("Preencha todos os campos", "error"); return; } 
            
            const receita = cache.receitas.find(r => r.id === id);

            // CHECK STOCK
            if(configCache.controlar_estoque) {
                let missing = [];
                if(receita && receita.ingredientes) {
                    receita.ingredientes.forEach(ing => {
                        let needed = (parseFloat(ing.qtd) * qtd);
                        let insumo = cache.insumos.find(i => i.id === ing.id);
                        if (insumo && (insumo.unidade_embalagem === 'kg' || insumo.unidade_embalagem === 'L')) { needed = needed / 1000; }
                        let available = getVirtualStock('insumo', ing.id); // getVirtualStock actually just gets current stock in v6.7 context
                        if(available < needed) {
                            let insName = insumo ? insumo.nome : 'Desconhecido';
                            missing.push(`- ${insName}: Precisa ${needed.toFixed(2)}, Disp. ${available.toFixed(2)}`);
                        }
                    });
                }
                if(missing.length > 0) { alert("‚ö†Ô∏è ESTOQUE INSUFICIENTE!\n\n" + missing.join("\n")); return; }
            }

            const saleItem = { tipo: 'Pizza', itemId: id, nome: receita ? receita.nome : '?', qtd: qtd, valor: val, data: document.getElementById('venda-data').value };
            
            await saveData('vendasDiarias', saleItem);
            await deductStock(saleItem);
            
            await fetchData('vendasDiarias'); 
            loadDailySales(saleItem.data); 
            updateDashboard();
            
            pizzaSelect.value = ''; pizzaQtd.value = 1; pizzaVal.value = ''; 
            showToast("Venda registrada e estoque baixado!");
        });

        document.getElementById('btn-add-prod-sale').addEventListener('click', async () => { 
            const id = prodSelect.value; 
            const qtd = parseFloat(prodQtd.value); 
            const val = parseFloat(prodVal.value); 
            if(!id || !qtd || !val) { showToast("Preencha todos os campos", "error"); return; } 
            
            const produto = cache.produtos.find(p => p.id === id); 

            // CHECK STOCK
            if(configCache.controlar_estoque) {
                let available = getVirtualStock('product', id);
                if(available < qtd) {
                    let prodName = produto ? produto.nome : 'Produto';
                    alert(`‚ö†Ô∏è ESTOQUE INSUFICIENTE!\n\n- ${prodName}: Precisa ${qtd}, Disp. ${available.toFixed(2)}`);
                    return;
                }
            }

            const saleItem = { tipo: 'Produto', itemId: id, nome: produto ? produto.nome : '?', qtd: qtd, valor: val, data: document.getElementById('venda-data').value };
            
            await saveData('vendasDiarias', saleItem);
            await deductStock(saleItem);
            
            await fetchData('vendasDiarias');
            loadDailySales(saleItem.data);
            updateDashboard();

            prodSelect.value = ''; prodQtd.value = 1; prodVal.value = ''; 
            showToast("Venda registrada e estoque baixado!");
        });
        
        // CRUD & HELPERS (Same as before)
        function renderFornecedoresTable() { const tbody = document.getElementById('fornecedores-table').querySelector('tbody'); tbody.innerHTML = ''; if (!cache.fornecedores.length) { tbody.innerHTML = '<tr><td colspan="5">Vazio.</td></tr>'; return; } [...cache.fornecedores].sort((a,b)=>(a.nome||"").localeCompare(b.nome||"")).forEach(f => { if(!f.id) return; tbody.innerHTML += `<tr><td>${f.nome}</td><td>${f.contato||''}</td><td>${f.telefone||''}</td><td>${f.endereco||''}</td><td class="actions-cell"><button class="btn btn-secondary btn-small btn-edit-fornecedor" data-id="${f.id}">‚úé</button> <button class="btn btn-danger btn-small btn-delete-fornecedor" data-id="${f.id}">üóë</button></td></tr>`; }); }
        function editFornecedor(id) { const f = cache.fornecedores.find(i => i.id === id); if (!f) return; showView('fornecedores'); document.getElementById('fornecedor-id').value = f.id; document.getElementById('fornecedor-nome').value = f.nome; document.getElementById('fornecedor-contato').value = f.contato||''; document.getElementById('fornecedor-telefone').value = f.telefone||''; document.getElementById('fornecedor-email').value = f.email||''; document.getElementById('fornecedor-endereco').value = f.endereco||''; document.getElementById('fornecedor-form-title').textContent = 'Editar Fornecedor'; document.getElementById('cancel-edit-fornecedor').classList.remove('hidden'); document.getElementById('fornecedor-form').scrollIntoView({behavior:'smooth'}); }
        document.getElementById('fornecedor-form').addEventListener('submit', async e => { e.preventDefault(); const data = { id: document.getElementById('fornecedor-id').value || null, nome: document.getElementById('fornecedor-nome').value, contato: document.getElementById('fornecedor-contato').value, telefone: document.getElementById('fornecedor-telefone').value, email: document.getElementById('fornecedor-email').value, endereco: document.getElementById('fornecedor-endereco').value }; if(await saveData('fornecedores', data)) { await fetchData('fornecedores'); renderFornecedoresTable(); populateSelects(); document.getElementById('fornecedor-form').reset(); document.getElementById('fornecedor-id').value=''; document.getElementById('cancel-edit-fornecedor').classList.add('hidden'); showToast('Salvo!'); } });
        document.getElementById('cancel-edit-fornecedor').addEventListener('click', () => { document.getElementById('fornecedor-form').reset(); document.getElementById('fornecedor-id').value=''; document.getElementById('cancel-edit-fornecedor').classList.add('hidden'); });
        function renderProdutos() { const tb = document.getElementById('produtos-table').querySelector('tbody'); tb.innerHTML = ''; cache.produtos.forEach(p => { const f=cache.fornecedores.find(x=>x.id===p.fornecedorId)?.nome||'-'; tb.innerHTML += `<tr><td>${p.nome}</td><td>${f}</td><td>${formatMoney(p.preco_venda)}</td><td>${p.estoque_atual||0}</td><td class="actions-cell"><button class="btn btn-secondary btn-small btn-edit-produto" data-id="${p.id}">‚úé</button> <button class="btn btn-danger btn-small btn-delete-produto" data-id="${p.id}">üóë</button></td></tr>`; }); }
        function editProduto(id) { const p = cache.produtos.find(i => i.id === id); if (!p) return; showView('produtos'); document.getElementById('produto-id').value = p.id; document.getElementById('prod-nome').value = p.nome; document.getElementById('prod-categoria').value = p.categoria; document.getElementById('prod-fornecedor-select').value = p.fornecedorId; document.getElementById('prod-custo').value = p.preco_compra; document.getElementById('prod-venda').value = p.preco_venda; document.getElementById('prod-unidade').value = p.unidade; document.getElementById('prod-est-atual').value = p.estoque_atual; document.getElementById('prod-est-min').value = p.estoque_min; document.getElementById('prod-est-ideal').value = p.estoque_ideal; document.getElementById('cancel-edit-produto').classList.remove('hidden'); document.getElementById('produto-form').scrollIntoView({behavior:'smooth'}); }
        document.getElementById('produto-form').addEventListener('submit', async e => { e.preventDefault(); await saveData('produtos', { id:document.getElementById('produto-id').value||null, nome:document.getElementById('prod-nome').value, categoria:document.getElementById('prod-categoria').value, fornecedorId:document.getElementById('prod-fornecedor-select').value, preco_compra:parseFloat(document.getElementById('prod-custo').value), preco_venda:parseFloat(document.getElementById('prod-venda').value), unidade:document.getElementById('prod-unidade').value, estoque_atual:parseFloat(document.getElementById('prod-est-atual').value), estoque_min:parseFloat(document.getElementById('prod-est-min').value), estoque_ideal:parseFloat(document.getElementById('prod-est-ideal').value) }); document.getElementById('produto-form').reset(); document.getElementById('produto-id').value=''; document.getElementById('cancel-edit-produto').classList.add('hidden'); await fetchData('produtos'); renderProdutos(); populateSelects(); updateDashboard(); showToast('Salvo!'); });
        document.getElementById('cancel-edit-produto').addEventListener('click', () => { document.getElementById('produto-form').reset(); document.getElementById('produto-id').value=''; document.getElementById('cancel-edit-produto').classList.add('hidden'); });
        function renderInsumos() { const tb = document.getElementById('insumos-table').querySelector('tbody'); tb.innerHTML = ''; cache.insumos.forEach(i => { const cb = i.qtd_embalagem_g>0?(i.custo_embalagem/i.qtd_embalagem_g):0; tb.innerHTML += `<tr><td>${i.nome}</td><td>${formatMoney(cb)}/${i.unidade_base}</td><td>${i.estoque_atual||0}</td><td class="actions-cell"><button class="btn btn-secondary btn-small btn-edit-insumo" data-id="${i.id}">‚úé</button> <button class="btn btn-danger btn-small btn-delete-insumo" data-id="${i.id}">üóë</button></td></tr>`; }); }
        function editInsumo(id) { const i = cache.insumos.find(x => x.id === id); if (!i) return; showView('insumos'); document.getElementById('insumo-id').value = i.id; document.getElementById('insumo-nome').value = i.nome; document.getElementById('insumo-fornecedor-select').value = i.fornecedorId; document.getElementById('insumo-custo-embalagem').value = i.custo_embalagem; document.getElementById('insumo-qtd-embalagem').value = i.quantidade_embalagem; document.getElementById('insumo-unidade-embalagem').value = i.unidade_embalagem; document.getElementById('insumo-est-atual').value = i.estoque_atual; document.getElementById('insumo-est-min').value = i.estoque_min; document.getElementById('insumo-est-ideal').value = i.estoque_ideal; if(i.validade) document.getElementById('insumo-validade').value = i.validade; document.getElementById('cancel-edit-insumo').classList.remove('hidden'); document.getElementById('insumo-form').scrollIntoView({behavior:'smooth'}); }
        document.getElementById('insumo-form').addEventListener('submit', async e => { e.preventDefault(); const q=parseFloat(document.getElementById('insumo-qtd-embalagem').value), u=document.getElementById('insumo-unidade-embalagem').value; let qg=q, b='un'; if(u==='kg'||u==='L'){qg=q*1000;b=u==='kg'?'g':'ml'} else if(u==='g'||u==='ml'){b=u} await saveData('insumos', { id:document.getElementById('insumo-id').value||null, nome:document.getElementById('insumo-nome').value, fornecedorId:document.getElementById('insumo-fornecedor-select').value, custo_embalagem:parseFloat(document.getElementById('insumo-custo-embalagem').value), quantidade_embalagem:q, unidade_embalagem:u, qtd_embalagem_g:qg, unidade_base:b, estoque_atual:parseFloat(document.getElementById('insumo-est-atual').value), estoque_min:parseFloat(document.getElementById('insumo-est-min').value), estoque_ideal:parseFloat(document.getElementById('insumo-est-ideal').value) }); document.getElementById('insumo-form').reset(); document.getElementById('insumo-id').value=''; document.getElementById('cancel-edit-insumo').classList.add('hidden'); await fetchData('insumos'); renderInsumos(); populateSelects(); updateDashboard(); showToast('Salvo!'); });
        document.getElementById('cancel-edit-insumo').addEventListener('click', () => { document.getElementById('insumo-form').reset(); document.getElementById('insumo-id').value=''; document.getElementById('cancel-edit-insumo').classList.add('hidden'); });
        function updateReceitaTotal() { let total = 0; document.querySelectorAll('.ingredient-row').forEach(row => { const id = row.querySelector('.ing-select').value; const qty = parseFloat(row.querySelector('.ing-qtd').value) || 0; const insumo = cache.insumos.find(i => i.id === id); if (insumo && insumo.qtd_embalagem_g > 0) { const pricePerUnit = insumo.custo_embalagem / insumo.qtd_embalagem_g; total += pricePerUnit * qty; } }); document.getElementById('custo-total-ingredientes').textContent = 'Custo: ' + formatMoney(total); }
        function addReceitaRow(ingId = '', qtyVal = 1) { const div = document.createElement('div'); div.className='ingredient-row'; div.innerHTML = `<select class="ing-select"><option value="">Insumo...</option>${cache.insumos.map(i=>`<option value="${i.id}">${i.nome}</option>`).join('')}</select><input type="number" class="ing-qtd" placeholder="Qtd (g/ml/un)" value="${qtyVal}"><button type="button" class="btn btn-danger btn-small remove-ing-btn">X</button>`; if(ingId) div.querySelector('.ing-select').value = ingId; const select = div.querySelector('.ing-select'); const input = div.querySelector('.ing-qtd'); const btn = div.querySelector('.remove-ing-btn'); select.addEventListener('change', updateReceitaTotal); input.addEventListener('input', updateReceitaTotal); btn.addEventListener('click', () => { div.remove(); updateReceitaTotal(); }); document.getElementById('ingredients-list').appendChild(div); updateReceitaTotal(); }
        document.getElementById('add-ingredient-btn').addEventListener('click', () => addReceitaRow());
        function renderReceitas() { const tb = document.getElementById('receitas-table').querySelector('tbody'); tb.innerHTML = ''; cache.receitas.forEach(r => { let custoReceita = 0; if(r.ingredientes) { r.ingredientes.forEach(ing => { const ins = cache.insumos.find(i => i.id === ing.id); if(ins && ins.qtd_embalagem_g > 0) { const unitCost = ins.custo_embalagem / ins.qtd_embalagem_g; custoReceita += unitCost * ing.qtd; } }); } tb.innerHTML += `<tr><td>${r.nome}</td><td>${formatMoney(custoReceita)}</td><td>${formatMoney(r.preco_venda)}</td><td class="actions-cell"><button class="btn btn-secondary btn-small btn-edit-receita" data-id="${r.id}">‚úé</button> <button class="btn btn-danger btn-small btn-delete-receita" data-id="${r.id}">üóë</button></td></tr>`; }); }
        function editReceita(id) { const r = cache.receitas.find(x => x.id === id); if (!r) return; showView('receitas'); document.getElementById('receita-id').value = r.id; document.getElementById('receita-nome').value = r.nome; document.getElementById('receita-venda').value = r.preco_venda || ''; const list = document.getElementById('ingredients-list'); list.innerHTML = ''; if (r.ingredientes && Array.isArray(r.ingredientes)) { r.ingredientes.forEach(ing => { addReceitaRow(ing.id, ing.qtd); }); } updateReceitaTotal(); document.getElementById('cancel-edit-receita').classList.remove('hidden'); document.getElementById('receita-form').scrollIntoView({behavior:'smooth'}); }
        document.getElementById('receita-form').addEventListener('submit', async e => { e.preventDefault(); const rows = document.querySelectorAll('.ingredient-row'); const ings = []; rows.forEach(r => { const id = r.querySelector('.ing-select').value; const qtd = parseFloat(r.querySelector('.ing-qtd').value); if(id && qtd>0) ings.push({id, qtd}); }); await saveData('receitas', { id: document.getElementById('receita-id').value || null, nome: document.getElementById('receita-nome').value, preco_venda: parseFloat(document.getElementById('receita-venda').value) || 0, ingredientes: ings }); document.getElementById('receita-form').reset(); document.getElementById('receita-id').value = ''; document.getElementById('ingredients-list').innerHTML = ''; document.getElementById('cancel-edit-receita').classList.add('hidden'); document.getElementById('custo-total-ingredientes').textContent = 'Custo: R$ 0,00'; await fetchData('receitas'); renderReceitas(); populateSelects(); updateDashboard(); showToast('Salvo!'); });
        document.getElementById('cancel-edit-receita').addEventListener('click', () => { document.getElementById('receita-form').reset(); document.getElementById('receita-id').value = ''; document.getElementById('ingredients-list').innerHTML = ''; document.getElementById('cancel-edit-receita').classList.add('hidden'); document.getElementById('custo-total-ingredientes').textContent = 'Custo: R$ 0,00'; });
        async function fetchConfiguracoes(){
            if(isLocalMode) configCache=localData.configuracoes||{};
            else{
                try{ const doc=await db.collection('configuracoes').doc(currentUser.uid).get(); configCache=doc.exists?doc.data():{}; }catch(e){}
            }
            displayConfiguracoes();
        }
        function displayConfiguracoes(){
            Object.keys(configCache).forEach(k => {
                const id = `config-${k.replace(/_/g,'-')}`;
                const el = document.getElementById(id);
                if(el) {
                    if(el.type === 'checkbox') el.checked = configCache[k];
                    else el.value=configCache[k];
                }
            });
        }
        document.getElementById('configuracoes-form').addEventListener('submit', async e => {
            e.preventDefault();
            const data = {
                custo_hora_mao_de_obra: parseFloat(document.getElementById('config-custo-hora-mao-de-obra').value) || 0,
                rateio_despesas_fixas: parseFloat(document.getElementById('config-rateio-despesas-fixas').value) || 0,
                meta_cmv_padrao: parseFloat(document.getElementById('config-meta-cmv-padrao').value) || 0,
                alerta_variacao: parseFloat(document.getElementById('config-alerta-variacao').value) || 0,
                controlar_estoque: document.getElementById('config-controlar-estoque').checked
            };
            if(isLocalMode) localData.configuracoes=data; 
            else await db.collection('configuracoes').doc(currentUser.uid).set(data);
            configCache=data; 
            showToast("Salvo!");
        });
        document.getElementById('btn-backup-download').addEventListener('click', async () => { if(!currentUser && !isLocalMode) return; const backupPayload = { timestamp: new Date(), configuracoes: configCache || {} }; for(const coll of COLLECTIONS_LIST) { backupPayload[coll] = await fetchFullDataForBackup(coll); } const url = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(backupPayload)); const a = document.createElement('a'); a.href = url; a.download = `backup_pizzaria_${new Date().toISOString().split('T')[0]}.json`; document.body.appendChild(a); a.click(); a.remove(); });
        document.getElementById('btn-backup-restore-click').addEventListener('click', () => { if(confirm("ATEN√á√ÉO: Restaurar o backup apagar√° os dados atuais e substituir√° pelo arquivo. Deseja continuar?")) { document.getElementById('backup-file-input').click(); } });
        document.getElementById('backup-file-input').addEventListener('change', async (e) => { const file = e.target.files[0]; if(!file) return; const reader = new FileReader(); reader.onload = async (ev) => { try { const d = JSON.parse(ev.target.result); if(!d.fornecedores && !d.produtos && !d.insumos) throw new Error("Arquivo inv√°lido ou vazio."); showToast("Iniciando restaura√ß√£o...", "info"); if(!isLocalMode) { if(d.configuracoes) await db.collection('configuracoes').doc(currentUser.uid).set(d.configuracoes); for(const collName of COLLECTIONS_LIST) { const snapshot = await db.collection(collName).where('userId','==',currentUser.uid).get(); if (!snapshot.empty) { const batch = db.batch(); snapshot.docs.forEach(doc => batch.delete(doc.ref)); await batch.commit(); } if(d[collName] && Array.isArray(d[collName]) && d[collName].length > 0) { for(const item of d[collName]) { item.userId = currentUser.uid; if(item.id) await db.collection(collName).doc(item.id).set(item, {merge: true}); else await db.collection(collName).add(item); } } } } else { localData.configuracoes = d.configuracoes || {}; for(const collName of COLLECTIONS_LIST) { localData[collName] = d[collName] || []; } } await initApp(); showToast("Restaura√ß√£o conclu√≠da com sucesso!", "success"); } catch(err){ console.error(err); showToast("Erro na restaura√ß√£o: " + err.message, "error"); } finally { e.target.value = ''; } }; reader.readAsText(file); });
        document.body.addEventListener('click', e => { const btn = e.target.closest('button'); if (!btn) return; const id = btn.dataset.id; 
            if(btn.classList.contains('btn-edit-fornecedor')) { e.preventDefault(); editFornecedor(id); } 
            else if(btn.classList.contains('btn-edit-produto')) { e.preventDefault(); editProduto(id); } 
            else if(btn.classList.contains('btn-edit-insumo')) { e.preventDefault(); editInsumo(id); } 
            else if(btn.classList.contains('btn-edit-receita')) { e.preventDefault(); editReceita(id); } 
            else if(btn.classList.contains('btn-edit-mensal')) { e.preventDefault(); editMensal(id); } 
            else if(btn.classList.contains('btn-delete-fornecedor')) { e.preventDefault(); confirmDelete('fornecedores', id); } 
            else if(btn.classList.contains('btn-delete-insumo')) { e.preventDefault(); confirmDelete('insumos', id); } 
            else if(btn.classList.contains('btn-delete-produto')) { e.preventDefault(); confirmDelete('produtos', id); } 
            else if(btn.classList.contains('btn-delete-receita')) { e.preventDefault(); confirmDelete('receitas', id); } 
            else if(btn.classList.contains('btn-delete-mensal')) { e.preventDefault(); confirmDelete('custosMensais', id); } 
        });
        function formatMoney(v) { return parseFloat(v||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'}); }
        function showToast(msg, type='success') { const t = document.getElementById('toast'); t.textContent=msg; t.className=`toast ${type} show`; setTimeout(()=>t.classList.remove('show'),3000); }
        function populateSelects() { const fOpts = '<option value="">Selecione</option>' + [...cache.fornecedores].sort((a,b)=>(a.nome||"").localeCompare(b.nome||"")).map(f=>`<option value="${f.id}">${f.nome}</option>`).join(''); document.getElementById('insumo-fornecedor-select').innerHTML = fOpts; document.getElementById('prod-fornecedor-select').innerHTML = fOpts; const pizzas = cache.receitas; if(pizzas.length > 0) { document.getElementById('venda-pizza-select').innerHTML = '<option value="">Selecione</option>'+pizzas.map(r=>`<option value="${r.id}">${r.nome}</option>`).join(''); } else { document.getElementById('venda-pizza-select').innerHTML = '<option value="">(Nenhuma receita cadastrada)</option>'; } const produtos = cache.produtos; if(produtos.length > 0) { document.getElementById('venda-produto-select').innerHTML = '<option value="">Selecione</option>'+produtos.map(p=>`<option value="${p.id}">${p.nome}</option>`).join(''); } else { document.getElementById('venda-produto-select').innerHTML = '<option value="">(Nenhum produto cadastrado)</option>'; } }
        const navLinks = document.querySelectorAll('.nav-link');
        function showView(id) { document.querySelectorAll('.view').forEach(v=>v.classList.remove('active')); document.getElementById(id+'-view')?.classList.add('active'); if(id === 'vendas-diarias') { populateSelects(); } }
        navLinks.forEach(l=>l.addEventListener('click', e=>{e.preventDefault(); showView(e.target.dataset.view);}));
        document.getElementById('btn-zerar-fornecedores')?.addEventListener('click', async () => { if(!confirm("Apagar TODOS?")) return; const s = await db.collection('fornecedores').where('userId','==',currentUser.uid).get(); const b = db.batch(); s.docs.forEach(d=>b.delete(d.ref)); await b.commit(); await fetchData('fornecedores'); renderAll(); showToast('Apagado'); });
    });
    </script>
</body>
</html>