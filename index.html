<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de CMV para Pizzaria</title>

    <!-- BIBLIOTECAS EXTERNAS (CDN) -->
    <!-- Firebase v9 -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

    <!-- Relatórios PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>

    <!-- Relatórios Excel (XLSX) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        /* CSS GERAL */
        :root {
            --primary-color: #D32F2F;
            --secondary-color: #FFC107;
            --dark-color: #212121;
            --light-color: #FFFFFF;
            --gray-color: #f4f4f4;
        }

        body {
            font-family: Arial, sans-serif;
            margin: 0;
            background-color: var(--gray-color);
            color: var(--dark-color);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: auto;
            padding: 20px;
        }

        /* ESTILOS DE AUTENTICAÇÃO */
        #auth-container {
            max-width: 400px;
            margin: 50px auto;
            padding: 20px;
            background: var(--light-color);
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        /* ESTILOS DO APP PRINCIPAL */
        #app-container {
            display: none; /* Inicia oculto */
        }

        header {
            background: var(--dark-color);
            color: var(--light-color);
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        header h1 {
            margin: 0;
            font-size: 1.5rem;
        }

        nav {
            background: var(--primary-color);
            padding: 0.5rem 1rem;
        }

        nav button {
            background: none;
            border: none;
            color: var(--light-color);
            padding: 10px 15px;
            cursor: pointer;
            font-size: 1rem;
            transition: background 0.3s;
        }

        nav button:hover, nav button.active {
            background: rgba(0,0,0,0.2);
        }

        /* UTILITÁRIOS */
        .hidden { display: none !important; }

        input, select, button {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
            border: 1px solid #ccc;
            box-sizing: border-box;
        }

        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
        }

        button:hover {
            opacity: 0.9;
        }

        .button-secondary {
            background-color: var(--secondary-color);
            color: var(--dark-color);
        }

        .card {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th, td {
            padding: 12px;
            border: 1px solid #ddd;
            text-align: left;
        }

        th {
            background-color: var(--dark-color);
            color: white;
        }

        /* RESPONSIVIDADE */
        @media (max-width: 768px) {
            nav {
                display: flex;
                flex-direction: column;
            }
            header {
                flex-direction: column;
                text-align: center;
            }
        }
    </style>
</head>
<body>

    <!-- TELA DE AUTENTICAÇÃO -->
    <div id="auth-container">
        <div id="login-view">
            <h2>Login</h2>
            <form id="login-form">
                <input type="email" id="login-email" placeholder="Email" required>
                <input type="password" id="login-password" placeholder="Senha" required>
                <button type="submit">Entrar</button>
            </form>
            <p>Não tem uma conta? <a href="#" id="show-register">Registre-se</a></p>
            <p><a href="#" id="show-forgot-password">Esqueci minha senha</a></p>
        </div>

        <div id="register-view" class="hidden">
            <h2>Registrar</h2>
            <form id="register-form">
                <input type="email" id="register-email" placeholder="Email" required>
                <input type="password" id="register-password" placeholder="Senha" required>
                <button type="submit">Registrar</button>
            </form>
            <p>Já tem uma conta? <a href="#" id="show-login">Faça login</a></p>
        </div>
        
        <div id="forgot-password-view" class="hidden">
            <h2>Recuperar Senha</h2>
            <form id="forgot-password-form">
                <input type="email" id="forgot-password-email" placeholder="Digite seu email" required>
                <button type="submit">Enviar Link de Recuperação</button>
            </form>
             <p><a href="#" id="back-to-login">Voltar para o Login</a></p>
        </div>
    </div>

    <!-- APLICATIVO PRINCIPAL -->
    <div id="app-container" class="container">
        <header>
            <h1>Calculadora de CMV</h1>
            <div>
                <span id="user-email"></span>
                <button id="logout-btn" class="button-secondary">Sair</button>
            </div>
        </header>

        <nav>
            <button class="nav-btn active" data-target="dashboard-section">Dashboard</button>
            <button class="nav-btn" data-target="insumos-section">Insumos</button>
            <button class="nav-btn" data-target="receitas-section">Receitas</button>
            <button class="nav-btn" data-target="simulador-section">Simulador de Preço</button>
            <button class="nav-btn" data-target="relatorios-section">Relatórios</button>
            <button class="nav-btn" data-target="configuracoes-section">Configurações</button>
        </nav>

        <main>
            <!-- SEÇÃO DASHBOARD -->
            <section id="dashboard-section" class="app-section">
                <div class="card">
                    <h2>Dashboard</h2>
                    <p>Bem-vindo! Em breve, gráficos e KPIs estarão disponíveis aqui.</p>
                </div>
            </section>

            <!-- SEÇÃO INSUMOS -->
            <section id="insumos-section" class="app-section hidden">
                 <div class="card">
                    <h2>Gerenciar Insumos</h2>
                    <form id="insumo-form">
                        <input type="hidden" id="insumo-id">
                        <input type="text" id="insumo-nome" placeholder="Nome do Insumo" required>
                        <input type="text" id="insumo-fornecedor" placeholder="Fornecedor">
                        <input type="number" step="0.01" id="insumo-custo" placeholder="Custo da Embalagem (R$)" required>
                        <input type="number" step="0.01" id="insumo-qtd" placeholder="Quantidade na Embalagem" required>
                        <select id="insumo-unidade">
                            <option value="g">Gramas (g)</option>
                            <option value="kg">Quilogramas (kg)</option>
                            <option value="ml">Mililitros (ml)</option>
                            <option value="l">Litros (l)</option>
                            <option value="un">Unidade (un)</option>
                        </select>
                        <button type="submit">Salvar Insumo</button>
                    </form>
                </div>
                <div class="card">
                    <h3>Lista de Insumos</h3>
                    <table id="insumos-table">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Custo Unitário</th>
                                <th>Fornecedor</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </section>

            <!-- SEÇÃO RECEITAS -->
            <section id="receitas-section" class="app-section hidden">
                <div class="card">
                    <h2>Gerenciar Receitas (Ficha Técnica)</h2>
                    <form id="receita-form">
                        <input type="hidden" id="receita-id">
                        <input type="text" id="receita-nome" placeholder="Nome da Pizza (Ex: Margherita v1)" required>
                        
                        <h3>Ingredientes</h3>
                        <div id="ingredientes-container">
                            <!-- Ingredientes serão adicionados dinamicamente aqui -->
                        </div>
                        <button type="button" id="add-ingrediente-btn">Adicionar Ingrediente</button>
                        
                        <hr style="margin: 20px 0;">

                        <h3>Outros Custos</h3>
                        <input type="number" step="0.01" id="receita-embalagem-custo" placeholder="Custo da Embalagem (R$)" required>
                        
                        <button type="submit" style="margin-top: 20px;">Salvar Receita</button>
                    </form>
                </div>
                 <div class="card">
                    <h3>Lista de Receitas</h3>
                    <table id="receitas-table">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Custo Total (COGS)</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </section>

            <!-- SEÇÃO SIMULADOR -->
            <section id="simulador-section" class="app-section hidden">
                <div class="card">
                    <h2>Simulador de Preço de Venda</h2>
                    <label for="simulador-receita-select">Selecione uma Receita:</label>
                    <select id="simulador-receita-select"></select>
                    
                    <h3 id="simulador-cogs-resultado">Custo da Pizza (COGS): R$ 0.00</h3>
                    
                    <label for="simulador-meta-cmv">Meta de CMV (%):</label>
                    <input type="number" id="simulador-meta-cmv" value="30">
                    <h3 id="simulador-preco-sugerido">Preço de Venda Sugerido: R$ 0.00</h3>
                </div>
            </section>

            <!-- SEÇÃO RELATÓRIOS -->
            <section id="relatorios-section" class="app-section hidden">
                <div class="card">
                    <h2>Exportar Relatórios</h2>
                    <p>Selecione uma receita para gerar relatórios detalhados.</p>
                    <select id="relatorio-receita-select"></select>
                    <br>
                    <button id="export-pdf-btn">Exportar Detalhes para PDF</button>
                    <button id="export-xlsx-btn" class="button-secondary">Exportar Detalhes para XLSX</button>
                </div>
            </section>

            <!-- SEÇÃO CONFIGURAÇÕES -->
            <section id="configuracoes-section" class="app-section hidden">
                <div class="card">
                    <h2>Configurações Gerais</h2>
                    <form id="config-form">
                        <label for="config-mao-de-obra">Custo da Mão de Obra (R$ por hora):</label>
                        <input type="number" step="0.01" id="config-mao-de-obra" value="20.00">
                        
                        <label for="config-tempo-pizza">Tempo de Preparo por Pizza (minutos):</label>
                        <input type="number" id="config-tempo-pizza" value="8">

                        <label for="config-rateio">Rateio de Custos Indiretos (R$ por pizza):</label>
                        <input type="number" step="0.01" id="config-rateio" value="0.80">
                        
                        <button type="submit">Salvar Configurações</button>
                    </form>
                </div>
            </section>

        </main>
    </div>

<script>
    // --- CONFIGURAÇÃO DO FIREBASE ---
    // ATENÇÃO: O erro (auth/api-key-not-valid) acontece se estas chaves não forem substituídas.
    // Copie o objeto de configuração do seu projeto Firebase aqui.
	
// Your web app's Firebase configuration

const firebaseConfig = {
  apiKey: "AIzaSyBDB5DaXGXRWQQKVgG1bh_1WcsbfZti6uo",
  authDomain: "cmv-pizza.firebaseapp.com",
  projectId: "cmv-pizza",
  storageBucket: "cmv-pizza.firebasestorage.app",
  messagingSenderId: "1022435006716",
  appId: "1:1022435006716:web:ec39f22702097beca25f79"
};

    // Inicializa o Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // --- LÓGICA DO APLICATIVO ---
    document.addEventListener('DOMContentLoaded', () => {

        // Referências aos elementos da UI
        const authContainer = document.getElementById('auth-container');
        const appContainer = document.getElementById('app-container');
        const userEmailSpan = document.getElementById('user-email');
        const logoutBtn = document.getElementById('logout-btn');
        
        const loginView = document.getElementById('login-view');
        const registerView = document.getElementById('register-view');
        const forgotPasswordView = document.getElementById('forgot-password-view');
        
        let currentUser = null;
        let userConfig = {
            custo_hora_mao_de_obra: 20.00,
            tempo_preparo_minutos: 8,
            rateio_overhead_por_pizza: 0.80
        };

        // --- GERENCIAMENTO DE AUTENTICAÇÃO ---
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                authContainer.classList.add('hidden');
                appContainer.style.display = 'block';
                userEmailSpan.textContent = user.email;
                loadInitialData();
            } else {
                currentUser = null;
                authContainer.classList.remove('hidden');
                appContainer.style.display = 'none';
                userEmailSpan.textContent = '';
            }
        });
        
        // Navegação entre telas de autenticação
        document.getElementById('show-register').addEventListener('click', (e) => {
            e.preventDefault();
            loginView.classList.add('hidden');
            forgotPasswordView.classList.add('hidden');
            registerView.classList.remove('hidden');
        });

        document.getElementById('show-login').addEventListener('click', (e) => {
            e.preventDefault();
            registerView.classList.add('hidden');
            forgotPasswordView.classList.add('hidden');
            loginView.classList.remove('hidden');
        });
        
         document.getElementById('show-forgot-password').addEventListener('click', (e) => {
            e.preventDefault();
            loginView.classList.add('hidden');
            registerView.classList.add('hidden');
            forgotPasswordView.classList.remove('hidden');
        });

        document.getElementById('back-to-login').addEventListener('click', (e) => {
            e.preventDefault();
            forgotPasswordView.classList.add('hidden');
            registerView.classList.add('hidden');
            loginView.classList.remove('hidden');
        });

        // Event Listeners dos formulários de auth
        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            auth.signInWithEmailAndPassword(email, password)
                .catch(error => alert(`Erro no login: ${error.message}`));
        });

        document.getElementById('register-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            auth.createUserWithEmailAndPassword(email, password)
                .catch(error => alert(`Erro no registro: ${error.message}`));
        });

        document.getElementById('forgot-password-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('forgot-password-email').value;
            auth.sendPasswordResetEmail(email)
                .then(() => alert('Link de recuperação enviado para o seu email!'))
                .catch(error => alert(`Erro: ${error.message}`));
        });

        logoutBtn.addEventListener('click', () => auth.signOut());

        // --- NAVEGAÇÃO INTERNA DO APP ---
        const navButtons = document.querySelectorAll('.nav-btn');
        const sections = document.querySelectorAll('.app-section');

        navButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                navButtons.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                sections.forEach(sec => sec.classList.add('hidden'));
                document.getElementById(btn.dataset.target).classList.remove('hidden');
            });
        });
        
        // --- FUNÇÕES DE CÁLCULO ---
        function calculateCogs(receita, insumos) {
            if (!receita || !userConfig) return 0;

            let custoIngredientes = 0;
            receita.ingredientes.forEach(item => {
                const insumo = insumos.find(i => i.id === item.insumoId);
                if (insumo) {
                    const custoPorGrama = insumo.custo / insumo.qtd;
                    custoIngredientes += custoPorGrama * item.quantidade_g;
                }
            });

            const custoMaoDeObra = (userConfig.custo_hora_mao_de_obra / 60) * userConfig.tempo_preparo_minutos;
            const custoEmbalagem = parseFloat(receita.custo_embalagem) || 0;
            const custoRateio = parseFloat(userConfig.rateio_overhead_por_pizza) || 0;
            
            return custoIngredientes + custoMaoDeObra + custoEmbalagem + custoRateio;
        }

        // Lógica para carregar todos os dados iniciais
        async function loadInitialData() {
            if (!currentUser) return;
            await loadConfig();
            await loadInsumos();
            await loadReceitas();
        }

        // --- CONFIGURAÇÕES ---
        const configForm = document.getElementById('config-form');
        async function loadConfig() {
            const doc = await db.collection('config').doc(currentUser.uid).get();
            if (doc.exists) {
                userConfig = doc.data();
            } else {
                // Salva configuração padrão se não existir
                 await db.collection('config').doc(currentUser.uid).set(userConfig);
            }
            document.getElementById('config-mao-de-obra').value = userConfig.custo_hora_mao_de_obra;
            document.getElementById('config-tempo-pizza').value = userConfig.tempo_preparo_minutos;
            document.getElementById('config-rateio').value = userConfig.rateio_overhead_por_pizza;
        }
        
        configForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const newConfig = {
                custo_hora_mao_de_obra: parseFloat(document.getElementById('config-mao-de-obra').value),
                tempo_preparo_minutos: parseInt(document.getElementById('config-tempo-pizza').value),
                rateio_overhead_por_pizza: parseFloat(document.getElementById('config-rateio').value)
            };
            await db.collection('config').doc(currentUser.uid).set(newConfig);
            userConfig = newConfig;
            alert('Configurações salvas!');
            loadReceitas(); // Recalcular custos
        });

        // --- GERENCIAMENTO DE INSUMOS ---
        const insumoForm = document.getElementById('insumo-form');
        const insumosTable = document.getElementById('insumos-table').getElementsByTagName('tbody')[0];
        let insumosCache = [];

        insumoForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('insumo-id').value;
            let qtd_em_g = parseFloat(document.getElementById('insumo-qtd').value);
            const unidade = document.getElementById('insumo-unidade').value;

            if (unidade === 'kg' || unidade === 'l') {
                qtd_em_g *= 1000;
            }

            const insumoData = {
                nome: document.getElementById('insumo-nome').value,
                fornecedor: document.getElementById('insumo-fornecedor').value,
                custo: parseFloat(document.getElementById('insumo-custo').value),
                qtd: qtd_em_g,
                unidadeBase: 'g', // Sempre salvamos em gramas
                userId: currentUser.uid
            };

            if (id) {
                await db.collection('insumos').doc(id).update(insumoData);
            } else {
                await db.collection('insumos').add(insumoData);
            }

            insumoForm.reset();
            document.getElementById('insumo-id').value = '';
            loadInsumos();
        });

        async function loadInsumos() {
            insumosTable.innerHTML = '<tr><td colspan="4">Carregando...</td></tr>';
            const snapshot = await db.collection('insumos').where('userId', '==', currentUser.uid).get();
            insumosCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            
            insumosTable.innerHTML = '';
            if (insumosCache.length === 0) {
                 insumosTable.innerHTML = '<tr><td colspan="4">Nenhum insumo cadastrado.</td></tr>';
                 return;
            }
            
            insumosCache.forEach(insumo => {
                const row = insumosTable.insertRow();
                const custoUnitario = (insumo.custo / insumo.qtd).toFixed(4);
                row.innerHTML = `
                    <td>${insumo.nome}</td>
                    <td>R$ ${custoUnitario} /g</td>
                    <td>${insumo.fornecedor}</td>
                    <td>
                        <button onclick="editInsumo('${insumo.id}')">Editar</button>
                        <button onclick="deleteInsumo('${insumo.id}')">Excluir</button>
                    </td>
                `;
            });
            populateInsumosSelect();
        }

        window.editInsumo = (id) => {
            const insumo = insumosCache.find(i => i.id === id);
            document.getElementById('insumo-id').value = insumo.id;
            document.getElementById('insumo-nome').value = insumo.nome;
            document.getElementById('insumo-fornecedor').value = insumo.fornecedor;
            document.getElementById('insumo-custo').value = insumo.custo;
            // A conversão de volta para a unidade original de exibição pode ser complexa. Simplificamos para gramas.
            document.getElementById('insumo-qtd').value = insumo.qtd;
            document.getElementById('insumo-unidade').value = 'g';
        };

        window.deleteInsumo = async (id) => {
            if (confirm('Tem certeza que deseja excluir este insumo?')) {
                await db.collection('insumos').doc(id).delete();
                loadInsumos();
            }
        };

        // --- GERENCIAMENTO DE RECEITAS ---
        const receitaForm = document.getElementById('receita-form');
        const ingredientesContainer = document.getElementById('ingredientes-container');
        const addIngredienteBtn = document.getElementById('add-ingrediente-btn');
        const receitasTable = document.getElementById('receitas-table').getElementsByTagName('tbody')[0];
        let receitasCache = [];

        function populateInsumosSelect() {
            // Usado para preencher os dropdowns de ingredientes
        }

        addIngredienteBtn.addEventListener('click', () => {
            const div = document.createElement('div');
            div.classList.add('ingrediente-item');
            let options = '<option value="">Selecione um insumo</option>';
            insumosCache.forEach(i => {
                options += `<option value="${i.id}">${i.nome}</option>`;
            });

            div.innerHTML = `
                <select class="ingrediente-select" required>${options}</select>
                <input type="number" class="ingrediente-qtd" placeholder="Qtd (g)" required>
                <button type="button" onclick="this.parentElement.remove()">Remover</button>
            `;
            ingredientesContainer.appendChild(div);
        });

        receitaForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('receita-id').value;
            
            const ingredientes = [];
            document.querySelectorAll('.ingrediente-item').forEach(item => {
                const insumoId = item.querySelector('.ingrediente-select').value;
                const quantidade_g = parseFloat(item.querySelector('.ingrediente-qtd').value);
                if (insumoId && quantidade_g > 0) {
                    ingredientes.push({ insumoId, quantidade_g });
                }
            });

            const receitaData = {
                nome: document.getElementById('receita-nome').value,
                custo_embalagem: parseFloat(document.getElementById('receita-embalagem-custo').value),
                ingredientes,
                userId: currentUser.uid
            };

            if (id) {
                await db.collection('receitas').doc(id).update(receitaData);
            } else {
                await db.collection('receitas').add(receitaData);
            }
            
            receitaForm.reset();
            document.getElementById('receita-id').value = '';
            ingredientesContainer.innerHTML = '';
            loadReceitas();
        });
        
        async function loadReceitas() {
            receitasTable.innerHTML = '<tr><td colspan="3">Carregando...</td></tr>';
            const snapshot = await db.collection('receitas').where('userId', '==', currentUser.uid).get();
            receitasCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            receitasTable.innerHTML = '';
             if (receitasCache.length === 0) {
                 receitasTable.innerHTML = '<tr><td colspan="3">Nenhuma receita cadastrada.</td></tr>';
                 return;
            }

            receitasCache.forEach(receita => {
                const cogs = calculateCogs(receita, insumosCache);
                const row = receitasTable.insertRow();
                row.innerHTML = `
                    <td>${receita.nome}</td>
                    <td>R$ ${cogs.toFixed(2)}</td>
                    <td>
                        <button onclick="editReceita('${receita.id}')">Editar</button>
                        <button onclick="deleteReceita('${receita.id}')">Excluir</button>
                    </td>
                `;
            });
            updateSimuladorOptions();
        }
        
        window.deleteReceita = async (id) => {
             if (confirm('Tem certeza que deseja excluir esta receita?')) {
                await db.collection('receitas').doc(id).delete();
                loadReceitas();
            }
        }
        
        window.editReceita = (id) => {
            const receita = receitasCache.find(r => r.id === id);
            document.getElementById('receita-id').value = receita.id;
            document.getElementById('receita-nome').value = receita.nome;
            document.getElementById('receita-embalagem-custo').value = receita.custo_embalagem;
            ingredientesContainer.innerHTML = '';
            receita.ingredientes.forEach(ing => {
                addIngredienteBtn.click();
                const lastItem = ingredientesContainer.lastChild;
                lastItem.querySelector('.ingrediente-select').value = ing.insumoId;
                lastItem.querySelector('.ingrediente-qtd').value = ing.quantidade_g;
            });
            document.querySelector('.nav-btn[data-target="receitas-section"]').click();
        }


        // --- SIMULADOR DE PREÇO ---
        const simuladorSelect = document.getElementById('simulador-receita-select');
        const simuladorCogs = document.getElementById('simulador-cogs-resultado');
        const simuladorMeta = document.getElementById('simulador-meta-cmv');
        const simuladorPreco = document.getElementById('simulador-preco-sugerido');

        function updateSimuladorOptions() {
            simuladorSelect.innerHTML = '<option value="">Selecione uma receita</option>';
            document.getElementById('relatorio-receita-select').innerHTML = '<option value="">Selecione uma receita</option>';

            receitasCache.forEach(receita => {
                const option = document.createElement('option');
                option.value = receita.id;
                option.textContent = receita.nome;
                simuladorSelect.appendChild(option);
                document.getElementById('relatorio-receita-select').appendChild(option.cloneNode(true));
            });
        }
        
        function runSimulador() {
            const receitaId = simuladorSelect.value;
            if (!receitaId) {
                simuladorCogs.textContent = 'Custo da Pizza (COGS): R$ 0.00';
                simuladorPreco.textContent = 'Preço de Venda Sugerido: R$ 0.00';
                return;
            }

            const receita = receitasCache.find(r => r.id === receitaId);
            const cogs = calculateCogs(receita, insumosCache);
            simuladorCogs.textContent = `Custo da Pizza (COGS): R$ ${cogs.toFixed(2)}`;
            
            const metaCMV = parseFloat(simuladorMeta.value) / 100;
            if (metaCMV > 0) {
                const precoSugerido = cogs / metaCMV;
                simuladorPreco.textContent = `Preço de Venda Sugerido: R$ ${precoSugerido.toFixed(2)}`;
            } else {
                simuladorPreco.textContent = 'Preço de Venda Sugerido: R$ 0.00';
            }
        }
        
        simuladorSelect.addEventListener('change', runSimulador);
        simuladorMeta.addEventListener('input', runSimulador);


        // --- RELATÓRIOS ---
        const exportPdfBtn = document.getElementById('export-pdf-btn');
        const exportXlsxBtn = document.getElementById('export-xlsx-btn');
        const relatorioSelect = document.getElementById('relatorio-receita-select');

        function getDetalhesReceita(receitaId) {
            const receita = receitasCache.find(r => r.id === receitaId);
            if (!receita) return null;

            const cogs = calculateCogs(receita, insumosCache);
            const detalhes = [];
            
            // Ingredientes
            let custoTotalIngredientes = 0;
            receita.ingredientes.forEach(item => {
                const insumo = insumosCache.find(i => i.id === item.insumoId);
                const custoPorGrama = insumo.custo / insumo.qtd;
                const custoItem = custoPorGrama * item.quantidade_g;
                custoTotalIngredientes += custoItem;
                detalhes.push(['Ingrediente: ' + insumo.nome, `${item.quantidade_g.toFixed(2)} g`, `R$ ${custoItem.toFixed(2)}`]);
            });

            // Outros Custos
            const custoMaoDeObra = (userConfig.custo_hora_mao_de_obra / 60) * userConfig.tempo_preparo_minutos;
            detalhes.push(['Mão de Obra', `${userConfig.tempo_preparo_minutos} min`, `R$ ${custoMaoDeObra.toFixed(2)}`]);
            detalhes.push(['Embalagem', '1 un', `R$ ${receita.custo_embalagem.toFixed(2)}`]);
            detalhes.push(['Rateio de Despesas', '1 un', `R$ ${userConfig.rateio_overhead_por_pizza.toFixed(2)}`]);

            return {
                nome: receita.nome,
                cogs: cogs,
                detalhes: detalhes
            };
        }

        exportPdfBtn.addEventListener('click', () => {
            const receitaId = relatorioSelect.value;
            if (!receitaId) {
                alert('Por favor, selecione uma receita para gerar o relatório.');
                return;
            }

            const data = getDetalhesReceita(receitaId);
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.text(`Relatório de Custo - ${data.nome}`, 14, 16);
            doc.text(`Custo Total (COGS): R$ ${data.cogs.toFixed(2)}`, 14, 24);

            doc.autoTable({
                startY: 30,
                head: [['Item', 'Quantidade', 'Custo (R$)']],
                body: data.detalhes,
            });

            doc.save(`relatorio_${data.nome.replace(/\s/g, '_')}.pdf`);
        });

        exportXlsxBtn.addEventListener('click', () => {
            const receitaId = relatorioSelect.value;
            if (!receitaId) {
                alert('Por favor, selecione uma receita para gerar o relatório.');
                return;
            }
            const data = getDetalhesReceita(receitaId);
            
            const worksheetData = [
                ['Item', 'Quantidade', 'Custo (R$)'],
                ...data.detalhes,
                [],
                ['Custo Total (COGS)', '', `R$ ${data.cogs.toFixed(2)}`]
            ];

            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(worksheetData);
            XLSX.utils.book_append_sheet(wb, ws, 'RelatorioCMV');
            XLSX.writeFile(wb, `relatorio_${data.nome.replace(/\s/g, '_')}.xlsx`);
        });

    });
</script>

</body>
</html>