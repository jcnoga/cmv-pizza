<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pizzaria Cost Control Pro - Gest√£o Completa</title>

    <!--
    ====================================================================================================
    INSTRU√á√ïES DE CONFIGURA√á√ÉO E PUBLICA√á√ÉO
    ====================================================================================================
    1.  COLE SUA CONFIGURA√á√ÉO `firebaseConfig` NA SE√á√ÉO <script> ABAIXO.
    2.  ATIVE "E-mail/senha" NA ABA "AUTHENTICATION" DO FIREBASE.
    3.  CRIE O "FIRESTORE DATABASE" EM MODO DE PRODU√á√ÉO.
    4.  CRIE O "CLOUD STORAGE" PARA ARMAZENAR OS LOGOTIPOS.
    5.  NO FIRESTORE, CRIE UMA COLE√á√ÉO CHAMADA `userProfiles`.
    6.  CRIE OS √çNDICES COMPOSTOS (userId ASC, nome ASC) PARA 'fornecedores', 'insumos', 'receitas'.
    7.  CRIE O √çNDICE COMPOSTO (userId ASC, mes DESC) PARA A NOVA COLE√á√ÉO 'custosMensais'.
    8.  AJUSTE AS REGRAS DE SEGURAN√áA DO FIRESTORE (VEJA INSTRU√á√ïES NO FINAL DA P√ÅGINA).
    ====================================================================================================
    -->

    <style>
        :root {
            --primary-color: #D32F2F; --primary-dark: #B71C1C; --secondary-color: #FFC107;
            --light-gray: #f4f4f4; --medium-gray: #ccc; --dark-gray: #555;
            --text-color: #333; --white: #fff; --success-color: #4CAF50;
            --error-color: #f44336; --info-color: #2196F3; --shadow: 0 2px 8px rgba(0,0,0,0.1);
            --border-radius: 8px;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: var(--light-gray); color: var(--text-color); line-height: 1.6; display: flex; flex-direction: column; min-height: 100vh; }
        header { background-color: var(--primary-color); color: var(--white); padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; box-shadow: var(--shadow); flex-wrap: wrap; }
        header h1 { font-size: 1.5rem; margin-right: 2rem; display: flex; align-items: center; }
        #header-logo { height: 40px; margin-right: 15px; border-radius: 4px; }
        #auth-container, #app-container { width: 100%; max-width: 1200px; margin: 2rem auto; padding: 0 1rem; }
        .auth-form { background: var(--white); padding: 2.5rem; border-radius: var(--border-radius); box-shadow: var(--shadow); max-width: 450px; margin: 2rem auto; }
        .auth-form h2 { text-align: center; margin-bottom: 1.5rem; color: var(--primary-dark); }
        .form-group { margin-bottom: 1.25rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 600; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 0.75rem; border: 1px solid var(--medium-gray); border-radius: var(--border-radius); font-size: 1rem; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 2px rgba(211, 47, 47, 0.2); }
        .btn { display: inline-block; padding: 0.8rem 1.5rem; font-size: 1rem; font-weight: 600; text-align: center; border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.3s, transform 0.1s; width: 100%; }
        .btn:disabled { background-color: var(--medium-gray); cursor: not-allowed; }
        .btn:active:not(:disabled) { transform: scale(0.98); }
        .btn-primary { background-color: var(--primary-color); color: var(--white); } .btn-primary:hover:not(:disabled) { background-color: var(--primary-dark); }
        .btn-secondary { background-color: var(--dark-gray); color: var(--white); } .btn-secondary:hover { background-color: #333; }
        .btn-success { background-color: var(--success-color); color: var(--white); }
        .btn-danger { background-color: var(--error-color); color: var(--white); }
        .btn-info { background-color: var(--info-color); color: var(--white); }
        .btn-small { padding: 0.4rem 0.8rem; font-size: 0.85rem; width: auto; }
        .auth-link { text-align: center; margin-top: 1rem; } .auth-link a { color: var(--primary-color); text-decoration: none; font-weight: 600; }
        nav { display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap; }
        nav a, nav button { color: var(--white); text-decoration: none; background: none; border: none; cursor: pointer; font-size: 0.95rem; padding: 0.5rem 1rem; border-radius: var(--border-radius); transition: background-color 0.2s; }
        nav a:hover, nav button:hover, nav a.active { background-color: rgba(255,255,255,0.2); }
        #logout-button { background-color: var(--secondary-color); color: var(--text-color); font-weight: bold; }
        main { flex: 1; }
        .view { display: none; } .view.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .card { background: var(--white); padding: 1.5rem; border-radius: var(--border-radius); box-shadow: var(--shadow); margin-bottom: 1.5rem; }
        .grid-container { display: grid; gap: 1.5rem; }
        @media (min-width: 768px) { .grid-2 { grid-template-columns: repeat(2, 1fr); } .grid-3 { grid-template-columns: repeat(3, 1fr); } .grid-4 { grid-template-columns: repeat(4, 1fr); } }
        .kpi-card { text-align: center; }
        .kpi-card h3 { color: var(--dark-gray); font-size: 1rem; margin-bottom: 0.5rem; }
        .kpi-card .value { font-size: 2rem; font-weight: 700; color: var(--primary-dark); }
        h2 { margin-bottom: 1rem; color: var(--primary-dark); border-bottom: 2px solid var(--light-gray); padding-bottom: 0.5rem; }
        table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        th, td { padding: 0.75rem; text-align: left; border-bottom: 1px solid var(--medium-gray); }
        th { background-color: var(--light-gray); font-weight: 600; }
        tr:hover { background-color: #f9f9f9; }
        .actions-cell { text-align: right; white-space: nowrap; }
        .actions-cell .btn { margin-left: 0.5rem; }
        .form-row { display: flex; gap: 1rem; flex-wrap: wrap; }
        .form-row .form-group { flex: 1; min-width: 150px; }
        #ingredients-list .ingredient-row { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; padding-bottom: 0.5rem; border-bottom: 1px dashed var(--medium-gray); }
        #ingredients-list .ingredient-row > * { flex: 1; }
        #ingredients-list .ingredient-row .costo-ingrediente { flex: 0 0 120px; font-weight: bold; text-align: right; }
        .total-cost { text-align: right; font-size: 1.5rem; font-weight: bold; margin-top: 1rem; color: var(--primary-dark); }
        .simulator-result { margin-top: 1rem; padding: 1rem; background-color: #e8f5e9; border-left: 5px solid var(--success-color); border-radius: var(--border-radius); }
        .simulator-result p { font-size: 1.2rem; margin-bottom: 0.5rem; } .simulator-result strong { color: var(--primary-dark); }
        .alert-item { padding: 0.75rem; border-radius: var(--border-radius); margin-bottom: 0.5rem; background-color: #fff3e0; border: 1px solid #ffe0b2; color: #e65100; }
        .cmv-ok { color: var(--success-color); } .cmv-warn { color: #f57c00; } .cmv-danger { color: var(--error-color); }
        .cmv-visualizer { width: 100%; background-color: var(--medium-gray); border-radius: var(--border-radius); height: 25px; overflow: hidden; margin-top: 0.5rem; }
        .cmv-visualizer-bar { height: 100%; transition: width 0.5s; }
        .cmv-visualizer-bar.ok { background-color: var(--success-color); } .cmv-visualizer-bar.warn { background-color: var(--secondary-color); } .cmv-visualizer-bar.danger { background-color: var(--error-color); }
        .filter-container { margin-bottom: 1rem; display: flex; gap: 1rem; align-items: center; flex-wrap: wrap; }
        .filter-container input { padding: 0.5rem; border-radius: var(--border-radius); border: 1px solid var(--medium-gray); width: 100%; max-width: 400px; }
        .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); padding: 1rem 2rem; border-radius: var(--border-radius); color: var(--white); z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.5s, visibility 0.5s; }
        .toast.show { opacity: 1; visibility: visible; }
        .toast.success { background-color: var(--success-color); } .toast.error { background-color: var(--error-color); }
        footer { text-align: center; padding: 1.5rem; margin-top: 2rem; background-color: #e0e0e0; color: var(--dark-gray); font-size: 0.9rem; }
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: #fefefe; margin: 10% auto; padding: 20px; border: 1px solid #888; width: 90%; max-width: 600px; border-radius: var(--border-radius); }
        .modal-buttons { margin-top: 20px; text-align: center; } .modal-buttons .btn { width: 120px; margin: 0 10px; }
        .hidden { display: none; }
        #ajuda-view .card { margin-bottom: 1.5rem; } 
        #ajuda-view h3 { color: var(--primary-dark); margin-bottom: 1rem; } 
        #ajuda-view p { margin-bottom: 0.75rem; }
        .help-icon { display: inline-block; width: 20px; height: 20px; border-radius: 50%; background-color: var(--info-color); color: white; text-align: center; font-weight: bold; line-height: 20px; cursor: pointer; margin-left: 8px; font-style: normal; user-select: none; }
        #help-modal-content h3 { color: var(--primary-dark); border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 15px; }
        #help-modal-content p { margin-bottom: 10px; line-height: 1.7; }
        #help-modal-content strong { color: #333; }
    </style>
</head>
<body>

    <header>
        <h1>
            <img id="header-logo" src="" alt="Logotipo" class="hidden">
            <span id="header-company-name">üçï Pizzaria Cost Control Pro</span>
        </h1>
        <nav id="app-nav" class="hidden">
            <a href="#" class="nav-link" data-view="dashboard">Dashboard</a>
            <a href="#" class="nav-link" data-view="fornecedores">Fornecedores</a>
            <a href="#" class="nav-link" data-view="insumos">Insumos</a>
            <a href="#" class="nav-link" data-view="receitas">Receitas</a>
            <a href="#" class="nav-link" data-view="custos-mensais">Custos Mensais</a>
            <a href="#" class="nav-link" data-view="indicadores">Indicadores</a>
            <a href="#" class="nav-link" data-view="simulador">Simulador</a>
            <a href="#" class="nav-link" data-view="ajuda">Gloss√°rio</a>
            <a href="#" class="nav-link" data-view="configuracoes">‚öôÔ∏è</a>
            <button id="logout-button">Sair</button>
        </nav>
    </header>

    <main>
        <div id="auth-container">
            <div id="login-view" class="auth-form"><h2>Login</h2><form id="login-form"><div class="form-group"><label for="login-email">Email</label><input type="email" id="login-email" required></div><div class="form-group"><label for="login-password">Senha</label><input type="password" id="login-password" required></div><button type="submit" class="btn btn-primary">Entrar</button></form><div class="auth-link"><p>N√£o tem conta? <a href="#" id="show-register">Cadastre-se</a></p><p><a href="#" id="show-reset-password">Esqueceu a senha?</a></p></div></div>
            <div id="register-view" class="auth-form hidden">
                <h2>Cadastro</h2>
                <form id="register-form">
                    <div class="form-group"><label for="register-company-name">Nome da empresa</label><input type="text" id="register-company-name" required></div>
                    <div class="form-group"><label for="register-logo">Logotipo (opcional)</label><input type="file" id="register-logo" accept="image/*"></div>
                    <div class="form-group"><label for="register-email">Email</label><input type="email" id="register-email" required></div>
                    <div class="form-group"><label for="register-password">Senha (m√≠nimo 6 caracteres)</label><input type="password" id="register-password" required minlength="6"></div>
                    <button type="submit" class="btn btn-primary">Cadastrar</button>
                </form>
                <div class="auth-link"><p>J√° tem conta? <a href="#" id="show-login">Fa√ßa login</a></p></div>
            </div>
            <div id="reset-password-view" class="auth-form hidden"><h2>Recuperar Senha</h2><form id="reset-password-form"><div class="form-group"><label for="reset-email">Email</label><input type="email" id="reset-email" required></div><button type="submit" class="btn btn-primary">Enviar link</button></form><div class="auth-link"><p><a href="#" id="back-to-login">Voltar</a></p></div></div>
        </div>

        <div id="app-container" class="hidden">
            <!-- As se√ß√µes da aplica√ß√£o (dashboard, fornecedores, etc.) continuam aqui sem altera√ß√µes -->
            <section id="dashboard-view" class="view">
                <h2>Dashboard</h2>
                <div class="grid-container grid-4"><div class="card kpi-card"><h3>CMV M√©dio</h3><div class="value" id="dashboard-cmv-medio">--%</div></div><div class="card kpi-card"><h3>Fornecedores</h3><div class="value" id="dashboard-num-fornecedores">--</div></div><div class="card kpi-card"><h3>Insumos</h3><div class="value" id="dashboard-num-insumos">--</div></div><div class="card kpi-card"><h3>Receitas</h3><div class="value" id="dashboard-num-receitas">--</div></div></div>
                <div class="grid-container grid-2"><div class="card"><h3>Alertas de Varia√ß√£o (> <span id="alert-threshold-display">10</span>%)</h3><div id="dashboard-alerts"><p>Nenhum alerta.</p></div></div><div class="card"><h3>Top 5 Insumos por Custo</h3><table id="dashboard-top-insumos"><thead><tr><th>Insumo</th><th>Custo/g (ou un)</th></tr></thead><tbody><tr><td colspan="2">N/A</td></tr></tbody></table></div></div>
                <div class="card"><h3>A√ß√µes R√°pidas</h3><button id="run-validation-button" class="btn btn-secondary btn-small">Validar Margherita</button><button id="generate-general-report-pdf" class="btn btn-info btn-small" style="margin-left: 1rem;">Relat√≥rio Geral (PDF)</button><div id="validation-results" class="hidden" style="margin-top: 1rem; padding: 1rem; background: #eee;"></div></div>
            </section>
            
            <section id="fornecedores-view" class="view">
                <div class="card"><h2 id="fornecedor-form-title">Cadastrar Fornecedor</h2><form id="fornecedor-form"><input type="hidden" id="fornecedor-id"><div class="form-row"><div class="form-group"><label for="fornecedor-nome">Nome <i class="help-icon" data-help-key="fornecedorNome">‚ÑπÔ∏è</i></label><input type="text" id="fornecedor-nome" required></div><div class="form-group"><label for="fornecedor-contato">Contato <i class="help-icon" data-help-key="fornecedorContato">‚ÑπÔ∏è</i></label><input type="text" id="fornecedor-contato"></div></div><div class="form-row"><div class="form-group"><label for="fornecedor-telefone">Telefone</label><input type="tel" id="fornecedor-telefone"></div><div class="form-group"><label for="fornecedor-email">Email</label><input type="email" id="fornecedor-email"></div></div><div class="form-group"><label for="fornecedor-endereco">Endere√ßo</label><input type="text" id="fornecedor-endereco"></div><button type="submit" class="btn btn-primary">Salvar Fornecedor</button><button type="button" id="cancel-edit-fornecedor" class="btn btn-secondary hidden" style="margin-top: 0.5rem;">Cancelar</button></form></div>
                <div class="card"><h2>Lista de Fornecedores</h2><table id="fornecedores-table"><thead><tr><th>Nome</th><th>Contato</th><th>Telefone</th><th>Insumos</th><th class="actions-cell">A√ß√µes</th></tr></thead><tbody></tbody></table></div>
            </section>

            <section id="insumos-view" class="view">
                <div class="card"><h2 id="insumo-form-title">Cadastrar Insumo</h2><form id="insumo-form"><input type="hidden" id="insumo-id"><div class="form-row"><div class="form-group"><label for="insumo-nome">Nome <i class="help-icon" data-help-key="insumoNome">‚ÑπÔ∏è</i></label><input type="text" id="insumo-nome" required></div><div class="form-group"><label for="insumo-fornecedor-select">Fornecedor</label><select id="insumo-fornecedor-select" required><option value="">-- Selecione --</option></select></div></div><div class="form-row"><div class="form-group"><label for="insumo-custo-embalagem">Custo Embalagem (R$) <i class="help-icon" data-help-key="insumoCustoEmbalagem">‚ÑπÔ∏è</i></label><input type="number" id="insumo-custo-embalagem" step="0.01" required></div><div class="form-group"><label for="insumo-qtd-embalagem">Qtd. Embalagem <i class="help-icon" data-help-key="insumoQtdEmbalagem">‚ÑπÔ∏è</i></label><input type="number" id="insumo-qtd-embalagem" step="0.01" required></div><div class="form-group"><label for="insumo-unidade-embalagem">Unidade</label><select id="insumo-unidade-embalagem" required><option value="kg">kg</option><option value="g">g</option><option value="L">L</option><option value="ml">ml</option><option value="un">un</option></select></div></div><div class="form-row"><div class="form-group"><label for="insumo-lote">Lote <i class="help-icon" data-help-key="insumoLote">‚ÑπÔ∏è</i></label><input type="text" id="insumo-lote"></div><div class="form-group"><label for="insumo-validade">Validade</label><input type="date" id="insumo-validade"></div></div><button type="submit" class="btn btn-primary">Salvar Insumo</button><button type="button" id="cancel-edit-insumo" class="btn btn-secondary hidden" style="margin-top: 0.5rem;">Cancelar</button></form></div>
                <div class="card"><h2>Lista de Insumos</h2><div class="filter-container"><input type="text" id="insumos-filter" placeholder="üîé Filtrar..."></div><button id="export-insumos-xlsx" class="btn btn-success btn-small">Exportar XLSX</button><table id="insumos-table"><thead><tr><th>Nome</th><th>Custo/g (un)</th><th>Fornecedor</th><th>Validade</th><th class="actions-cell">A√ß√µes</th></tr></thead><tbody></tbody></table></div>
            </section>

            <section id="receitas-view" class="view">
                <div class="card"><h2 id="receita-form-title">Criar Receita</h2><form id="receita-form"><input type="hidden" id="receita-id"><div class="form-row"><div class="form-group"><label for="receita-nome">Nome da Pizza</label><input type="text" id="receita-nome" required></div><div class="form-group"><label for="receita-versao">Vers√£o <i class="help-icon" data-help-key="receitaVersao">‚ÑπÔ∏è</i></label><input type="text" id="receita-versao" placeholder="1.0"></div></div><h3>Ingredientes</h3><div id="ingredients-list"></div><button type="button" id="add-ingredient-btn" class="btn btn-secondary btn-small">Adicionar Ingrediente</button><div id="custo-total-ingredientes" class="total-cost">Custo: R$ 0,00</div><h3>Custos Adicionais</h3><div class="form-row"><div class="form-group"><label for="receita-tempo-preparo">Preparo (min) <i class="help-icon" data-help-key="receitaTempoPreparo">‚ÑπÔ∏è</i></label><input type="number" id="receita-tempo-preparo" value="0" required></div><div class="form-group"><label for="receita-custo-embalagem">Embalagem (R$) <i class="help-icon" data-help-key="receitaEmbalagem">‚ÑπÔ∏è</i></label><input type="number" id="receita-custo-embalagem" step="0.01" value="0"></div><div class="form-group"><label for="receita-perda-percentual">Perda (%) <i class="help-icon" data-help-key="receitaPerda">‚ÑπÔ∏è</i></label><input type="number" id="receita-perda-percentual" value="0"></div></div><div class="form-group"><label for="receita-observacoes">Observa√ß√µes</label><textarea id="receita-observacoes" rows="3"></textarea></div><button type="submit" class="btn btn-primary">Salvar Receita</button><button type="button" id="cancel-edit-receita" class="btn btn-secondary hidden" style="margin-top: 0.5rem;">Cancelar</button></form></div>
                <div class="card"><h2>Lista de Receitas</h2><div class="filter-container"><input type="text" id="receitas-filter" placeholder="üîé Filtrar..."><button id="export-receitas-xlsx" class="btn btn-success btn-small">Exportar Fichas (XLSX)</button><button id="list-ingredients-pdf" class="btn btn-info btn-small">üñ®Ô∏è Listar Ingredientes (PDF)</button></div><table id="receitas-table"><thead><tr><th>Nome</th><th>Custo (COGS)</th><th>Vers√£o</th><th class="actions-cell">A√ß√µes</th></tr></thead><tbody></tbody></table></div>
            </section>

            <section id="custos-mensais-view" class="view">
                <div class="card">
                    <h2 id="custo-mensal-form-title">Lan√ßar Custos do M√™s</h2>
                    <form id="custo-mensal-form">
                        <input type="hidden" id="custo-mensal-id">
                        <div class="form-row">
                            <div class="form-group"><label for="custo-mensal-mes">M√™s/Ano</label><input type="month" id="custo-mensal-mes" required></div>
                            <div class="form-group"><label for="custo-mensal-faturamento">Faturamento (R$) <i class="help-icon" data-help-key="faturamento">‚ÑπÔ∏è</i></label><input type="number" id="custo-mensal-faturamento" step="0.01" required></div>
                        </div>
                        <div class="form-row">
                            <div class="form-group"><label for="custo-mensal-custosVariaveis">Custos Vari√°veis (R$) <i class="help-icon" data-help-key="custosVariaveis">‚ÑπÔ∏è</i></label><input type="number" id="custo-mensal-custosVariaveis" step="0.01"></div>
                            <div class="form-group"><label for="custo-mensal-custosFixos">Custos Fixos (R$) <i class="help-icon" data-help-key="custosFixos">‚ÑπÔ∏è</i></label><input type="number" id="custo-mensal-custosFixos" step="0.01"></div>
                        </div>
                        <div class="form-row">
                             <div class="form-group"><label for="custo-mensal-despesasOperacionais">Desp. Operacionais (R$) <i class="help-icon" data-help-key="despesasOperacionais">‚ÑπÔ∏è</i></label><input type="number" id="custo-mensal-despesasOperacionais" step="0.01"></div>
                             <div class="form-group"><label for="custo-mensal-impostos">Impostos (R$) <i class="help-icon" data-help-key="impostos">‚ÑπÔ∏è</i></label><input type="number" id="custo-mensal-impostos" step="0.01"></div>
                        </div>
                        <div class="form-row">
                           <div class="form-group"><label for="custo-mensal-outrasReceitasDespesas">Outras Receitas/Desp. (R$) <i class="help-icon" data-help-key="outrasReceitasDespesas">‚ÑπÔ∏è</i></label><input type="number" id="custo-mensal-outrasReceitasDespesas" step="0.01" placeholder="Use valor negativo para despesa"></div>
                           <div class="form-group"><label for="custo-mensal-numeroVendas">N√∫mero de Vendas <i class="help-icon" data-help-key="numeroVendas">‚ÑπÔ∏è</i></label><input type="number" id="custo-mensal-numeroVendas" step="1"></div>
                        </div>
                        <button type="submit" class="btn btn-primary">Salvar M√™s</button>
                        <button type="button" id="cancel-edit-custo-mensal" class="btn btn-secondary hidden" style="margin-top:0.5rem">Cancelar Edi√ß√£o</button>
                    </form>
                </div>
                <div class="card">
                    <h2>Hist√≥rico Mensal</h2>
                    <table id="custos-mensais-table">
                        <thead><tr><th>M√™s</th><th>Faturamento</th><th>Lucro L√≠quido</th><th class="actions-cell">A√ß√µes</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </section>

            <section id="indicadores-view" class="view">
                <div class="card">
                    <h2>Indicadores Financeiros Mensais</h2>
                    <div class="form-group">
                        <label for="indicadores-mes-select">Selecione o M√™s para An√°lise</label>
                        <select id="indicadores-mes-select"><option value="">-- Escolha um m√™s --</option></select>
                    </div>
                    <div id="indicadores-results" class="hidden">
                        <div class="grid-container grid-3">
                            <div class="card kpi-card"><h3>Lucro L√≠quido <i class="help-icon" data-help-key="lucroLiquido">‚ÑπÔ∏è</i></h3><div class="value" id="indicador-lucro-liquido">R$ 0,00</div></div>
                            <div class="card kpi-card"><h3>Margem L√≠quida <i class="help-icon" data-help-key="margemLiquida">‚ÑπÔ∏è</i></h3><div class="value" id="indicador-margem-liquida">0,00%</div></div>
                            <div class="card kpi-card"><h3>Markup <i class="help-icon" data-help-key="markup">‚ÑπÔ∏è</i></h3><div class="value" id="indicador-markup">0,00%</div></div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="simulador-view" class="view">
                 <div class="card"><h2>Simulador de Custo e Pre√ßo</h2><div class="form-group"><label for="simulador-receita-select">Selecione uma Receita</label><select id="simulador-receita-select"><option value="">-- Escolha --</option></select></div><div id="simulador-detalhes" class="hidden"><h3>Detalhes de Custo (COGS)</h3><table id="simulador-custos-table"><thead><tr><th>Item</th><th>Valor</th></tr></thead><tbody></tbody></table><p class="total-cost" id="simulador-cogs-total">COGS Total: R$ 0,00</p><div class="grid-container grid-2" style="margin-top: 2rem;"><div class="card"><h4>Calcular CMV por Pre√ßo</h4><div class="form-group"><label for="simulador-preco-venda">Pre√ßo de Venda (R$) <i class="help-icon" data-help-key="precoVenda">‚ÑπÔ∏è</i></label><input type="number" id="simulador-preco-venda" step="0.01"></div><div id="simulador-resultado-cmv" class="simulator-result hidden"></div><div id="cmv-visualizer-container" class="hidden"><div class="cmv-visualizer"><div id="cmv-bar" class="cmv-visualizer-bar"></div></div></div></div><div class="card"><h4>Calcular Pre√ßo Sugerido</h4><div class="form-group"><label for="simulador-meta-cmv">Meta de CMV (%) <i class="help-icon" data-help-key="metaCMV">‚ÑπÔ∏è</i></label><input type="number" id="simulador-meta-cmv" step="0.1"></div><div class="form-group"><label for="simulador-margem-desejada">Margem (%) <i class="help-icon" data-help-key="margemDesejada">‚ÑπÔ∏è</i></label><input type="number" id="simulador-margem-desejada" step="0.1"></div><div id="simulador-resultado-preco" class="simulator-result hidden"></div></div></div></div></div>
            </section>
            
            <section id="configuracoes-view" class="view">
                <div class="card">
                    <h2>Configura√ß√µes da Empresa</h2>
                    <form id="profile-config-form">
                        <div class="form-group">
                            <label for="config-company-name">Nome da Empresa</label>
                            <input type="text" id="config-company-name">
                        </div>
                        <div class="form-group">
                            <label for="config-logo">Alterar Logotipo</label>
                            <input type="file" id="config-logo" accept="image/*">
                        </div>
                        <button type="submit" class="btn btn-primary">Salvar Dados da Empresa</button>
                    </form>
                </div>
                <div class="card">
                    <h2>Configura√ß√µes de C√°lculo</h2>
                    <form id="configuracoes-form">
                        <div class="form-group"><label for="config-custo-hora-mao-de-obra">Custo M√£o de Obra (R$/hora) <i class="help-icon" data-help-key="configMaoDeObra">‚ÑπÔ∏è</i></label><input type="number" id="config-custo-hora-mao-de-obra" step="0.01"></div>
                        <div class="form-group"><label for="config-rateio-despesas-fixas">Rateio Fixo (R$/pizza) <i class="help-icon" data-help-key="configRateio">‚ÑπÔ∏è</i></label><input type="number" id="config-rateio-despesas-fixas" step="0.01"></div>
                        <div class="form-group"><label for="config-meta-cmv-padrao">Meta CMV Padr√£o (%) <i class="help-icon" data-help-key="configMetaCMV">‚ÑπÔ∏è</i></label><input type="number" id="config-meta-cmv-padrao" step="0.1"></div>
                        <div class="form-group"><label for="config-alerta-variacao">Alerta Varia√ß√£o Pre√ßo (%) <i class="help-icon" data-help-key="configAlerta">‚ÑπÔ∏è</i></label><input type="number" id="config-alerta-variacao" step="1" value="10"></div>
                        <button type="submit" class="btn btn-primary">Salvar Configura√ß√µes de C√°lculo</button>
                    </form>
                </div>
            </section>

            <section id="ajuda-view" class="view">
                <h2>Gloss√°rio de Ajuda</h2>
                <!-- O conte√∫do do gloss√°rio permanece o mesmo -->
                <div class="card"><h3>Faturamento (Receita Bruta)</h3><p><strong>F√≥rmula:</strong> Pre√ßo de Venda √ó N√∫mero de Unidades Vendidas.</p><p><strong>Significado:</strong> √â o valor total arrecadado com as vendas de produtos ou servi√ßos antes de deduzir qualquer custo ou despesa. Representa toda a entrada de dinheiro gerada pela atividade principal do neg√≥cio.</p><p><strong>Exemplo:</strong> Se uma pizzaria vende 100 pizzas a R$ 50,00 cada em um dia, o faturamento desse dia √© de R$ 5.000,00.</p><p><strong>Dica:</strong> Faturamento alto n√£o significa lucro. √â importante analisar os custos e despesas para garantir que a opera√ß√£o seja rent√°vel.</p></div>
                <div class="card"><h3>Custos Fixos (CF)</h3><p><strong>F√≥rmula:</strong> Soma de todos os custos que n√£o variam conforme o volume de produ√ß√£o ou vendas.</p><p><strong>Significado:</strong> S√£o despesas que a empresa precisa pagar todos os meses, independente do faturamento ‚Äî como aluguel, energia m√≠nima, contabilidade ou sal√°rios fixos.</p><p><strong>Exemplo:</strong> Aluguel do ponto comercial de R$ 2.000 + folha de pagamento de R$ 8.000 = R$ 10.000 de custos fixos mensais.</p><p><strong>Dica:</strong> Fa√ßa uma revis√£o peri√≥dica dos custos fixos para identificar itens que podem ser reduzidos ou renegociados sem prejudicar a opera√ß√£o.</p></div>
                <div class="card"><h3>Custos Vari√°veis (CV)</h3><p><strong>F√≥rmula:</strong> Soma dos custos que mudam proporcionalmente ao volume de produ√ß√£o ou vendas.</p><p><strong>Significado:</strong> S√£o os gastos diretamente ligados √† produ√ß√£o e venda de cada produto. Se voc√™ n√£o vende nada, esse custo √© zero. Inclui ingredientes, embalagens para delivery, etc.</p><p><strong>Exemplo:</strong> Se cada pizza consome R$ 8,00 em ingredientes e R$ 1,50 em embalagem, o custo vari√°vel por pizza √© de R$ 9,50.</p><p><strong>Dica:</strong> Negociar pre√ßos melhores com fornecedores para compras em maior volume √© a principal forma de reduzir seus custos vari√°veis e aumentar a margem de lucro por produto.</p></div>
                <div class="card"><h3>Custo da Mercadoria Vendida (CMV ou COGS)</h3><p><strong>F√≥rmula:</strong> Soma de todos os custos diretos para produzir uma unidade (ingredientes, m√£o de obra direta, embalagem, rateio de custos fixos por produto).</p><p><strong>Significado:</strong> Representa o custo total para produzir cada pizza que voc√™ vende. √â o principal indicador de custo do seu produto finalizado.</p><p><strong>Exemplo:</strong> R$ 8,00 (ingredientes) + R$ 2,00 (m√£o de obra por pizza) + R$ 1,50 (embalagem) = R$ 11,50 de CMV por pizza.</p><p><strong>Dica:</strong> Manter as fichas t√©cnicas das suas receitas sempre atualizadas √© fundamental para ter um c√°lculo de CMV preciso e garantir que seus pre√ßos de venda est√£o corretos.</p></div>
                <div class="card"><h3>Lucro L√≠quido (LL)</h3><p><strong>F√≥rmula:</strong> Faturamento - (Custos Fixos + Custos Vari√°veis + Impostos + Despesas Operacionais).</p><p><strong>Significado:</strong> √â o resultado final da empresa, ou seja, o dinheiro que efetivamente sobra no caixa ap√≥s o pagamento de todas as contas, custos e impostos. √â o indicador mais importante da sa√∫de financeira do neg√≥cio.</p><p><strong>Exemplo:</strong> Faturamento de R$ 50.000 - Total de Custos e Despesas de R$ 42.000 = R$ 8.000 de Lucro L√≠quido.</p><p><strong>Dica:</strong> Um neg√≥cio s√≥ √© sustent√°vel a longo prazo se gerar Lucro L√≠quido de forma consistente. Acompanhe este indicador mensalmente.</p></div>
                <div class="card"><h3>Margem L√≠quida (ML)</h3><p><strong>F√≥rmula:</strong> (Lucro L√≠quido / Faturamento) √ó 100.</p><p><strong>Significado:</strong> Indica a porcentagem de lucro que a empresa obt√©m para cada real de faturamento. Mostra o qu√£o eficiente √© a sua opera√ß√£o em transformar vendas em lucro real.</p><p><strong>Exemplo:</strong> (R$ 8.000 de Lucro L√≠quido / R$ 50.000 de Faturamento) √ó 100 = 16%. Isso significa que 16% de tudo que voc√™ vende se torna lucro.</p><p><strong>Dica:</strong> Uma margem l√≠quida maior indica uma empresa mais saud√°vel e rent√°vel. Compare sua margem com a de outros neg√≥cios no mesmo setor para avaliar sua competitividade.</p></div>
                <div class="card"><h3>Markup</h3><p><strong>F√≥rmula:</strong> ((Pre√ßo de Venda - Custo Total Unit√°rio) / Custo Total Unit√°rio) √ó 100.</p><p><strong>Significado:</strong> √â um √≠ndice aplicado sobre o custo do produto para formar o pre√ßo de venda. Ele mostra o quanto o seu pre√ßo est√° acima do seu custo.</p><p><strong>Exemplo:</strong> Uma pizza custa R$ 10,00 para ser feita e √© vendida por R$ 45,00. O Markup √© ((45 - 10) / 10) √ó 100 = 350%.</p><p><strong>Dica:</strong> O Markup √© uma ferramenta √∫til para a precifica√ß√£o inicial, mas n√£o deve ser confundido com a margem de lucro. A Margem L√≠quida √© um indicador mais preciso da rentabilidade geral do neg√≥cio.</p></div>
            </section>
        </div>
    </main>

    <footer><p>Pizzaria Cost Control Pro &copy; 2025.</p></footer>
    <div id="toast" class="toast"></div>
    <div id="confirm-modal" class="modal"><div class="modal-content" style="text-align: center;"><p id="confirm-modal-text">Confirmar?</p><div class="modal-buttons"><button id="confirm-modal-yes" class="btn btn-danger">Sim</button><button id="confirm-modal-no" class="btn btn-secondary">N√£o</button></div></div></div>
    
    <div id="help-modal" class="modal">
        <div id="help-modal-content" class="modal-content">
            <h3 id="help-modal-title"></h3>
            <div id="help-modal-text"></div>
            <div class="modal-buttons">
                <button id="help-modal-close" class="btn btn-primary">Fechar</button>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const firebaseConfig = {
            // INSIRA SUA CONFIGURA√á√ÉO DO FIREBASE AQUI
        };

        let firebaseApp, auth, db, storage, currentUser;
        let isLocalMode = false;
        let localData = { fornecedores: [], insumos: [], receitas: [], configuracoes: {}, custosMensais: [], userProfile: {} };
        let fornecedoresCache = [], insumosCache = [], receitasCache = [], configCache = {}, custosMensaisCache = [], userProfileCache = {};
        
        // Objeto de ajuda permanece o mesmo
        const helpTexts = {
            fornecedorNome: { title: 'Nome do Fornecedor', text: 'Nome fantasia ou raz√£o social da empresa que fornece os insumos. Ex: "Distribuidora de Frios S.A.".' },
            fornecedorContato: { title: 'Nome do Contato', text: 'Nome do vendedor ou pessoa principal com quem voc√™ fala na empresa. Ex: "Carlos Andrade".' },
            insumoNome: { title: 'Nome do Insumo', text: 'Descri√ß√£o clara e √∫nica para o ingrediente. Ex: "Queijo Mussarela Pe√ßa", "Tomate Italiano", "Farinha de Trigo Tipo 1".' },
            insumoCustoEmbalagem: { title: 'Custo da Embalagem (R$)', text: 'O valor total que voc√™ pagou pela embalagem fechada do insumo (saco, caixa, pe√ßa, etc.). Ex: R$ 85,90.' },
            insumoQtdEmbalagem: { title: 'Quantidade na Embalagem', text: 'A quantidade total de produto que vem na embalagem que voc√™ comprou. Use a unidade correspondente (kg, L, un).' },
            insumoLote: { title: 'Lote', text: 'C√≥digo de lote do produto, geralmente impresso na embalagem. Ajuda no rastreamento em caso de problemas.' },
            receitaVersao: { title: 'Vers√£o da Receita', text: 'Use para controlar altera√ß√µes na receita. Comece com 1.0 e aumente a cada modifica√ß√£o (ex: 1.1, 2.0). Ajuda a manter o hist√≥rico.' },
            receitaTempoPreparo: { title: 'Tempo de Preparo (min)', text: 'Tempo total em minutos que um funcion√°rio leva para montar a pizza, desde separar os ingredientes at√© ela estar pronta para ir ao forno. Este tempo ser√° usado para calcular o custo da m√£o de obra por pizza.' },
            receitaEmbalagem: { title: 'Custo da Embalagem (R$)', text: 'Custo da caixa da pizza, lacre, e qualquer outro item de embalagem usado para o delivery deste produto espec√≠fico.' },
            receitaPerda: { title: 'Percentual de Perda (%)', text: 'Estimativa de perda de ingredientes durante o preparo (ex: aparas, produto que cai no ch√£o). Um valor comum √© entre 3% e 5%. Este percentual ser√° acrescido ao custo dos ingredientes.' },
            faturamento: { title: 'Faturamento (Receita Bruta)', formula: 'Pre√ßo de Venda √ó Unidades Vendidas', text: 'Valor total arrecadado com as vendas antes de qualquer dedu√ß√£o.' },
            custosVariaveis: { title: 'Custos Vari√°veis (CV)', text: 'Soma de todos os custos que s√≥ existem quando h√° venda, como o custo total dos ingredientes usados no m√™s, embalagens e taxas de cart√£o/delivery.' },
            custosFixos: { title: 'Custos Fixos (CF)', text: 'Soma dos custos que voc√™ tem todo m√™s, vendendo ou n√£o: aluguel, sal√°rios, contador, internet, etc.' },
            despesasOperacionais: { title: 'Despesas Operacionais', text: 'Gastos necess√°rios para manter a opera√ß√£o funcionando, mas que n√£o est√£o diretamente ligados √† produ√ß√£o. Ex: material de limpeza, marketing, uniformes.' },
            impostos: { title: 'Impostos', text: 'Valor total de impostos pagos no m√™s, como o Simples Nacional.' },
            outrasReceitasDespesas: { title: 'Outras Receitas/Despesas', text: 'Qualquer entrada ou sa√≠da de dinheiro que n√£o seja da opera√ß√£o principal. Use um valor negativo para despesas (ex: -150.00 para um conserto emergencial).' },
            numeroVendas: { title: 'N√∫mero de Vendas', text: 'Quantidade total de pedidos ou pizzas vendidas no m√™s. Ajuda a calcular o ticket m√©dio.' },
            lucroLiquido: { title: 'Lucro L√≠quido (LL)', formula: 'Faturamento - Todos os Custos e Despesas', text: 'Dinheiro que efetivamente sobra no caixa ap√≥s pagar absolutamente tudo. √â o indicador mais importante da sa√∫de financeira.' },
            margemLiquida: { title: 'Margem L√≠quida (ML)', formula: '(Lucro L√≠quido / Faturamento) √ó 100', text: 'Indica a porcentagem de lucro que a empresa obt√©m para cada real de faturamento. Mostra a efici√™ncia da opera√ß√£o.' },
            markup: { title: 'Markup', formula: '((Pre√ßo de Venda - Custo) / Custo) √ó 100', text: '√çndice que mostra o quanto seu pre√ßo de venda est√° acima do custo do produto.' },
            precoVenda: { title: 'Pre√ßo de Venda (R$)', text: 'O pre√ßo final que o cliente paga pelo produto. Use este campo para simular o CMV com base em um pre√ßo.' },
            metaCMV: { title: 'Meta de CMV (%)', text: 'Qual o Custo da Mercadoria Vendida (CMV) m√°ximo que voc√™ aceita ter para este produto, em percentual. Um valor comum para pizzarias √© entre 25% e 35%. O sistema usar√° este valor para sugerir um pre√ßo de venda.' },
            margemDesejada: { title: 'Margem Desejada (%)', text: 'Qual a margem de lucro bruta que voc√™ deseja ter sobre o pre√ßo de venda. Se voc√™ quer que 50% do pre√ßo de venda seja lucro (sobre o custo direto), insira 50 aqui. O sistema sugerir√° o pre√ßo para atingir essa margem.' },
            configMaoDeObra: { title: 'Custo da M√£o de Obra (R$/hora)', text: 'Some o sal√°rio bruto + encargos de todos os funcion√°rios da cozinha e divida pelo total de horas trabalhadas por eles no m√™s. Este valor ser√° usado para calcular o custo do tempo de preparo de cada pizza.' },
            configRateio: { title: 'Rateio Fixo (R$/pizza)', text: 'Um pequeno valor a ser adicionado ao custo de cada pizza para ajudar a cobrir custos fixos indiretos (g√°s, energia, etc.). Ex: R$ 0,50 por pizza.' },
            configMetaCMV: { title: 'Meta CMV Padr√£o (%)', text: 'A meta de Custo da Mercadoria Vendida (CMV) que ser√° usada como padr√£o no simulador e em outros c√°lculos. Geralmente entre 25-35%.' },
            configAlerta: { title: 'Alerta de Varia√ß√£o de Pre√ßo (%)', text: 'O sistema ir√° gerar um alerta no Dashboard se o pre√ßo de compra de um insumo variar mais do que este percentual (para cima ou para baixo).' }
        };

        if (firebaseConfig.apiKey && firebaseConfig.projectId) {
            try { 
                firebaseApp = firebase.initializeApp(firebaseConfig); 
                auth = firebase.auth(); 
                db = firebase.firestore(); 
                storage = firebase.storage();
                setupAuthListeners();
            } 
            catch (error) { 
                console.error("Erro ao inicializar Firebase:", error);
                alert("Erro na configura√ß√£o do Firebase. Verifique o console. O app rodar√° em modo local.");
                isLocalMode = true; 
                initApp(); 
            }
        } else {
            isLocalMode = true;
            console.warn("Firebase n√£o configurado. Rodando em modo local.");
            initApp();
        }

        const authContainer = document.getElementById('auth-container');
        const appContainer = document.getElementById('app-container');
        const appNav = document.getElementById('app-nav');
        const views = document.querySelectorAll('.view');
        const navLinks = document.querySelectorAll('.nav-link');

        function showToast(message, type = 'success') { const toast = document.getElementById('toast'); toast.textContent = message; toast.className = `toast show ${type}`; setTimeout(() => { toast.className = 'toast'; }, 3000); }
        function formatCurrency(value) { return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value || 0); }
        function showView(viewId) { views.forEach(v => v.classList.remove('active')); navLinks.forEach(l => l.classList.remove('active')); document.getElementById(`${viewId}-view`)?.classList.add('active'); document.querySelector(`.nav-link[data-view="${viewId}"]`)?.classList.add('active'); }

        function setupAuthListeners() {
            auth.onAuthStateChanged(async user => {
                if (user) {
                    currentUser = { uid: user.uid, email: user.email };
                    authContainer.classList.add('hidden');
                    appContainer.classList.remove('hidden');
                    appNav.classList.remove('hidden');
                    initApp();
                } else {
                    currentUser = null;
                    authContainer.classList.remove('hidden');
                    appContainer.classList.add('hidden');
                    appNav.classList.add('hidden');
                    resetAppState();
                }
            });

            const loginForm = document.getElementById('login-form');
            loginForm.addEventListener('submit', async e => { e.preventDefault(); const button = loginForm.querySelector('button[type="submit"]'); button.disabled = true; button.textContent = 'Aguarde...'; try { await auth.signInWithEmailAndPassword(document.getElementById('login-email').value, document.getElementById('login-password').value); } catch (err) { showToast(err.message, 'error'); } finally { button.disabled = false; button.textContent = 'Entrar'; } });
            
            const registerForm = document.getElementById('register-form');
            registerForm.addEventListener('submit', async e => {
                e.preventDefault();
                const button = registerForm.querySelector('button[type="submit"]');
                button.disabled = true; button.textContent = 'Aguarde...';
                try {
                    const { user } = await auth.createUserWithEmailAndPassword(document.getElementById('register-email').value, document.getElementById('register-password').value);
                    const companyName = document.getElementById('register-company-name').value;
                    const logoFile = document.getElementById('register-logo').files[0];
                    let logoUrl = '';

                    if (logoFile) {
                        const storageRef = storage.ref(`logos/${user.uid}/${logoFile.name}`);
                        const snapshot = await storageRef.put(logoFile);
                        logoUrl = await snapshot.ref.getDownloadURL();
                    }
                    
                    // Salva os dados de perfil na cole√ß√£o 'userProfiles'
                    await db.collection('userProfiles').doc(user.uid).set({
                        companyName: companyName,
                        logoUrl: logoUrl,
                        userId: user.uid
                    });
                    
                    showToast("Cadastro realizado com sucesso! Fa√ßa o login.");
                    toggleAuthViews('login-view');
                } catch (err) {
                    showToast(err.message, 'error');
                } finally {
                    button.disabled = false; button.textContent = 'Cadastrar';
                }
            });

            const resetForm = document.getElementById('reset-password-form');
            resetForm.addEventListener('submit', async e => { e.preventDefault(); const button = resetForm.querySelector('button[type="submit"]'); button.disabled = true; button.textContent = 'Aguarde...'; try { await auth.sendPasswordResetEmail(document.getElementById('reset-email').value); showToast("Email de recupera√ß√£o enviado!"); toggleAuthViews('login-view'); } catch (err) { showToast(err.message, 'error'); } finally { button.disabled = false; button.textContent = 'Enviar link'; } });
            
            // CORRE√á√ÉO DO BOT√ÉO SAIR
            document.getElementById('logout-button').addEventListener('click', () => {
                if (auth) {
                    auth.signOut();
                } else {
                    // For√ßa o logout em modo local
                    currentUser = null;
                    resetAppState();
                    authContainer.classList.remove('hidden');
                    appContainer.classList.add('hidden');
                    appNav.classList.add('hidden');
                }
            });
            
            ['show-register', 'show-login', 'show-reset-password', 'back-to-login'].forEach(id => { document.getElementById(id).addEventListener('click', e => { e.preventDefault(); const viewMap = { 'show-register': 'register-view', 'show-login': 'login-view', 'show-reset-password': 'reset-password-view', 'back-to-login': 'login-view' }; toggleAuthViews(viewMap[id]); }); });
        }
        function toggleAuthViews(view) { ['login-view', 'register-view', 'reset-password-view'].forEach(id => document.getElementById(id).classList.add('hidden')); document.getElementById(view).classList.remove('hidden'); }

        async function initApp() { 
            if (isLocalMode) { currentUser = { uid: 'local', email: 'local@app.com' }; authContainer.classList.add('hidden'); appContainer.classList.remove('hidden'); appNav.classList.remove('hidden'); }
            await fetchUserProfile(); // Carrega perfil antes de qualquer outra coisa
            showView('dashboard'); 
            setupNavListeners(); 
            setupFormListeners();
            setupHelpModals();
            await loadAllData(); 
        }

        function resetAppState() {
            userProfileCache = {};
            applyBranding();
            fornecedoresCache = []; insumosCache = []; receitasCache = []; configCache = {}; custosMensaisCache = []; 
            ['fornecedores-table', 'insumos-table', 'receitas-table', 'custos-mensais-table'].forEach(id => { const table = document.getElementById(id); if (table) table.querySelector('tbody').innerHTML = '' }); 
        }

        function applyBranding() {
            const companyNameEl = document.getElementById('header-company-name');
            const logoEl = document.getElementById('header-logo');
            const defaultName = 'üçï Pizzaria Cost Control Pro';

            if (userProfileCache && userProfileCache.companyName) {
                companyNameEl.textContent = userProfileCache.companyName;
                document.title = userProfileCache.companyName + " - Cost Control Pro"; // Atualiza o t√≠tulo da p√°gina
            } else {
                companyNameEl.textContent = defaultName;
                document.title = "Pizzaria Cost Control Pro - Gest√£o Completa";
            }
            
            if (userProfileCache && userProfileCache.logoUrl) {
                logoEl.src = userProfileCache.logoUrl;
                logoEl.classList.remove('hidden');
                companyNameEl.textContent = " " + companyNameEl.textContent;
            } else {
                logoEl.src = "";
                logoEl.classList.add('hidden');
                if(!companyNameEl.textContent.includes('üçï')) companyNameEl.textContent = 'üçï' + companyNameEl.textContent;
            }
        }
        
        async function fetchUserProfile() {
            if (isLocalMode || !currentUser) { userProfileCache = localData.userProfile; applyBranding(); return; }
            try {
                const doc = await db.collection('userProfiles').doc(currentUser.uid).get();
                userProfileCache = doc.exists ? doc.data() : {};
            } catch (error) {
                console.error("Erro ao buscar perfil do usu√°rio:", error);
                userProfileCache = {};
            }
            applyBranding();
        }

        async function loadAllData() { await Promise.all([fetchConfiguracoes(), fetchFornecedores(), fetchInsumos(), fetchReceitas(), fetchCustosMensais()]); renderAllTables(); populateAllDropdowns(); updateDashboard(); }
        async function fetchCollection(collectionName, cacheArray, localKey, orderByField = 'nome', orderDirection = 'asc') {
            if (isLocalMode) { cacheArray.splice(0, cacheArray.length, ...localData[localKey]); return; }
            try {
                const snapshot = await db.collection(collectionName).where('userId', '==', currentUser.uid).orderBy(orderByField, orderDirection).get();
                const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                cacheArray.splice(0, cacheArray.length, ...data);
            } catch (error) { console.error(`Erro ao buscar ${collectionName}:`, error); if (error.code === 'failed-precondition') { showToast(`Erro: √çndice do Firestore ausente para '${collectionName}'. Crie-o no Firebase.`, 'error'); } else { showToast(`Erro ao carregar ${collectionName}: ${error.message}`, 'error'); } }
        }
        async function saveData(collectionName, localKey, data) {
            const isEditing = !!data.id; data.userId = currentUser.uid;
            try { if (isLocalMode) { if (isEditing) { const index = localData[localKey].findIndex(i => i.id === data.id); if (index > -1) localData[localKey][index] = data; } else { data.id = `local_${Date.now()}`; localData[localKey].push(data); } } else { if (isEditing) { await db.collection(collectionName).doc(data.id).update(data); } else { delete data.id; await db.collection(collectionName).add(data); } } showToast(`${collectionName.replace('sMensais', '').slice(0, -1)} ${isEditing ? 'atualizado' : 'salvo'}!`); return true;
            } catch (error) { const errorMsg = error.code === 'permission-denied' ? 'Permiss√£o negada. Verifique suas Regras de Seguran√ßa do Firestore.' : error.message; showToast(`Erro: ${errorMsg}`, 'error'); console.error(`Erro ao salvar em ${collectionName}:`, error); return false; }
        }
        async function deleteData(collectionName, localKey, id) { try { if (isLocalMode) { localData[localKey] = localData[localKey].filter(i => i.id !== id); } else { await db.collection(collectionName).doc(id).delete(); } showToast(`${collectionName.replace('sMensais', '').slice(0, -1)} exclu√≠do!`); return true; } catch (error) { showToast("Erro ao excluir.", 'error'); return false; } }
        async function fetchFornecedores() { await fetchCollection('fornecedores', fornecedoresCache, 'fornecedores'); }
        async function fetchInsumos() { await fetchCollection('insumos', insumosCache, 'insumos'); }
        async function fetchReceitas() { await fetchCollection('receitas', receitasCache, 'receitas'); }
        async function fetchCustosMensais() { await fetchCollection('custosMensais', custosMensaisCache, 'custosMensais', 'mes', 'desc'); }
        async function fetchConfiguracoes() { if (isLocalMode) { configCache = localData.configuracoes.default || { custo_hora_mao_de_obra: 20, rateio_por_pizza: 0.80, meta_cmv_padrao: 30, alerta_variacao: 10 }; } else { try { const doc = await db.collection('configuracoes').doc(currentUser.uid).get(); configCache = doc.exists ? doc.data() : { custo_hora_mao_de_obra: 20, rateio_por_pizza: 0.80, meta_cmv_padrao: 30, alerta_variacao: 10 }; } catch(error) { console.error("Erro configs:", error); } } displayConfiguracoes(); }
        async function saveConfiguracoes(configData) { configData.userId = currentUser.uid; try { if(isLocalMode) { localData.configuracoes.default = configData; } else { await db.collection('configuracoes').doc(currentUser.uid).set(configData, { merge: true }); } showToast("Configura√ß√µes de c√°lculo salvas!"); configCache = configData; displayConfiguracoes(); updateDashboard(); } catch(error) { showToast("Erro ao salvar.", 'error'); } }
        
        // As demais fun√ß√µes JavaScript (renderiza√ß√£o de tabelas, c√°lculos, etc.) permanecem as mesmas
        function renderAllTables() { renderFornecedoresTable(); renderInsumosTable(); renderReceitasTable(); renderCustosMensaisTable(); }
        function populateAllDropdowns() { populateFornecedoresDropdowns(); populateReceitaSelects(); populateIndicadoresMesSelect(); }
        function renderFornecedoresTable() { const tbody = document.getElementById('fornecedores-table').querySelector('tbody'); tbody.innerHTML = ''; if (fornecedoresCache.length === 0) { tbody.innerHTML = '<tr><td colspan="5">Nenhum fornecedor cadastrado.</td></tr>'; return; } fornecedoresCache.forEach(f => { const insumosCount = insumosCache.filter(i => i.fornecedorId === f.id).length; const tr = document.createElement('tr'); tr.innerHTML = `<td>${f.nome}</td><td>${f.contato || '--'}</td><td>${f.telefone || '--'}</td><td>${insumosCount}</td><td class="actions-cell"><button class="btn btn-secondary btn-small btn-edit-fornecedor" data-id="${f.id}">‚úé</button> <button class="btn btn-danger btn-small btn-delete-fornecedor" data-id="${f.id}">üóë</button></td>`; tbody.appendChild(tr); }); }
        function renderInsumosTable(filter = '') { const tbody = document.getElementById('insumos-table').querySelector('tbody'); tbody.innerHTML = ''; const data = insumosCache.filter(i => i.nome.toLowerCase().includes(filter) || (i.fornecedorNome && i.fornecedorNome.toLowerCase().includes(filter))); if (data.length === 0) { tbody.innerHTML = '<tr><td colspan="5">Nenhum insumo encontrado.</td></tr>'; return; } data.forEach(i => { const custo = i.qtd_embalagem_g > 0 ? (i.custo_embalagem / i.qtd_embalagem_g) : i.custo_embalagem; const tr = document.createElement('tr'); tr.innerHTML = `<td>${i.nome}</td><td>${formatCurrency(custo)} / ${i.unidade_base || 'g'}</td><td>${i.fornecedorNome || '--'}</td><td>${i.validade ? new Date(i.validade).toLocaleDateString('pt-BR', {timeZone: 'UTC'}) : '--'}</td><td class="actions-cell"><button class="btn btn-secondary btn-small btn-edit-insumo" data-id="${i.id}">‚úé</button> <button class="btn btn-danger btn-small btn-delete-insumo" data-id="${i.id}">üóë</button></td>`; tbody.appendChild(tr); }); }
        function renderReceitasTable(filter = '') { const tbody = document.getElementById('receitas-table').querySelector('tbody'); tbody.innerHTML = ''; const data = receitasCache.filter(r => r.nome.toLowerCase().includes(filter)); if (data.length === 0) { tbody.innerHTML = '<tr><td colspan="4">Nenhuma receita encontrada.</td></tr>'; return; } data.forEach(r => { const cogs = calculateRecipeCOGS(r); const tr = document.createElement('tr'); tr.innerHTML = `<td>${r.nome}</td><td>${formatCurrency(cogs)}</td><td>${r.versao || '1.0'}</td><td class="actions-cell"><button class="btn btn-info btn-small btn-view-report" data-id="${r.id}">üìÑ</button> <button class="btn btn-secondary btn-small btn-edit-receita" data-id="${r.id}">‚úé</button> <button class="btn btn-danger btn-small btn-delete-receita" data-id="${r.id}">üóë</button></td>`; tbody.appendChild(tr); }); }
        function renderCustosMensaisTable() { const tbody = document.getElementById('custos-mensais-table').querySelector('tbody'); tbody.innerHTML = ''; if (custosMensaisCache.length === 0) { tbody.innerHTML = '<tr><td colspan="4">Nenhum custo mensal lan√ßado.</td></tr>'; return; } custosMensaisCache.forEach(c => { const [year, month] = c.mes.split('-'); const lucro = calculateLucroLiquido(c); const tr = document.createElement('tr'); tr.innerHTML = `<td>${month}/${year}</td><td>${formatCurrency(c.faturamento)}</td><td>${formatCurrency(lucro)}</td><td class="actions-cell"><button class="btn btn-secondary btn-small btn-edit-custo-mensal" data-id="${c.id}">‚úé</button> <button class="btn btn-danger btn-small btn-delete-custo-mensal" data-id="${c.id}">üóë</button></td>`; tbody.appendChild(tr); }); }
        function populateFornecedoresDropdowns() { const select = document.getElementById('insumo-fornecedor-select'); const current = select.value; select.innerHTML = '<option value="">-- Selecione --</option>'; fornecedoresCache.forEach(f => { select.innerHTML += `<option value="${f.id}" data-nome="${f.nome}">${f.nome}</option>`; }); select.value = current; }
        function populateInsumosDropdowns(selectEl) { if(selectEl){ let html = '<option value="">Selecione um insumo</option>'; insumosCache.forEach(i => { const custo = i.qtd_embalagem_g > 0 ? (i.custo_embalagem / i.qtd_embalagem_g) : i.custo_embalagem; const nomeInsumo = i.nome || 'NOME INDEFINIDO'; html += `<option value="${i.id}" data-nome="${nomeInsumo}">${nomeInsumo} (${formatCurrency(custo)}/${i.unidade_base || 'g'})</option>`; }); selectEl.innerHTML = html;} }
        function populateReceitaSelects() { const select = document.getElementById('simulador-receita-select'); const current = select.value; select.innerHTML = '<option value="">-- Escolha --</option>'; receitasCache.forEach(r => { select.innerHTML += `<option value="${r.id}">${r.nome}</option>`; }); select.value = current; }
        function populateIndicadoresMesSelect() { const select = document.getElementById('indicadores-mes-select'); const current = select.value; select.innerHTML = '<option value="">-- Escolha um m√™s --</option>'; custosMensaisCache.forEach(c => { const [year, month] = c.mes.split('-'); select.innerHTML += `<option value="${c.id}">${month}/${year}</option>`; }); select.value = current; updateIndicadores(); }
        function calculateCustoPorGrama(insumo) { if (!insumo || !insumo.custo_embalagem || !insumo.qtd_embalagem_g) return 0; return insumo.custo_embalagem / insumo.qtd_embalagem_g; }
        function calculateCustoIngrediente(insumoId, quantidade_g) { const insumo = insumosCache.find(i => i.id === insumoId); if (!insumo) return 0; return calculateCustoPorGrama(insumo) * quantidade_g; }
        function calculateRecipeIngredientsCost(ingredients = []) { return ingredients.reduce((total, ing) => total + calculateCustoIngrediente(ing.insumoId, ing.quantidade_g), 0); }
        function calculateRecipeCOGS(receita) { if (!receita || !receita.ingredientes) return 0; const custoIngredientes = calculateRecipeIngredientsCost(receita.ingredientes); const custoComPerda = custoIngredientes * (1 + (receita.perda_percentual || 0) / 100); const custoMaoDeObra = ((configCache.custo_hora_mao_de_obra || 0) / 60) * (receita.tempo_preparo_min || 0); return custoComPerda + (receita.custo_embalagem_por_unidade || 0) + custoMaoDeObra + (configCache.rateio_por_pizza || 0); }
        function calculateLucroLiquido(custoMensal) { if (!custoMensal) return 0; return (custoMensal.faturamento || 0) + (custoMensal.outrasReceitasDespesas || 0) - (custoMensal.custosVariaveis || 0) - (custoMensal.custosFixos || 0) - (custoMensal.despesasOperacionais || 0) - (custoMensal.impostos || 0); }
        function setupNavListeners() { navLinks.forEach(link => link.addEventListener('click', e => { e.preventDefault(); showView(e.currentTarget.dataset.view); })); }
        
        function setupFormListeners() {
            document.getElementById('fornecedor-form').addEventListener('submit', async e => { e.preventDefault(); const button = e.currentTarget.querySelector('button[type="submit"]'); button.disabled = true; button.textContent = 'Aguarde...'; const data = { nome: document.getElementById('fornecedor-nome').value, contato: document.getElementById('fornecedor-contato').value, telefone: document.getElementById('fornecedor-telefone').value, email: document.getElementById('fornecedor-email').value, endereco: document.getElementById('fornecedor-endereco').value, id: document.getElementById('fornecedor-id').value || null }; const success = await saveData('fornecedores', 'fornecedores', data); if (success) { await fetchFornecedores(); renderFornecedoresTable(); populateFornecedoresDropdowns(); resetFornecedorForm(); } button.disabled = false; button.textContent = 'Salvar Fornecedor'; });
            document.getElementById('cancel-edit-fornecedor').addEventListener('click', resetFornecedorForm);
            document.getElementById('insumo-form').addEventListener('submit', async e => { e.preventDefault(); const button = e.currentTarget.querySelector('button[type="submit"]'); button.disabled = true; button.textContent = 'Aguarde...'; const fornecedorSelect = document.getElementById('insumo-fornecedor-select'); if (!fornecedorSelect.value) { showToast("Selecione um fornecedor.", "error"); button.disabled = false; button.textContent = 'Salvar Insumo'; return; } const id = document.getElementById('insumo-id').value, custo = parseFloat(document.getElementById('insumo-custo-embalagem').value); const existing = id ? insumosCache.find(i => i.id === id) : null; const historico = existing ? (existing.historico_precos || []) : []; if (existing && custo !== existing.custo_embalagem) { historico.push({ data: new Date().toISOString(), preco: existing.custo_embalagem }); } const qtd = parseFloat(document.getElementById('insumo-qtd-embalagem').value), unidade = document.getElementById('insumo-unidade-embalagem').value; let qtd_g = qtd, base = 'g'; if (unidade === 'kg') qtd_g = qtd * 1000; else if (unidade === 'L') { qtd_g = qtd * 1000; base = 'ml'; } else if (unidade === 'un') base = 'un'; const data = { nome: document.getElementById('insumo-nome').value, fornecedorId: fornecedorSelect.value, fornecedorNome: fornecedorSelect.options[fornecedorSelect.selectedIndex].dataset.nome, custo_embalagem: custo, quantidade_embalagem: qtd, unidade_embalagem: unidade, qtd_embalagem_g: qtd_g, unidade_base: base, lote: document.getElementById('insumo-lote').value, validade: document.getElementById('insumo-validade').value, historico_precos: historico, id: id || null }; const success = await saveData('insumos', 'insumos', data); if (success) { await fetchInsumos(); renderInsumosTable(); resetInsumoForm(); } button.disabled = false; button.textContent = 'Salvar Insumo'; });
            document.getElementById('cancel-edit-insumo').addEventListener('click', resetInsumoForm);
            const ingredientsList = document.getElementById('ingredients-list');
            ingredientsList.addEventListener('keydown', e => { if (e.key === 'Enter' && e.target.classList.contains('ingredient-qty')) { e.preventDefault(); addIngredientRow(); const newRow = ingredientsList.querySelector('.ingredient-row:last-child .ingredient-select'); if(newRow) newRow.focus(); } });
            const receitaForm = document.getElementById('receita-form');
            receitaForm.addEventListener('submit', async e => { e.preventDefault(); const button = receitaForm.querySelector('button[type="submit"]'); button.disabled = true; button.textContent = 'Aguarde...'; try { const ingredients = []; let hasIncompleteRow = false; document.querySelectorAll('#ingredients-list .ingredient-row').forEach(row => { const select = row.querySelector('.ingredient-select'); const insumoId = select.value; const quantidade_g = parseFloat(row.querySelector('.ingredient-qty').value) || 0; if (!insumoId && quantidade_g === 0) return; if (!insumoId || quantidade_g <= 0) { hasIncompleteRow = true; } else { const selectedOption = select.options[select.selectedIndex]; const nome = selectedOption ? selectedOption.dataset.nome : null; if (nome) { ingredients.push({ insumoId, nome, quantidade_g }); } else { hasIncompleteRow = true; } } }); if (hasIncompleteRow) { throw new Error("Verifique se todos os ingredientes t√™m Insumo e Quantidade preenchidos."); } if (ingredients.length === 0) { throw new Error("Adicione ao menos um ingrediente v√°lido √† receita."); } const data = { nome: document.getElementById('receita-nome').value, versao: document.getElementById('receita-versao').value, ingredientes: ingredients, tempo_preparo_min: parseInt(document.getElementById('receita-tempo-preparo').value) || 0, custo_embalagem_por_unidade: parseFloat(document.getElementById('receita-custo-embalagem').value) || 0, perda_percentual: parseFloat(document.getElementById('receita-perda-percentual').value) || 0, observacoes: document.getElementById('receita-observacoes').value, id: document.getElementById('receita-id').value || null }; const success = await saveData('receitas', 'receitas', data); if (success) { await fetchReceitas(); renderReceitasTable(); populateReceitaSelects(); resetReceitaForm(); } } catch (error) { showToast(error.message, 'error'); } finally { button.disabled = false; button.textContent = 'Salvar Receita'; } });
            document.getElementById('add-ingredient-btn').addEventListener('click', () => addIngredientRow());
            ingredientsList.addEventListener('change', e => { if(e.target.matches('.ingredient-select, .ingredient-qty')) updateTotalIngredientsCost(); });
            ingredientsList.addEventListener('click', e => { if(e.target.classList.contains('remove-ingredient-btn')) { e.target.closest('.ingredient-row').remove(); updateTotalIngredientsCost(); } });
            document.getElementById('cancel-edit-receita').addEventListener('click', resetReceitaForm);
            const custoMensalForm = document.getElementById('custo-mensal-form');
            custoMensalForm.addEventListener('submit', async e => { e.preventDefault(); const button = custoMensalForm.querySelector('button[type="submit"]'); button.disabled = true; button.textContent = 'Aguarde...'; const data = { mes: document.getElementById('custo-mensal-mes').value, faturamento: parseFloat(document.getElementById('custo-mensal-faturamento').value) || 0, custosVariaveis: parseFloat(document.getElementById('custo-mensal-custosVariaveis').value) || 0, custosFixos: parseFloat(document.getElementById('custo-mensal-custosFixos').value) || 0, despesasOperacionais: parseFloat(document.getElementById('custo-mensal-despesasOperacionais').value) || 0, outrasReceitasDespesas: parseFloat(document.getElementById('custo-mensal-outrasReceitasDespesas').value) || 0, numeroVendas: parseInt(document.getElementById('custo-mensal-numeroVendas').value) || 0, impostos: parseFloat(document.getElementById('custo-mensal-impostos').value) || 0, id: document.getElementById('custo-mensal-id').value || null }; const success = await saveData('custosMensais', 'custosMensais', data); if (success) { await fetchCustosMensais(); renderCustosMensaisTable(); populateIndicadoresMesSelect(); resetCustoMensalForm(); } button.disabled = false; button.textContent = 'Salvar M√™s'; });
            document.getElementById('cancel-edit-custo-mensal').addEventListener('click', resetCustoMensalForm);
            document.getElementById('configuracoes-form').addEventListener('submit', async e => { e.preventDefault(); const data = { custo_hora_mao_de_obra: parseFloat(document.getElementById('config-custo-hora-mao-de-obra').value), rateio_por_pizza: parseFloat(document.getElementById('config-rateio-despesas-fixas').value), meta_cmv_padrao: parseFloat(document.getElementById('config-meta-cmv-padrao').value), alerta_variacao: parseFloat(document.getElementById('config-alerta-variacao').value) }; await saveConfiguracoes(data); });
            
            // CORRE√á√ÉO DO ERRO DE DIGITA√á√ÉO
            document.getElementById('profile-config-form').addEventListener('submit', async e => {
                e.preventDefault();
                if (!currentUser) return;
                const button = e.currentTarget.querySelector('button');
                button.disabled = true; button.textContent = 'Salvando...';
                try {
                    const companyName = document.getElementById('config-company-name').value;
                    const logoFile = document.getElementById('config-logo').files[0];
                    const updateData = { companyName };

                    if (logoFile) {
                        const storageRef = storage.ref(`logos/${currentUser.uid}/${logoFile.name}`);
                        const snapshot = await storageRef.put(logoFile);
                        updateData.logoUrl = await snapshot.ref.getDownloadURL();
                    }
                    
                    // AQUI ESTAVA O ERRO: db.colletion virou db.collection
                    await db.collection('userProfiles').doc(currentUser.uid).set(updateData, { merge: true });
                    
                    await fetchUserProfile();
                    showToast('Dados da empresa atualizados com sucesso!');
                } catch(err) {
                    showToast('Erro ao atualizar dados: ' + err.message, 'error');
                    console.error(err);
                } finally {
                    button.disabled = false; button.textContent = 'Salvar Dados da Empresa';
                }
            });

            document.getElementById('simulador-receita-select').addEventListener('change', updateSimulator);
            ['simulador-preco-venda', 'simulador-meta-cmv', 'simulador-margem-desejada'].forEach(id => document.getElementById(id).addEventListener('input', updateSimulator));
            document.getElementById('indicadores-mes-select').addEventListener('change', updateIndicadores);
            document.getElementById('insumos-filter').addEventListener('input', e => renderInsumosTable(e.target.value.toLowerCase()));
            document.getElementById('receitas-filter').addEventListener('input', e => renderReceitasTable(e.target.value.toLowerCase()));
            document.body.addEventListener('click', handleTableButtonClick);
        }

        function setupHelpModals() {
            const helpModal = document.getElementById('help-modal'); const helpModalTitle = document.getElementById('help-modal-title'); const helpModalText = document.getElementById('help-modal-text'); const closeModalBtn = document.getElementById('help-modal-close');
            document.body.addEventListener('click', (e) => {
                if (e.target.classList.contains('help-icon')) {
                    const key = e.target.dataset.helpKey; const content = helpTexts[key];
                    if (content) {
                        helpModalTitle.textContent = content.title; let html = `<p>${content.text}</p>`;
                        if (content.formula) { html += `<p><strong>F√≥rmula:</strong> ${content.formula}</p>`; }
                        helpModalText.innerHTML = html; helpModal.style.display = 'block';
                    }
                }
            });
            const closeModal = () => { helpModal.style.display = 'none'; };
            closeModalBtn.addEventListener('click', closeModal); window.addEventListener('click', (e) => { if (e.target === helpModal) { closeModal(); } });
        }
        function handleTableButtonClick(e) { const btn = e.target.closest('button'); if (!btn) return; if(btn.matches('.btn-edit-fornecedor')) editFornecedor(btn.dataset.id); else if (btn.matches('.btn-delete-fornecedor')) confirmDelete('fornecedor', btn.dataset.id); else if(btn.matches('.btn-edit-insumo')) editInsumo(btn.dataset.id); else if (btn.matches('.btn-delete-insumo')) confirmDelete('insumo', btn.dataset.id); else if (btn.matches('.btn-edit-receita')) editReceita(btn.dataset.id); else if (btn.matches('.btn-delete-receita')) confirmDelete('receita', btn.dataset.id); else if(btn.matches('.btn-edit-custo-mensal')) editCustoMensal(btn.dataset.id); else if(btn.matches('.btn-delete-custo-mensal')) confirmDelete('custoMensal', btn.dataset.id); else if (btn.matches('.btn-view-report')) generateRecipePDF(btn.dataset.id); }
        function resetFornecedorForm() { document.getElementById('fornecedor-form').reset(); document.getElementById('fornecedor-id').value = ''; document.getElementById('fornecedor-form-title').textContent = 'Cadastrar Fornecedor'; document.getElementById('cancel-edit-fornecedor').classList.add('hidden'); }
        function editFornecedor(id) { const f = fornecedoresCache.find(i => i.id === id); if (!f) return; showView('fornecedores'); Object.keys(f).forEach(key => { const el = document.getElementById(`fornecedor-${key}`); if (el) el.value = f[key]; }); document.getElementById('fornecedor-id').value = f.id; document.getElementById('fornecedor-form-title').textContent = 'Editar Fornecedor'; document.getElementById('cancel-edit-fornecedor').classList.remove('hidden'); window.scrollTo(0, 0); }
        function resetInsumoForm() { document.getElementById('insumo-form').reset(); document.getElementById('insumo-id').value = ''; document.getElementById('insumo-form-title').textContent = 'Cadastrar Insumo'; document.getElementById('cancel-edit-insumo').classList.add('hidden'); }
        function editInsumo(id) { const i = insumosCache.find(item => item.id === id); if (!i) return; showView('insumos'); document.getElementById('insumo-id').value = i.id; document.getElementById('insumo-nome').value = i.nome; document.getElementById('insumo-fornecedor-select').value = i.fornecedorId; document.getElementById('insumo-custo-embalagem').value = i.custo_embalagem; document.getElementById('insumo-qtd-embalagem').value = i.quantidade_embalagem; document.getElementById('insumo-unidade-embalagem').value = i.unidade_embalagem; document.getElementById('insumo-lote').value = i.lote; document.getElementById('insumo-validade').value = i.validade; document.getElementById('insumo-form-title').textContent = 'Editar Insumo'; document.getElementById('cancel-edit-insumo').classList.remove('hidden'); window.scrollTo(0, 0); }
        function resetReceitaForm() { document.getElementById('receita-form').reset(); document.getElementById('receita-id').value = ''; document.getElementById('ingredients-list').innerHTML = ''; document.getElementById('custo-total-ingredientes').textContent = 'Custo: R$ 0,00'; document.getElementById('receita-form-title').textContent = 'Criar Receita'; document.getElementById('cancel-edit-receita').classList.add('hidden'); addIngredientRow(); }
        async function editReceita(id) { const r = receitasCache.find(i => i.id === id); if (!r) return; showView('receitas'); resetReceitaForm(); document.getElementById('receita-id').value = r.id; document.getElementById('receita-nome').value = r.nome; document.getElementById('receita-versao').value = r.versao; document.getElementById('receita-tempo-preparo').value = r.tempo_preparo_min; document.getElementById('receita-custo-embalagem').value = r.custo_embalagem_por_unidade; document.getElementById('receita-perda-percentual').value = r.perda_percentual; document.getElementById('receita-observacoes').value = r.observacoes; const ingredientsList = document.getElementById('ingredients-list'); ingredientsList.innerHTML = ''; await new Promise(resolve => setTimeout(resolve, 50)); if (r.ingredientes) { r.ingredientes.forEach(ing => addIngredientRow(ing)); } updateTotalIngredientsCost(); document.getElementById('receita-form-title').textContent = 'Editar Receita'; document.getElementById('cancel-edit-receita').classList.remove('hidden'); window.scrollTo(0, 0); }
        function resetCustoMensalForm() { document.getElementById('custo-mensal-form').reset(); document.getElementById('custo-mensal-id').value = ''; document.getElementById('custo-mensal-form-title').textContent = 'Lan√ßar Custos do M√™s'; document.getElementById('cancel-edit-custo-mensal').classList.add('hidden'); }
        function editCustoMensal(id) { const c = custosMensaisCache.find(i => i.id === id); if (!c) return; showView('custos-mensais'); document.getElementById('custo-mensal-id').value = c.id; document.getElementById('custo-mensal-mes').value = c.mes; document.getElementById('custo-mensal-faturamento').value = c.faturamento; document.getElementById('custo-mensal-custosVariaveis').value = c.custosVariaveis; document.getElementById('custo-mensal-custosFixos').value = c.custosFixos; document.getElementById('custo-mensal-despesasOperacionais').value = c.despesasOperacionais; document.getElementById('custo-mensal-outrasReceitasDespesas').value = c.outrasReceitasDespesas; document.getElementById('custo-mensal-numeroVendas').value = c.numeroVendas; document.getElementById('custo-mensal-impostos').value = c.impostos; document.getElementById('custo-mensal-form-title').textContent = 'Editar Custos do M√™s'; document.getElementById('cancel-edit-custo-mensal').classList.remove('hidden'); window.scrollTo(0, 0); }
        function addIngredientRow(ing = {}) { const div = document.createElement('div'); div.className = 'ingredient-row'; const tempSelect = document.createElement('select'); populateInsumosDropdowns(tempSelect); div.innerHTML = ` <div style="flex:3;">${tempSelect.outerHTML}</div> <div style="flex:1;"><input type="number" class="ingredient-qty" placeholder="Qtd (g/un)" value="${ing.quantidade_g || ''}" step="0.1"></div> <div class="costo-ingrediente">R$ 0,00</div> <button type="button" class="btn btn-danger btn-small remove-ingredient-btn">X</button> `; document.getElementById('ingredients-list').appendChild(div); const newSelect = div.querySelector('select'); if (newSelect) { newSelect.className = 'ingredient-select'; newSelect.value = ing.insumoId || ''; } }
        function updateTotalIngredientsCost() { let total = 0; document.querySelectorAll('#ingredients-list .ingredient-row').forEach(row => { const id = row.querySelector('.ingredient-select').value, qty = parseFloat(row.querySelector('.ingredient-qty').value) || 0, cost = calculateCustoIngrediente(id, qty); row.querySelector('.costo-ingrediente').textContent = formatCurrency(cost); total += cost; }); document.getElementById('custo-total-ingredientes').textContent = `Custo: ${formatCurrency(total)}`; }
        function displayConfiguracoes() { Object.keys(configCache).forEach(key => { const el = document.getElementById(`config-${key.replace(/_/g, '-')}`); if (el) el.value = configCache[key]; }); document.getElementById('alert-threshold-display').textContent = configCache.alerta_variacao || 10; document.getElementById('config-company-name').value = userProfileCache.companyName || ''; }
        function updateSimulator() { const id = document.getElementById('simulador-receita-select').value, div = document.getElementById('simulador-detalhes'); if (!id) { div.classList.add('hidden'); return; } div.classList.remove('hidden'); const receita = receitasCache.find(r => r.id === id), cogs = calculateRecipeCOGS(receita); const tbody = document.getElementById('simulador-custos-table').querySelector('tbody'); tbody.innerHTML = `<tr><td>Ingredientes</td><td>${formatCurrency(calculateRecipeIngredientsCost(receita.ingredientes))}</td></tr><tr><td>Perda</td><td>${formatCurrency(calculateRecipeIngredientsCost(receita.ingredientes) * (receita.perda_percentual / 100 || 0))}</td></tr><tr><td>M√£o de Obra</td><td>${formatCurrency((configCache.custo_hora_mao_de_obra / 60 || 0) * (receita.tempo_preparo_min || 0))}</td></tr><tr><td>Embalagem</td><td>${formatCurrency(receita.custo_embalagem_por_unidade)}</td></tr><tr><td>Rateio</td><td>${formatCurrency(configCache.rateio_por_pizza)}</td></tr>`; document.getElementById('simulador-cogs-total').textContent = `COGS Total: ${formatCurrency(cogs)}`; const preco = parseFloat(document.getElementById('simulador-preco-venda').value), cmvDiv = document.getElementById('simulador-resultado-cmv'), visDiv = document.getElementById('cmv-visualizer-container'); if (preco > 0) { const cmv = (cogs / preco) * 100, meta = configCache.meta_cmv_padrao || 30; let status = 'ok', sClass = 'cmv-ok'; if (cmv > meta * 1.1) { status = 'danger'; sClass = 'cmv-danger'; } else if (cmv > meta) { status = 'warn'; sClass = 'cmv-warn'; } cmvDiv.innerHTML = `<p>CMV: <strong class="${sClass}">${cmv.toFixed(2)}%</strong> (Meta: ${meta}%)</p>`; cmvDiv.classList.remove('hidden'); const bar = document.getElementById('cmv-bar'); bar.style.width = `${Math.min(cmv, 100)}%`; bar.className = `cmv-visualizer-bar ${status}`; visDiv.classList.remove('hidden'); } else { cmvDiv.classList.add('hidden'); visDiv.classList.add('hidden'); } const metaCMV = parseFloat(document.getElementById('simulador-meta-cmv').value), margem = parseFloat(document.getElementById('simulador-margem-desejada').value), precoDiv = document.getElementById('simulador-resultado-preco'); let html = ''; if (metaCMV > 0) html += `<p>Pre√ßo (Meta CMV): <strong>${formatCurrency(cogs / (metaCMV / 100))}</strong></p>`; if (margem > 0 && margem < 100) html += `<p>Pre√ßo (Margem ${margem}%): <strong>${formatCurrency(cogs / (1 - (margem / 100)))}</strong></p>`; if (html) { precoDiv.innerHTML = html; precoDiv.classList.remove('hidden'); } else { precoDiv.classList.add('hidden'); } }
        function updateDashboard() { document.getElementById('dashboard-num-fornecedores').textContent = fornecedoresCache.length; document.getElementById('dashboard-num-insumos').textContent = insumosCache.length; document.getElementById('dashboard-num-receitas').textContent = receitasCache.length; document.getElementById('dashboard-cmv-medio').textContent = `${(configCache.meta_cmv_padrao || 30).toFixed(1)}%`; const alertsDiv = document.getElementById('dashboard-alerts'); alertsDiv.innerHTML = ''; let alerts = 0; insumosCache.forEach(i => { if (i.historico_precos?.length) { const latest = i.custo_embalagem, prev = i.historico_precos[i.historico_precos.length-1].preco; if (prev > 0) { const variation = ((latest - prev) / prev) * 100; if (Math.abs(variation) > (configCache.alerta_variacao || 10)) { alerts++; alertsDiv.innerHTML += `<div class="alert-item">${i.nome} variou ${variation.toFixed(1)}%.</div>`; } } } }); if (alerts === 0) alertsDiv.innerHTML = '<p>Nenhuma varia√ß√£o de pre√ßo significativa.</p>'; const topTbody = document.getElementById('dashboard-top-insumos').querySelector('tbody'); topTbody.innerHTML = ''; if (insumosCache.length > 0) { [...insumosCache].sort((a,b) => calculateCustoPorGrama(b) - calculateCustoPorGrama(a)).slice(0, 5).forEach(i => topTbody.innerHTML += `<tr><td>${i.nome}</td><td>${formatCurrency(calculateCustoPorGrama(i))} / ${i.unidade_base || 'g'}</td></tr>`); } else { topTbody.innerHTML = '<tr><td colspan="2">Nenhum insumo.</td></tr>'; } }
        function updateIndicadores() { const id = document.getElementById('indicadores-mes-select').value; const resultsDiv = document.getElementById('indicadores-results'); if (!id) { resultsDiv.classList.add('hidden'); return; } resultsDiv.classList.remove('hidden'); const data = custosMensaisCache.find(c => c.id === id); if (!data) return; const custoTotal = (data.custosVariaveis || 0) + (data.custosFixos || 0) + (data.despesasOperacionais || 0) + (data.impostos || 0); const lucroLiquido = calculateLucroLiquido(data); const margemLiquida = (data.faturamento > 0) ? (lucroLiquido / data.faturamento) * 100 : 0; const markup = (custoTotal > 0) ? ((data.faturamento - custoTotal) / custoTotal) * 100 : 0; document.getElementById('indicador-lucro-liquido').textContent = formatCurrency(lucroLiquido); document.getElementById('indicador-margem-liquida').textContent = `${margemLiquida.toFixed(2)}%`; document.getElementById('indicador-markup').textContent = `${markup.toFixed(2)}%`; }
        function confirmDelete(type, id) { const modal = document.getElementById('confirm-modal'); document.getElementById('confirm-modal-text').textContent = `Tem certeza que deseja excluir este(a) ${type}?`; modal.style.display = 'block'; const yesBtn = document.getElementById('confirm-modal-yes'); const noBtn = document.getElementById('confirm-modal-no'); const handleYes = async () => { if (type === 'fornecedor') await deleteData('fornecedores', 'fornecedores', id); if (type === 'insumo') await deleteData('insumos', 'insumos', id); if (type === 'receita') await deleteData('receitas', 'receitas', id); if (type === 'custoMensal') await deleteData('custosMensais', 'custosMensais', id); await loadAllData(); closeModal(); }; const closeModal = () => { modal.style.display = 'none'; yesBtn.removeEventListener('click', handleYes); noBtn.removeEventListener('click', closeModal); }; yesBtn.addEventListener('click', handleYes, { once: true }); noBtn.addEventListener('click', closeModal, { once: true }); }
        document.getElementById('export-insumos-xlsx').addEventListener('click', () => { const data = insumosCache.map(i => ({ Nome: i.nome, Fornecedor: i.fornecedorNome, 'Custo Emb.': i.custo_embalagem, 'Qtd Emb.': i.quantidade_embalagem, Unidade: i.unidade_embalagem, 'Custo/g': calculateCustoPorGrama(i) })); const ws = XLSX.utils.json_to_sheet(data); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Insumos"); XLSX.writeFile(wb, "insumos.xlsx"); });
        document.getElementById('export-receitas-xlsx').addEventListener('click', () => { const wb = XLSX.utils.book_new(); receitasCache.forEach(r => { const cogs = calculateRecipeCOGS(r); const data = [ { Item: 'Nome', Valor: r.nome }, { Item: 'COGS', Valor: cogs }, {}, { Item: 'Ingrediente', Qtd: 'Custo'} ]; if (r.ingredientes) { r.ingredientes.forEach(ing => { data.push({ Item: ing.nome, Qtd: ing.quantidade_g, Custo: calculateCustoIngrediente(ing.insumoId, ing.quantidade_g) }); }); } const ws = XLSX.utils.json_to_sheet(data, {skipHeader: true}); XLSX.utils.book_append_sheet(wb, ws, r.nome.substring(0, 30)); }); XLSX.writeFile(wb, "fichas_tecnicas.xlsx"); });
        document.getElementById('list-ingredients-pdf').addEventListener('click', () => { const { jsPDF } = window.jspdf; const doc = new jsPDF(); doc.setFontSize(18); doc.text('Lista de Ingredientes por Receita', 14, 22); doc.setFontSize(11); let finalY = 30; receitasCache.forEach(r => { if (finalY > 260) { doc.addPage(); finalY = 20; } doc.setFont('helvetica', 'bold'); doc.text(`${r.nome}`, 14, finalY); finalY += 7; doc.setFont('helvetica', 'normal'); if (r.ingredientes) { r.ingredientes.forEach(ing => { doc.text(`- ${ing.nome}: ${ing.quantidade_g} g`, 18, finalY); finalY += 7; }); } finalY += 5; }); doc.save('Lista_Ingredientes.pdf'); });
        function generateRecipePDF(id) { const { jsPDF } = window.jspdf; const doc = new jsPDF(); const r = receitasCache.find(i => i.id === id); if (!r) return; const cogs = calculateRecipeCOGS(r); doc.setFontSize(18); doc.text(`Ficha T√©cnica - ${r.nome}`, 14, 22); doc.setFontSize(11); doc.text(`Vers√£o: ${r.versao || '1.0'}`, 14, 30); const head = [['Ingrediente', 'Qtd (g/un)', 'Custo Unit.', 'Custo Total']]; const body = r.ingredientes ? r.ingredientes.map(ing => { const ins = insumosCache.find(i => i.id === ing.insumoId); const cUnit = calculateCustoPorGrama(ins); return [ ing.nome, ing.quantidade_g, formatCurrency(cUnit), formatCurrency(cUnit * ing.quantidade_g) ]; }) : []; doc.autoTable({ startY: 40, head, body }); doc.autoTable({ startY: doc.lastAutoTable.finalY + 10, head: [['Item de Custo', 'Valor']], body: [ ['Ingredientes', formatCurrency(calculateRecipeIngredientsCost(r.ingredientes))], ['M√£o de Obra', formatCurrency(((configCache.custo_hora_mao_de_obra || 0) / 60) * (r.tempo_preparo_min || 0))], ['Embalagem', formatCurrency(r.custo_embalagem_por_unidade)], ['Rateio', formatCurrency(configCache.rateio_por_pizza)] ], theme: 'grid' }); doc.setFontSize(14); doc.setFont('helvetica', 'bold'); doc.text(`CUSTO TOTAL (COGS): ${formatCurrency(cogs)}`, 14, doc.lastAutoTable.finalY + 10); doc.save(`Ficha_${r.nome}.pdf`); }
        document.getElementById('generate-general-report-pdf').addEventListener('click', () => { const { jsPDF } = window.jspdf; const doc = new jsPDF(); doc.setFontSize(20); doc.text('Relat√≥rio Geral', 14, 22); doc.setFontSize(12); doc.text(`Data: ${new Date().toLocaleDateString('pt-BR')}`, 14, 30); doc.autoTable({ startY: 40, head: [['KPI', 'Valor']], body: [ ['Fornecedores', fornecedoresCache.length], ['Insumos', insumosCache.length], ['Receitas', receitasCache.length], ['Meta CMV', `${configCache.meta_cmv_padrao || 30}%`], ], }); doc.addPage(); doc.setFontSize(16); doc.text('Top 10 Receitas por Custo', 14, 22); const topR = [...receitasCache].sort((a,b) => calculateRecipeCOGS(b) - calculateRecipeCOGS(a)).slice(0,10); doc.autoTable({ startY: 30, head: [['Receita', 'Custo (COGS)']], body: topR.map(r => [r.nome, formatCurrency(calculateRecipeCOGS(r))]), }); doc.save('Relatorio_Geral.pdf'); });
        document.getElementById('run-validation-button').addEventListener('click', () => { const div = document.getElementById('validation-results'); div.classList.remove('hidden'); div.innerHTML = 'Executando...'; const conf = { custo_hora_mao_de_obra: 20, rateio_por_pizza: 0.80 }; const ins = [{id:'f',c:80,q:25000},{id:'m',c:12,q:3000},{id:'q',c:28,q:1000},{id:'a',c:30,q:1000},{id:'o',c:0.1,q:1}]; const rec = {ings:[{i:'f',q:300},{i:'m',q:120},{i:'q',q:150},{i:'a',q:10},{i:'o',q:1}],t:8,e:1.5,p:0}; const cogsCalc = (c, i, r) => (r.ingredientes.reduce((t,ing) => t + ((i.find(x=>x.id===ing.insumoId).c/i.find(x=>x.id===ing.insumoId).q)*ing.quantidade_g),0)) * (1 + (r.perda_percentual || 0) / 100) + ((c.custo_hora_mao_de_obra/60||0)*(r.tempo_preparo_min||0)) + (r.custo_embalagem_por_unidade||0) + (c.rateio_por_pizza||0); const cogs = cogsCalc(conf, ins.map(x=>({id:x.id,c:x.c,q:x.q})), {ingredientes:rec.ings.map(y=>({insumoId:y.i,quantidade_g:y.q})),tempo_preparo_min:rec.t,custo_embalagem_por_unidade:rec.e,perda_percentual:rec.p}); const preco = cogs/0.3; const cogsOk = Math.abs(cogs - 11.01)<0.01; const precoOk = Math.abs(preco - 36.70)<0.01; div.innerHTML = `<h4>Resultados</h4><p>COGS: <strong>${formatCurrency(cogs)}</strong> (Esp: R$ 11,01) -> <span style="color:${cogsOk?'green':'red'}">${cogsOk?'OK':'ERRO'}</span></p><p>Pre√ßo (CMV 30%): <strong>${formatCurrency(preco)}</strong> (Esp: R$ 36,70) -> <span style="color:${precoOk?'green':'red'}">${precoOk?'OK':'ERRO'}</span></p>`; });
        
        if(isLocalMode) { 
            currentUser = { uid: 'local' }; 
            initApp(); 
        }
    });
    </script>
</body>
</html>